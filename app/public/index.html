<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amtecco Mission Control</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* ‚ïê‚ïê‚ïê Amtecco Brand Guide ‚ïê‚ïê‚ïê */
  :root {
    --bg: #0F1117;
    --surface: #1A1D2E;
    --surface-elevated: #252A40;
    --border: #2D3148;
    --text-primary: #E2E8F0;
    --text-secondary: #94A3B8;
    --text-muted: #64748B;
    --accent: #3B82F6;
    --accent-hover: #2563EB;
    --green: #22C55E;
    --amber: #EAB308;
    --red: #EF4444;
    --purple: #8B5CF6;
    --sidebar: #12141F;
  }
  * { box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-primary); font-size: 14px; line-height: 1.6; }
  code, .mono { font-family: 'JetBrains Mono', monospace; }

  /* Cards ‚Äî Brand spec: 12px radius, 1px border */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; transition: border-color 0.2s ease; }
  .card:hover { border-color: color-mix(in srgb, var(--border) 50%, var(--accent)); }
  .card-header { border-bottom: 1px solid var(--border); }

  /* Severity markers */
  .severity-red { border-left: 4px solid var(--red); }
  .severity-yellow { border-left: 4px solid var(--amber); }
  .severity-blue { border-left: 4px solid var(--accent); }

  /* Status dot */
  .status-icon { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  /* Navigation ‚Äî Brand spec */
  .nav-item { transition: all 0.15s ease; display: block; padding: 10px 20px; font-size: 14px; color: var(--text-secondary); text-decoration: none; }
  .nav-item:hover { background: var(--surface-elevated); color: var(--text-primary); }
  .nav-item.active { background: #1E3A5F; border-left: 3px solid var(--accent); color: white; font-weight: 500; }

  /* Tabs/Buttons ‚Äî Brand spec */
  .tab-active { background: var(--accent); color: white; font-weight: 500; }
  .tab-inactive { background: #1E2235; color: var(--text-secondary); border: 1px solid var(--border); }
  .tab-inactive:hover { background: var(--surface-elevated); }
  .btn-primary { background: var(--accent); color: white; border-radius: 8px; padding: 8px 16px; font-weight: 500; font-size: 14px; transition: all 0.15s; border: none; cursor: pointer; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-secondary { background: #1E2235; color: var(--text-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; font-weight: 500; font-size: 14px; transition: all 0.15s; cursor: pointer; }
  .btn-secondary:hover { background: var(--surface-elevated); }
  .btn-danger { background: var(--red); color: white; border-radius: 8px; padding: 8px 16px; font-weight: 500; }
  .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px 16px; transition: all 0.15s; cursor: pointer; border: none; }
  .btn-ghost:hover { background: var(--surface-elevated); }

  /* Tables ‚Äî Brand spec */
  thead th { color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover { background: var(--surface-elevated); }
  th, td { padding: 10px 12px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Kanban */
  .kanban-col { min-height: 200px; }
  .kanban-card { background: #1E2235; border: 1px solid var(--border); border-radius: 8px; padding: 12px; cursor: grab; transition: all 0.15s ease; }
  .kanban-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .kanban-card.sortable-ghost { opacity: 0.4; }
  .kanban-card.sortable-drag { box-shadow: 0 8px 24px rgba(59,130,246,0.3); }
  .dept-ri { border-left: 3px solid var(--purple); }
  .dept-mc { border-left: 3px solid #06b6d4; }
  .dept-sb { border-left: 3px solid var(--green); }
  .dept-ep { border-left: 3px solid var(--accent); }
  .dept-dk { border-left: 3px solid #f59e0b; }
  .dept-ops { border-left: 3px solid var(--text-muted); }
  .dept-db { border-left: 3px solid #ec4899; }
  .priority-critical { background: #3b1111; }

  /* Modal */
  .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
  .modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }

  /* Alert bars */
  .alert-red { border-color: var(--red); background: #1a1111; }
  .alert-yellow { border-color: var(--amber); background: #1a1a11; }
  .alert-green { border-color: var(--green); background: #111a11; }

  /* Vendor status badges */
  .vendor-status-badge { display: inline-block; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500; }
  .vendor-status-active { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .vendor-status-trial { background-color: rgba(234, 179, 8, 0.2); color: #eab308; }
  .vendor-status-pending-approval { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
  .vendor-status-suspended { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .vendor-status-cancelled { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }

  /* Department badges with color coding */
  .dept-badge { display: inline-block; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500; }
  .dept-engineering { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
  .dept-marketing { background-color: rgba(6, 182, 212, 0.2); color: #06b6d4; }
  .dept-sales { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
  .dept-operations { background-color: rgba(148, 163, 184, 0.2); color: #94a3b8; }
  .dept-research { background-color: rgba(139, 92, 246, 0.2); color: #c084fc; }
  .dept-design { background-color: rgba(236, 72, 153, 0.2); color: #f472b6; }
  .dept-default { background-color: rgba(100, 116, 139, 0.2); color: #64748b; }

  /* Gantt */
  .gantt-container { overflow-x: auto; position: relative; }
  .gantt-row { display: flex; align-items: center; min-height: 36px; border-bottom: 1px solid var(--border); }
  .gantt-label { width: 220px; min-width: 220px; padding: 6px 12px; font-size: 12px; border-right: 1px solid var(--border); }
  .gantt-bars { position: relative; flex: 1; height: 36px; }
  .gantt-bar { position: absolute; height: 22px; top: 7px; border-radius: 4px; font-size: 10px; display: flex; align-items: center; padding: 0 6px; white-space: nowrap; overflow: hidden; cursor: pointer; transition: opacity 0.15s; min-width: 4px; }
  .gantt-bar:hover { opacity: 0.85; filter: brightness(1.2); }
  .gantt-milestone { position: absolute; top: 10px; width: 16px; height: 16px; transform: rotate(45deg); border: 2px solid #f59e0b; background: var(--surface); cursor: pointer; z-index: 2; }
  .gantt-milestone.completed { background: var(--green); border-color: var(--green); }
  .gantt-header-cell { font-size: 10px; text-align: center; color: var(--text-muted); border-right: 1px solid #1e2235; padding: 4px 0; }
  .gantt-swimlane-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); padding: 8px 12px; background: var(--sidebar); border-bottom: 1px solid var(--border); }

  /* Funnel visualization */
  .funnel-stage { transition: all 0.3s ease; }
  .funnel-stage:hover { transform: translateY(-2px); }
  .funnel-bar { border-radius: 6px; transition: all 0.3s ease; }

  /* Pipeline board */
  .pipeline-col { min-width: 220px; }
  .deal-card { background: #1E2235; border: 1px solid var(--border); border-radius: 8px; padding: 12px; transition: all 0.15s; cursor: pointer; }
  .deal-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

  /* Report viewer */
  .report-content { white-space: pre-wrap; font-family: 'Inter', sans-serif; line-height: 1.6; max-height: 60vh; overflow-y: auto; }

  /* Forms */
  .form-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 14px; color: var(--text-primary); font-family: inherit; transition: border-color 0.15s; }
  .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
  .form-label { font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px; font-weight: 500; }

  /* ‚ïê‚ïê‚ïê Mobile Responsive ‚ïê‚ïê‚ïê */
  .mobile-menu-btn { display: none; position: fixed; top: 12px; left: 12px; z-index: 30; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; cursor: pointer; font-size: 16px; }
  
  @media (max-width: 1024px) {
    .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
    .lg\:grid-cols-2 { grid-template-columns: 1fr !important; }
    .lg\:grid-cols-3 { grid-template-columns: repeat(2, 1fr) !important; }
  }
  @media (max-width: 768px) {
    aside { display: none; position: fixed; top: 0; left: 0; bottom: 0; width: 260px; }
    aside.mobile-open { display: flex !important; z-index: 25; }
    main { margin-left: 0 !important; padding: 16px !important; padding-top: 52px !important; }
    .mobile-menu-btn { display: block !important; }
    .grid-cols-4, .grid-cols-2 { grid-template-columns: 1fr !important; }
    .md\:grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
    .gantt-label { width: 120px !important; min-width: 120px !important; font-size: 10px !important; }
    .pipeline-scroll { flex-direction: column; }
    .pipeline-col { min-width: 100% !important; }
    h2 { font-size: 1.25rem !important; }
    .flex-header { flex-direction: column; gap: 12px; }
    .flex-header > div { width: 100%; }
  }
  @media (max-width: 480px) {
    .md\:grid-cols-4 { grid-template-columns: 1fr !important; }
    .card { padding: 12px; }
  }
</style>
</head>
<body class="min-h-screen">

<button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-60 bg-[#12141f] border-r border-[#2d3148] flex flex-col shrink-0 fixed h-full z-20">
    <div class="p-5 border-b border-[#2d3148]">
      <h1 class="text-lg font-bold text-white flex items-center gap-2">üéØ Mission Control</h1>
      <p class="text-xs text-[#64748b] mt-1">Amtecco Operations v2</p>
    </div>
    <nav class="flex-1 py-2 overflow-y-auto" id="nav">
      <a href="/dashboard" class="nav-item active" data-section="command">‚ö° Command Center</a>
      <a href="/kanban" class="nav-item" data-section="kanban">üìã Kanban Board</a>
      <a href="/timeline" class="nav-item" data-section="gantt">üìä Timeline</a>
      <a href="/crm" class="nav-item" data-section="pipeline">üîÑ CRM Pipeline</a>
      <a href="/funnel" class="nav-item" data-section="funnel">üí∞ Revenue Funnel</a>
      <a href="/departments" class="nav-item" data-section="departments">üè¢ Departments</a>
      <a href="/kpis" class="nav-item" data-section="kpis">üìà KPIs</a>
      <a href="/actions" class="nav-item" data-section="actions">üìù Action Items</a>
      <a href="/calendar" class="nav-item" data-section="calendar">üì± Social Calendar</a>
      <a href="/visual-requests" class="nav-item" data-section="visual-requests">üé® Visual Requests</a>
      <a href="/research-requests" class="nav-item" data-section="research-requests">üî¨ Research Requests</a>
      <a href="/blockers" class="nav-item" data-section="blockers">‚ö†Ô∏è Blockers</a>
      <a href="/reports" class="nav-item" data-section="reports">üìÇ Reports</a>
      <a href="/priorities" class="nav-item" data-section="priorities">üî• Priorities</a>
      <a href="/initiatives" class="nav-item" data-section="initiatives">üéØ Initiatives</a>
      <a href="/reporting" class="nav-item" data-section="reporting">üìÖ Reporting</a>
      <a href="/vendors" class="nav-item" data-section="vendors">üí≥ Vendors</a>
      <a href="/revenue" class="nav-item" data-section="revenue">üíπ Revenue Data</a>
      <a href="/org" class="nav-item" data-section="org">üèõ Organization</a>
      <a href="/sync" class="nav-item" data-section="sync">üîÑ Sync Status</a>
    </nav>
    <div class="p-4 border-t border-[#2d3148] text-xs text-[#64748b]">
      <div id="update-time">Loading...</div>
      <div class="mt-1" id="ws-status"><span class="status-icon bg-slate-500 inline-block mr-1"></span> Connecting...</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 ml-60 overflow-y-auto p-6" id="main">

    <!-- ‚ïê‚ïê‚ïê Command Center ‚ïê‚ïê‚ïê -->
    <section id="sec-command">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold" style="line-height:1.2">Command Center</h2>
        <div class="flex gap-2 items-center">
          <span class="text-xs text-[#64748b]" id="cmd-time"></span>
          <button onclick="exportSummary()" class="btn-secondary text-xs px-3 py-1.5">üì• Export PDF</button>
        </div>
      </div>
      <div id="alert-bar" class="mb-6"></div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="stat-cards"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card">
          <div class="card-header px-5 py-3 font-semibold text-sm">üìÖ Today's Agenda</div>
          <div class="p-4" id="today-agenda"><p class="text-sm text-[#64748b]">Loading...</p></div>
        </div>
        <div class="card">
          <div class="card-header px-5 py-3 font-semibold text-sm">üïê Recent Activity</div>
          <div class="p-4" id="recent-activity"><p class="text-sm text-[#64748b]">Loading...</p></div>
        </div>
      </div>
      <!-- Pipeline summary card -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card">
          <div class="card-header px-5 py-3 font-semibold text-sm">üîÑ Pipeline Overview</div>
          <div class="p-4" id="cmd-pipeline-summary"></div>
        </div>
        <div class="card">
          <div class="card-header px-5 py-3 font-semibold text-sm">üìä Pipeline Value</div>
          <div class="p-4"><canvas id="cmd-pipeline-chart" height="180"></canvas></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header px-5 py-3 font-semibold text-sm">üè¢ Department Status</div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead><tr class="border-b border-[#2d3148]">
              <th class="text-left px-5 py-3">Department</th>
              <th class="text-left px-3 py-3">VP</th>
              <th class="text-left px-3 py-3">Status</th>
              <th class="text-left px-3 py-3">Agents</th>
              <th class="text-left px-3 py-3">Health</th>
              <th class="text-left px-3 py-3">Last Update</th>
            </tr></thead>
            <tbody id="org-table"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Kanban Board ‚ïê‚ïê‚ïê -->
    <section id="sec-kanban" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold">Kanban Board</h2>
        <div class="flex gap-2 flex-wrap">
          <select id="kanban-filter-dept" class="form-input text-xs" style="width:auto;padding:6px 12px;">
            <option value="">All Departments</option>
            <option value="Research & Intelligence">Research & Intelligence</option>
            <option value="Marketing & Content">Marketing & Content</option>
            <option value="Sales & Business Dev">Sales & Business Dev</option>
            <option value="Engineering & Product">Engineering & Product</option>
            <option value="Operations">Operations</option>
            <option value="Design & Brand">Design & Brand</option>
          </select>
          <select id="kanban-filter-priority" class="form-input text-xs" style="width:auto;padding:6px 12px;">
            <option value="">All Priorities</option>
            <option value="critical">üî¥ Critical</option>
            <option value="high">üü† High</option>
            <option value="medium">üü° Medium</option>
            <option value="low">üü¢ Low</option>
          </select>
          <button onclick="openTaskModal()" class="btn-primary text-xs px-4 py-1.5">+ New Task</button>
        </div>
      </div>
      <div class="grid grid-cols-4 gap-4">
        <div><div class="flex items-center gap-2 mb-3"><span class="w-3 h-3 rounded-full bg-slate-500"></span><span class="text-sm font-semibold">Backlog</span><span class="text-xs text-[#64748b]" id="count-backlog">0</span></div><div class="kanban-col space-y-2" id="col-backlog" data-status="backlog"></div></div>
        <div><div class="flex items-center gap-2 mb-3"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-sm font-semibold">In Progress</span><span class="text-xs text-[#64748b]" id="count-in_progress">0</span></div><div class="kanban-col space-y-2" id="col-in_progress" data-status="in_progress"></div></div>
        <div><div class="flex items-center gap-2 mb-3"><span class="w-3 h-3 rounded-full bg-yellow-500"></span><span class="text-sm font-semibold">Review</span><span class="text-xs text-[#64748b]" id="count-review">0</span></div><div class="kanban-col space-y-2" id="col-review" data-status="review"></div></div>
        <div><div class="flex items-center gap-2 mb-3"><span class="w-3 h-3 rounded-full bg-green-500"></span><span class="text-sm font-semibold">Done</span><span class="text-xs text-[#64748b]" id="count-done">0</span></div><div class="kanban-col space-y-2" id="col-done" data-status="done"></div></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Gantt / Timeline ‚ïê‚ïê‚ïê -->
    <section id="sec-gantt" class="hidden">
      <style>
        .tl-summary { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:16px; }
        .tl-summary .card { padding:14px 18px; }
        .tl-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .tl-zoom-btn { padding:6px 14px; font-size:12px; border-radius:8px; cursor:pointer; border:1px solid var(--border); background:var(--surface); color:var(--text-secondary); transition:all 0.15s; }
        .tl-zoom-btn:hover { background:var(--surface-elevated); }
        .tl-zoom-btn.active { background:var(--accent); color:white; border-color:var(--accent); }
        .tl-search { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:6px 12px; color:var(--text-primary); font-size:12px; width:200px; }
        .tl-search:focus { outline:none; border-color:var(--accent); }
        .tl-gantt-wrap { position:relative; overflow:hidden; border-radius:12px; border:1px solid var(--border); background:var(--surface); }
        .tl-gantt-scroll { overflow-x:auto; overflow-y:auto; max-height:calc(100vh - 340px); position:relative; }
        .tl-gantt-scroll::-webkit-scrollbar { height:8px; width:8px; }
        .tl-header-row { display:flex; position:sticky; top:0; z-index:10; background:var(--sidebar); border-bottom:2px solid var(--border); }
        .tl-header-cell { font-size:10px; text-align:center; color:var(--text-muted); border-right:1px solid #1e2235; padding:6px 0; flex-shrink:0; }
        .tl-body { position:relative; }
        .tl-row { display:flex; align-items:center; min-height:40px; border-bottom:1px solid var(--border); transition:background 0.1s; }
        .tl-row:hover { background:var(--surface-elevated); }
        .tl-label { width:240px; min-width:240px; padding:6px 12px; font-size:12px; border-right:1px solid var(--border); position:sticky; left:0; z-index:5; background:var(--surface); }
        .tl-row:hover .tl-label { background:var(--surface-elevated); }
        .tl-bars { position:relative; flex:1; height:40px; }
        .tl-bar { position:absolute; height:26px; top:7px; border-radius:6px; font-size:10px; display:flex; align-items:center; padding:0 8px; white-space:nowrap; overflow:hidden; cursor:pointer; transition:all 0.15s; min-width:8px; z-index:2; user-select:none; }
        .tl-bar:hover { filter:brightness(1.2); transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.4); z-index:10; }
        .tl-bar.status-in_progress { background-image:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(255,255,255,0.08) 4px,rgba(255,255,255,0.08) 8px); }
        .tl-bar.status-done { opacity:0.85; }
        .tl-bar.status-backlog { background:transparent !important; border:2px dashed; box-sizing:border-box; }
        .tl-bar.overdue { box-shadow:0 0 0 2px var(--red); }
        .tl-bar .tl-progress { position:absolute; left:0; top:0; bottom:0; border-radius:6px; opacity:0.3; background:white; transition:width 0.3s; }
        .tl-bar .tl-bar-text { position:relative; z-index:1; }
        .tl-milestone { position:absolute; top:10px; width:18px; height:18px; transform:rotate(45deg); border:2px solid #f59e0b; background:var(--surface); cursor:pointer; z-index:3; transition:all 0.15s; }
        .tl-milestone:hover { transform:rotate(45deg) scale(1.2); box-shadow:0 0 12px rgba(245,158,11,0.5); }
        .tl-milestone.completed { background:#22c55e; border-color:#22c55e; }
        .tl-dep-line { position:absolute; pointer-events:auto; cursor:pointer; z-index:1; }
        .tl-dep-line:hover { filter:brightness(1.5); }
        .tl-today-line { position:absolute; top:0; bottom:0; width:2px; background:var(--red); z-index:6; pointer-events:none; }
        .tl-today-label { position:absolute; top:-18px; font-size:9px; color:var(--red); font-weight:700; transform:translateX(-50%); white-space:nowrap; }
        .tl-swimlane { font-size:11px; font-weight:600; color:var(--text-secondary); padding:10px 12px; background:var(--sidebar); border-bottom:1px solid var(--border); cursor:pointer; user-select:none; display:flex; align-items:center; gap:8px; }
        .tl-swimlane:hover { background:var(--surface-elevated); }
        .tl-swimlane .tl-collapse { transition:transform 0.2s; }
        .tl-swimlane .tl-collapse.collapsed { transform:rotate(-90deg); }
        .tl-tooltip { position:fixed; z-index:200; background:var(--surface-elevated); border:1px solid var(--border); border-radius:10px; padding:12px 16px; font-size:12px; max-width:300px; box-shadow:0 8px 24px rgba(0,0,0,0.5); pointer-events:none; }
        .tl-legend { display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; }
        .tl-legend-item { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-muted); }
        /* Task Detail Modal */
        .tl-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:100; display:flex; align-items:center; justify-content:center; }
        .tl-modal { background:var(--surface); border:1px solid var(--border); border-radius:12px; width:100%; max-width:700px; max-height:90vh; overflow-y:auto; }
        .tl-modal-header { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .tl-modal-body { padding:24px; }
        .tl-modal-footer { padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }
        .tl-progress-slider { -webkit-appearance:none; width:100%; height:6px; border-radius:3px; background:var(--bg); outline:none; }
        .tl-progress-slider::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); cursor:pointer; }
        @media(max-width:768px) { .tl-summary { grid-template-columns:repeat(2,1fr); } .tl-label { width:120px !important; min-width:120px !important; font-size:10px !important; } }
      </style>

      <!-- Summary Row -->
      <div class="tl-summary" id="tl-summary"></div>

      <!-- Header & Toolbar -->
      <div class="flex justify-between items-start mb-4 flex-header">
        <h2 class="text-2xl font-bold">üìä Timeline</h2>
        <div class="tl-toolbar">
          <input type="text" id="tl-search" class="tl-search" placeholder="üîç Search tasks..." oninput="renderGantt()">
          <select id="tl-group-by" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="renderGantt()">
            <option value="department">Group: Department</option>
            <option value="assignee">Group: Assignee</option>
            <option value="status">Group: Status</option>
            <option value="priority">Group: Priority</option>
          </select>
          <select id="gantt-filter-dept" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="renderGantt()">
            <option value="">All Departments</option>
            <option value="Research & Intelligence">Research & Intelligence</option>
            <option value="Marketing & Content">Marketing & Content</option>
            <option value="Sales & Business Dev">Sales & Business Dev</option>
            <option value="Engineering & Product">Engineering & Product</option>
            <option value="Operations">Operations</option>
            <option value="Design & Brand">Design & Brand</option>
          </select>
          <select id="tl-filter-status" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="renderGantt()">
            <option value="">All Statuses</option>
            <option value="backlog">Not Started</option>
            <option value="in_progress">In Progress</option>
            <option value="review">Review</option>
            <option value="done">Complete</option>
            <option value="overdue">Overdue</option>
          </select>
          <select id="tl-filter-assignee" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="renderGantt()">
            <option value="">All Assignees</option>
          </select>
        </div>
      </div>
      <div class="flex justify-between items-center mb-3">
        <div class="flex gap-1" id="tl-zoom-btns">
          <button class="tl-zoom-btn" data-zoom="day" onclick="setTlZoom('day')">Day</button>
          <button class="tl-zoom-btn active" data-zoom="week" onclick="setTlZoom('week')">Week</button>
          <button class="tl-zoom-btn" data-zoom="month" onclick="setTlZoom('month')">Month</button>
          <button class="tl-zoom-btn" data-zoom="quarter" onclick="setTlZoom('quarter')">Quarter</button>
        </div>
        <div class="flex gap-2 items-center">
          <input type="date" id="tl-date-from" class="form-input text-xs" style="width:auto;padding:4px 8px;" onchange="renderGantt()">
          <span class="text-xs text-[#64748b]">to</span>
          <input type="date" id="tl-date-to" class="form-input text-xs" style="width:auto;padding:4px 8px;" onchange="renderGantt()">
          <button onclick="tlJumpToday()" class="btn-secondary text-xs px-3 py-1.5">üìç Today</button>
        </div>
      </div>

      <!-- Gantt Chart -->
      <div class="tl-gantt-wrap">
        <div class="tl-gantt-scroll" id="tl-gantt-scroll">
          <div id="gantt-chart" style="position:relative;"></div>
        </div>
      </div>

      <!-- Legend -->
      <div class="tl-legend" id="tl-legend">
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#3b82f6;display:inline-block;"></span> Engineering</span>
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#8b5cf6;display:inline-block;"></span> Research & Intel</span>
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#f97316;display:inline-block;"></span> Marketing</span>
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#22c55e;display:inline-block;"></span> Sales & BD</span>
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#ec4899;display:inline-block;"></span> Design & Brand</span>
        <span class="tl-legend-item"><span style="width:12px;height:12px;border-radius:3px;background:#64748b;display:inline-block;"></span> Operations</span>
        <span class="tl-legend-item"><span style="display:inline-block;width:14px;height:4px;background:repeating-linear-gradient(45deg,#fff 0 2px,transparent 2px 4px);border-radius:2px;"></span> In Progress</span>
        <span class="tl-legend-item"><span style="display:inline-block;width:14px;height:14px;border:2px dashed #94a3b8;border-radius:3px;"></span> Not Started</span>
        <span class="tl-legend-item"><span style="display:inline-block;width:14px;height:14px;border:2px solid #ef4444;border-radius:3px;"></span> Overdue</span>
        <span class="tl-legend-item"><span style="display:inline-block;width:12px;height:12px;transform:rotate(45deg);border:2px solid #f59e0b;"></span> Milestone</span>
        <span class="tl-legend-item"><span style="display:inline-block;width:16px;height:2px;background:#ef4444;"></span> Today</span>
      </div>

      <!-- Keyboard shortcuts hint -->
      <div class="text-xs text-[#64748b] mt-2">‚å® Arrow keys: scroll ¬∑ +/‚àí: zoom ¬∑ T: jump to today</div>
    </section>

    <!-- Timeline Task Detail Modal -->
    <div id="tl-task-modal" class="hidden">
      <div class="tl-modal-overlay" onclick="closeTlTaskModal(event)">
        <div class="tl-modal" onclick="event.stopPropagation()">
          <div class="tl-modal-header">
            <h3 class="text-lg font-bold" id="tl-modal-title">Task Details</h3>
            <button onclick="closeTlTaskModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
          </div>
          <div class="tl-modal-body" id="tl-modal-body"></div>
          <div class="tl-modal-footer" id="tl-modal-footer"></div>
        </div>
      </div>
    </div>

    <!-- Tooltip container -->
    <div id="tl-tooltip" class="tl-tooltip hidden" style="display:none;"></div>

    <!-- ‚ïê‚ïê‚ïê CRM Pipeline ‚ïê‚ïê‚ïê -->
    <section id="sec-pipeline" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <div>
          <h2 class="text-2xl font-bold">CRM Pipeline</h2>
          <p class="text-sm text-[#94a3b8] mt-1">Twenty CRM Integration ¬∑ crm.amtc.tv</p>
        </div>
        <div class="flex gap-2 items-center">
          <select id="crm-stage-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="updateCrmURL();loadPipeline()">
            <option value="">All Stages</option>
            <option value="lead">Leads</option>
            <option value="qualified">Qualified</option>
            <option value="opportunity">Opportunity</option>
            <option value="proposal">Proposal</option>
            <option value="closed_won">Closed Won</option>
            <option value="closed_lost">Closed Lost</option>
          </select>
          <button onclick="syncCRM()" class="btn-secondary text-xs px-3 py-1.5">üîÑ Sync CRM</button>
          <button onclick="openDealModal()" class="btn-primary text-xs px-4 py-1.5">+ New Deal</button>
        </div>
      </div>
      <!-- Pipeline stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="pipeline-stats"></div>
      <!-- Funnel visualization -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card p-5">
          <h3 class="text-sm font-semibold mb-4">Pipeline Funnel</h3>
          <div id="pipeline-funnel"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-sm font-semibold mb-4">Pipeline Value by Stage</h3>
          <canvas id="pipeline-value-chart" height="220"></canvas>
        </div>
      </div>
      <!-- Pipeline board -->
      <div class="card mb-6">
        <div class="card-header px-5 py-3 font-semibold text-sm flex justify-between items-center">
          <span>Deal Board</span>
          <div class="flex gap-2">
            <button class="text-xs px-3 py-1 rounded tab-active pipeline-view-btn" data-view="board" onclick="setPipelineView('board')">Board</button>
            <button class="text-xs px-3 py-1 rounded tab-inactive pipeline-view-btn" data-view="table" onclick="setPipelineView('table')">Table</button>
          </div>
        </div>
        <div id="pipeline-board" class="p-4 overflow-x-auto"></div>
        <div id="pipeline-table" class="hidden"></div>
      </div>
      <!-- Cross-sell tracker -->
      <div class="card">
        <div class="card-header px-5 py-3 font-semibold text-sm">üîó Cross-Sell Tracker</div>
        <div class="p-4" id="cross-sell-list"></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Revenue Funnel ‚ïê‚ïê‚ïê -->
    <section id="sec-funnel" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold">Revenue Funnel & Pipeline</h2>
        <button onclick="exportSummary()" class="btn-secondary text-xs px-3 py-1.5">üì• Export Summary</button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-5">
          <h3 class="text-sm font-semibold mb-4">Sales Pipeline Funnel</h3>
          <div id="funnel-visual"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-sm font-semibold mb-4">Revenue Metrics</h3>
          <canvas id="revenue-chart" height="250"></canvas>
        </div>
      </div>
      <div class="card mt-4">
        <div class="card-header px-5 py-3 font-semibold text-sm">Sales Tasks</div>
        <div id="funnel-tasks" class="p-4"></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Departments ‚ïê‚ïê‚ïê -->
    <section id="sec-departments" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Department Drill-Down</h2>
      <div id="dept-tabs" class="flex gap-2 mb-6 flex-wrap"></div>
      <div id="dept-detail" class="space-y-4"><p class="text-[#64748b] card p-5">Select a department above</p></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê KPIs & Sparklines ‚ïê‚ïê‚ïê -->
    <section id="sec-kpis" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold">KPIs & Sparklines</h2>
        <button onclick="syncKPIs()" class="btn-secondary text-xs px-3 py-1.5">üîÑ Sync KPIs</button>
      </div>
      <div id="kpi-tabs" class="flex gap-2 mb-6 flex-wrap"></div>
      <div id="kpi-sparkline-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
      <div class="card">
        <table class="w-full text-sm">
          <thead><tr class="border-b border-[#2d3148]">
            <th class="text-left px-5 py-3">KPI</th><th class="text-left px-3 py-3">Target</th><th class="text-left px-3 py-3">Current</th><th class="text-left px-3 py-3">Status</th><th class="text-left px-3 py-3">Trend</th><th class="text-left px-3 py-3">Sparkline</th>
          </tr></thead>
          <tbody id="kpi-table"></tbody>
        </table>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Action Items (Overhauled) ‚ïê‚ïê‚ïê -->
    <section id="sec-actions" class="hidden">
      <style>
        /* ‚îÄ‚îÄ Action Table v2 ‚îÄ‚îÄ */
        .action-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        .action-table thead th { padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); z-index: 2; }
        .action-table tbody tr { cursor: pointer; transition: background 0.1s; border-bottom: 1px solid var(--border); }
        .action-table tbody tr:hover { background: var(--surface-elevated); }
        .action-table tbody tr.active-row { background: rgba(59,130,246,0.12); }
        .action-table tbody td { padding: 10px 12px; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.04); white-space: nowrap; }
        .action-table .title-cell { white-space: normal; max-width: 380px; overflow: hidden; text-overflow: ellipsis; }
        .sev-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
        .sev-dot-red { background: #ef4444; box-shadow: 0 0 6px #ef444466; }
        .sev-dot-yellow { background: #eab308; box-shadow: 0 0 6px #eab30866; }
        .sev-dot-blue { background: #3b82f6; box-shadow: 0 0 6px #3b82f666; }
        .unread-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); display: inline-block; animation: pulse 2s infinite; }
        .status-badge { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 500; display: inline-block; }
        .status-open { background: #1a2744; color: #60a5fa; }
        .status-awaiting_david { background: #3b1111; color: #f87171; }
        .status-awaiting_vp { background: #2D1F4E; color: #a78bfa; }
        .status-resolved { background: #113311; color: #4ade80; }
        .status-deferred { background: #1E2235; color: #94a3b8; }
        .sev-badge-red { background: #3b1111; color: #ef4444; }
        .sev-badge-yellow { background: #3b3b11; color: #eab308; }
        .sev-badge-blue { background: #112244; color: #3b82f6; }
        /* ‚îÄ‚îÄ Pro Filter Bar ‚îÄ‚îÄ */
        .action-pro-filters { margin-bottom: 12px; }
        .filter-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; }
        .filter-dropdown { position: relative; }
        .filter-trigger { display: flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary); font-size: 12px; font-family: inherit; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .filter-trigger:hover { border-color: var(--text-muted); color: var(--text-primary); }
        .filter-trigger.has-value { border-color: var(--accent); color: var(--accent); background: rgba(59,130,246,0.08); }
        .filter-dropdown-menu { display: none; position: absolute; top: calc(100% + 4px); left: 0; min-width: 200px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 60; overflow: hidden; animation: fdSlideDown 0.12s ease-out; }
        .filter-dropdown.open .filter-dropdown-menu { display: block; }
        @keyframes fdSlideDown { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .fd-option { display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; font-size: 12px; color: var(--text-secondary); cursor: pointer; transition: background 0.1s; }
        .fd-option:hover { background: var(--surface-elevated); color: var(--text-primary); }
        .fd-option.selected { background: rgba(59,130,246,0.12); color: var(--accent); }
        .fd-option .fd-check { opacity: 0; margin-right: 8px; color: var(--accent); font-size: 11px; }
        .fd-option.selected .fd-check { opacity: 1; }
        .fd-option .fd-count { font-size: 10px; color: var(--text-muted); background: rgba(255,255,255,0.06); padding: 1px 6px; border-radius: 8px; }
        .filter-search-wrap { position: relative; flex: 1; min-width: 160px; }
        .filter-search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .filter-search-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 5px 10px 5px 30px; color: var(--text-primary); font-size: 12px; font-family: inherit; }
        .filter-search-input:focus { outline: none; border-color: var(--accent); }
        .filter-clear-btn { padding: 5px 12px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); font-size: 11px; cursor: pointer; white-space: nowrap; font-family: inherit; transition: all 0.15s; }
        .filter-clear-btn:hover { color: #f87171; background: rgba(248,113,113,0.1); }
        .filter-active-chips { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.2s, padding 0.2s; }
        .filter-active-chips.has-chips { max-height: 40px; padding: 6px 0 0 0; }
        .filter-active-chips .chip-label { font-size: 11px; color: var(--text-muted); margin-right: 2px; }
        .active-chip { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 3px 8px 3px 10px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text-secondary); white-space: nowrap; }
        .active-chip.chip-status { border-color: rgba(96,165,250,0.4); color: #60a5fa; }
        .active-chip.chip-severity-red { border-color: rgba(239,68,68,0.4); color: #ef4444; }
        .active-chip.chip-severity-yellow { border-color: rgba(234,179,8,0.4); color: #eab308; }
        .active-chip.chip-severity-blue { border-color: rgba(59,130,246,0.4); color: #3b82f6; }
        .active-chip.chip-owner { border-color: rgba(167,139,250,0.4); color: #a78bfa; }
        .active-chip .chip-x { cursor: pointer; opacity: 0.6; font-size: 13px; line-height: 1; margin-left: 2px; }
        .active-chip .chip-x:hover { opacity: 1; }
        .filter-stats-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); padding: 4px 0 0 0; }
        .filter-stats-row .stat-sep { color: var(--border); }
        /* Sortable headers */
        .action-table thead th.sortable { cursor: pointer; user-select: none; }
        .action-table thead th.sortable:hover { color: var(--text-primary); }
        .action-table thead th .sort-arrow { font-size: 10px; margin-left: 3px; opacity: 0.4; }
        .action-table thead th.sort-active .sort-arrow { opacity: 1; color: var(--accent); }
        .sort-select { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; color: var(--text-secondary); font-size: 12px; cursor: pointer; font-family: inherit; }
        .sort-select:focus { outline: none; border-color: var(--accent); }
        .pagination-btn { padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .pagination-btn:hover { background: var(--surface-elevated); }
        .pagination-btn.active { background: var(--accent); color: white; }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .summon-dropdown { position: relative; display: inline-block; }
        .summon-dropdown-btn { display: flex; align-items: center; gap: 2px; }
        .summon-dropdown-menu { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; min-width: 160px; z-index: 50; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; }
        .summon-dropdown.open .summon-dropdown-menu { display: block; }
        .summon-dropdown-item { padding: 8px 14px; font-size: 12px; color: var(--text-primary); cursor: pointer; white-space: nowrap; transition: background 0.15s; }
        .summon-dropdown-item:hover { background: var(--accent); color: #fff; }
        .summon-dropdown-item.summoned { color: #22c55e; pointer-events: none; }
        .summon-dropdown-divider { border-top: 1px solid var(--border); }
        /* ‚îÄ‚îÄ Slide-out Detail Panel ‚îÄ‚îÄ */
        .action-detail-panel { position: fixed; top: 0; right: 0; width: 480px; max-width: 100vw; height: 100vh; background: var(--surface); border-left: 1px solid var(--border); z-index: 100; transform: translateX(100%); transition: transform 0.25s ease; display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0,0,0,0.4); }
        .action-detail-panel.open { transform: translateX(0); }
        .action-detail-panel .panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .action-detail-panel .panel-thread { flex: 1; overflow-y: auto; padding: 16px 20px; }
        .action-detail-panel .panel-footer { padding: 12px 20px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble.david { background: #1E3A5F; border-bottom-left-radius: 4px; margin-right: auto; }
        .chat-bubble.vp { background: #2D1F4E; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-bubble.system { background: #1E2235; margin: 0 auto; font-style: italic; color: var(--text-muted); font-size: 12px; text-align: center; max-width: 100%; }
        .action-reply-input { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; color: var(--text-primary); font-size: 13px; width: 100%; resize: none; font-family: inherit; }
        .action-reply-input:focus { outline: none; border-color: var(--accent); }
        .panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .panel-overlay.open { opacity: 1; pointer-events: auto; }
        @media (max-width: 640px) { .action-detail-panel { width: 100vw; } }
      </style>

      <!-- Header -->
      <div class="flex justify-between items-start mb-6 flex-header">
        <div>
          <h2 class="text-2xl font-bold">Action Items</h2>
          <p class="text-sm text-[#94a3b8] mt-1">Threaded conversations ¬∑ <span id="action-sync-time" class="text-[#64748b]">‚Äî</span></p>
        </div>
        <div class="flex gap-2 items-center">
          <div class="summon-dropdown" id="header-summon-dropdown">
            <button onclick="toggleSummonDropdown('header-summon-dropdown')" class="btn-secondary text-xs px-3 py-1.5 summon-dropdown-btn">üìû Call VP ‚ñæ</button>
            <div class="summon-dropdown-menu" id="header-summon-menu"></div>
          </div>
          <button onclick="syncTodoItems()" class="btn-secondary text-xs px-3 py-1.5">üîÑ Sync</button>
          <button onclick="openNewActionModal()" class="btn-primary text-xs px-3 py-1.5">+ New Action</button>
        </div>
      </div>

    <!-- New Action Item Modal -->
    <div id="new-action-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:520px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">New Action Item</h3>
          <button onclick="closeNewActionModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
        </div>
        <form onsubmit="submitNewAction(event)">
          <div class="mb-3">
            <label class="form-label">Title <span class="text-red-400">*</span></label>
            <input type="text" id="new-action-title" class="form-input" placeholder="Brief summary of the issue" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description <span class="text-red-400">*</span> <span class="text-xs text-[#64748b]">(min 20 chars)</span></label>
            <textarea id="new-action-desc" class="form-input h-28" placeholder="Explain what you need and why. Be specific ‚Äî David shouldn't have to guess." required minlength="20"></textarea>
            <div class="text-xs text-[#64748b] mt-1"><span id="new-action-char-count">0</span>/20 min characters</div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="form-label">Requester</label>
              <input type="text" id="new-action-requester" class="form-input" placeholder="Your name / dept">
            </div>
            <div>
              <label class="form-label">Severity</label>
              <select id="new-action-severity" class="form-input">
                <option value="yellow">üü° Blocking Progress</option>
                <option value="red">üî¥ Blocking Revenue</option>
                <option value="blue">üîµ Decision Pending</option>
              </select>
            </div>
          </div>
          <div id="new-action-error" class="text-sm text-red-400 mb-3 hidden"></div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeNewActionModal()" class="btn-ghost text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm">Create Action Item</button>
          </div>
        </form>
      </div>
    </div>

      <!-- Pro Filter Bar -->
      <div id="action-filter-bar" class="action-pro-filters">
        <div class="filter-row">
          <div class="filter-dropdown" id="fd-status">
            <button class="filter-trigger" onclick="toggleFilterDropdown('fd-status')">
              <span class="filter-trigger-label" id="fd-status-label">Status</span>
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
            </button>
            <div class="filter-dropdown-menu" id="fd-status-menu"></div>
          </div>
          <div class="filter-dropdown" id="fd-severity">
            <button class="filter-trigger" onclick="toggleFilterDropdown('fd-severity')">
              <span class="filter-trigger-label" id="fd-severity-label">Severity</span>
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
            </button>
            <div class="filter-dropdown-menu" id="fd-severity-menu"></div>
          </div>
          <div class="filter-dropdown" id="fd-owner">
            <button class="filter-trigger" onclick="toggleFilterDropdown('fd-owner')">
              <span class="filter-trigger-label" id="fd-owner-label">Owner</span>
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
            </button>
            <div class="filter-dropdown-menu" id="fd-owner-menu"></div>
          </div>
          <div class="filter-search-wrap">
            <svg class="filter-search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" id="action-search" class="filter-search-input" placeholder="Search items & threads..." oninput="debounceActionSearch()">
          </div>
          <button id="filter-clear-all-btn" class="filter-clear-btn hidden" onclick="clearAllActionFilters()">‚úï Clear filters</button>
        </div>
        <div class="filter-active-chips" id="filter-active-chips"></div>
        <div class="filter-stats-row" id="filter-stats-row"></div>
      </div>

      <!-- Table -->
      <div class="card" style="overflow:hidden;">
        <div style="overflow-x:auto;max-height:calc(100vh - 300px);overflow-y:auto;" id="action-table-wrap">
          <table class="action-table" id="action-items-table">
            <thead>
              <tr>
                <th style="width:36px;"></th>
                <th class="sortable" onclick="setActionSort('title')">Title<span class="sort-arrow" id="sort-arrow-title"></span></th>
                <th class="sortable" style="width:100px;" onclick="setActionSort('owner')">Owner<span class="sort-arrow" id="sort-arrow-owner"></span></th>
                <th class="sortable" style="width:120px;" onclick="setActionSort('status')">Status<span class="sort-arrow" id="sort-arrow-status"></span></th>
                <th class="sortable" style="width:60px;" onclick="setActionSort('severity')">Sev<span class="sort-arrow" id="sort-arrow-severity"></span></th>
                <th class="sortable" style="width:90px;" onclick="setActionSort('last_activity')">Active<span class="sort-arrow" id="sort-arrow-last_activity"></span></th>
                <th style="width:50px;">üí¨</th>
              </tr>
            </thead>
            <tbody id="action-items-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="flex justify-between items-center mt-4" id="action-pagination"></div>

      <!-- Slide-out Detail Panel -->
      <div class="panel-overlay" id="action-panel-overlay" onclick="closeActionPanel()"></div>
      <div class="action-detail-panel" id="action-detail-panel">
        <div class="panel-header">
          <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0 mr-3">
              <div class="flex items-center gap-2 mb-1">
                <span class="sev-dot" id="panel-sev-dot"></span>
                <h3 class="text-lg font-bold" id="panel-title" style="overflow:hidden;text-overflow:ellipsis;"></h3>
              </div>
              <div class="text-xs text-[#94a3b8]" id="panel-meta"></div>
            </div>
            <button onclick="closeActionPanel()" class="text-[#94a3b8] hover:text-white text-xl" style="line-height:1;">&times;</button>
          </div>
          <div class="flex items-center gap-2 mt-3" id="panel-status-row"></div>
        </div>
        <div class="panel-thread" id="panel-thread"></div>
        <div class="panel-footer">
          <div class="flex gap-2 mb-3">
            <textarea class="action-reply-input" id="panel-reply-input" rows="2" placeholder="Type David's reply..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendPanelReply();}"></textarea>
            <button onclick="sendPanelReply()" class="btn-primary text-xs px-4" style="align-self:flex-end;border-radius:10px;">Send</button>
          </div>
          <div class="flex gap-2 flex-wrap" id="panel-actions"></div>
        </div>
      </div>
    </section>

    <!-- Quick Resolve Modal -->
    <div id="resolve-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:440px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="resolve-modal-title">Resolve Action Item</h3>
          <button onclick="closeResolveModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
        </div>
        <p class="text-sm text-[#94a3b8] mb-3" id="resolve-modal-item"></p>
        <div class="mb-4">
          <label class="form-label">Notes (optional)</label>
          <textarea id="resolve-notes" class="form-input h-20" placeholder="Resolution notes..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button onclick="closeResolveModal()" class="btn-ghost text-sm">Cancel</button>
          <button onclick="confirmResolve()" class="btn-primary text-sm">‚úì Resolve</button>
          <button onclick="confirmDefer()" class="btn-secondary text-sm">‚è∏ Defer</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Social Calendar ‚ïê‚ïê‚ïê -->
    <section id="sec-calendar" class="hidden">
      <style>
        .cal-grid { display: grid; gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; }
        .cal-grid-month { grid-template-columns: repeat(7, 1fr); }
        .cal-grid-week { grid-template-columns: repeat(7, 1fr); }
        .cal-cell { background: var(--surface); min-height: 120px; padding: 8px; position: relative; }
        .cal-cell.today { background: #1E3A5F22; }
        .cal-cell.other-month { opacity: 0.4; }
        .cal-day-label { font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
        .cal-day-num { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .cal-day-num.today { color: var(--accent); background: var(--accent); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .cal-post { font-size: 11px; padding: 4px 6px; border-radius: 6px; margin-bottom: 3px; cursor: pointer; transition: all 0.15s; border-left: 3px solid; line-height: 1.3; }
        .cal-post:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .cal-post .cal-post-time { font-size: 9px; color: var(--text-muted); }
        .platform-x { border-color: #1DA1F2; background: #1DA1F222; }
        .platform-linkedin_company { border-color: #0A66C2; background: #0A66C222; }
        .platform-linkedin_personal { border-color: #0A66C2; background: #0A66C233; }
        .platform-badge { font-size: 10px; padding: 1px 6px; border-radius: 10px; font-weight: 600; }
        .platform-badge-x { background: #1DA1F233; color: #1DA1F2; }
        .platform-badge-linkedin_company { background: #0A66C233; color: #0A66C2; }
        .platform-badge-linkedin_personal { background: #0A66C244; color: #60A5FA; }
        .post-status-draft { background: #64748b33; color: #94a3b8; }
        .post-status-pending_review { background: #eab30833; color: #eab308; }
        .post-status-approved { background: #22c55e33; color: #22c55e; }
        .post-status-declined { background: #ef444433; color: #ef4444; }
        .post-status-changes_requested { background: #f9731633; color: #f97316; }
        .post-status-posted { background: #3b82f633; color: #3b82f6; }
        .post-detail-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .post-detail-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .x-preview { background: #000; border: 1px solid #2F3336; border-radius: 12px; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .x-preview .x-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1DA1F2; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: white; }
        .x-preview .x-name { font-weight: 700; color: #E7E9EA; font-size: 15px; }
        .x-preview .x-handle { color: #71767B; font-size: 15px; }
        .x-preview .x-content { color: #E7E9EA; font-size: 15px; line-height: 1.4; margin-top: 8px; white-space: pre-wrap; }
        .x-preview .x-hashtag { color: #1DA1F2; }
        .li-preview { background: #1B1F23; border: 1px solid #38434F; border-radius: 8px; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .li-preview .li-avatar { width: 48px; height: 48px; border-radius: 50%; background: #0A66C2; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: white; }
        .li-preview .li-name { font-weight: 600; color: rgba(255,255,255,0.9); font-size: 14px; }
        .li-preview .li-headline { color: rgba(255,255,255,0.6); font-size: 12px; }
        .li-preview .li-content { color: rgba(255,255,255,0.85); font-size: 14px; line-height: 1.5; margin-top: 12px; white-space: pre-wrap; }
        .li-preview .li-hashtag { color: #70B5F9; }
        .post-chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
        .post-chat-bubble.david { background: #1E3A5F; border-bottom-left-radius: 4px; margin-right: auto; }
        .post-chat-bubble.max { background: #2D1F4E; border-bottom-right-radius: 4px; margin-left: auto; }
        .post-chat-bubble.system { background: #1E2235; margin: 0 auto; font-style: italic; color: var(--text-muted); font-size: 12px; text-align: center; max-width: 100%; }
      </style>
      <div class="flex justify-between items-center mb-6 flex-header">
        <div>
          <h2 class="text-2xl font-bold">üì± Social Calendar</h2>
          <p class="text-sm text-[#94a3b8] mt-1">Scheduled social media posts ¬∑ Review & approve</p>
        </div>
        <div class="flex gap-2 items-center">
          <select id="cal-platform-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="updateCalendarURL();loadCalendar()">
            <option value="">All Platforms</option>
            <option value="x">ùïè (Twitter)</option>
            <option value="linkedin_company">LinkedIn Company</option>
            <option value="linkedin_personal">LinkedIn Personal</option>
          </select>
          <select id="cal-status-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="loadCalendar()">
            <option value="">All Statuses</option>
            <option value="draft">Draft</option>
            <option value="pending_review">Pending Review</option>
            <option value="approved">Approved</option>
            <option value="declined">Declined</option>
            <option value="changes_requested">Changes Requested</option>
            <option value="posted">Posted</option>
          </select>
          <div class="flex gap-1">
            <button onclick="calNavPrev()" class="btn-secondary text-xs px-3 py-1.5">‚Äπ</button>
            <button onclick="calNavToday()" class="btn-secondary text-xs px-3 py-1.5">Today</button>
            <button onclick="calNavNext()" class="btn-secondary text-xs px-3 py-1.5">‚Ä∫</button>
          </div>
          <select id="cal-view" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="loadCalendar()">
            <option value="month">Month</option>
            <option value="week">Week</option>
          </select>
          <button onclick="openNewPostModal()" class="btn-primary text-xs px-4 py-1.5">+ New Post</button>
        </div>
      </div>
      <div class="text-center mb-4"><span id="cal-title" class="text-lg font-semibold"></span></div>
      <!-- Calendar header -->
      <div id="cal-header" class="grid grid-cols-7 gap-0 mb-0" style="background:var(--surface);border-radius:12px 12px 0 0;border:1px solid var(--border);border-bottom:none;">
        <div class="cal-day-label text-center py-2">Sun</div><div class="cal-day-label text-center py-2">Mon</div><div class="cal-day-label text-center py-2">Tue</div><div class="cal-day-label text-center py-2">Wed</div><div class="cal-day-label text-center py-2">Thu</div><div class="cal-day-label text-center py-2">Fri</div><div class="cal-day-label text-center py-2">Sat</div>
      </div>
      <div id="cal-grid"></div>
      <!-- Summary cards below calendar -->
      <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mt-4" id="cal-summary"></div>
    </section>

    <!-- Post Detail Modal -->
    <div id="post-detail-modal" class="fixed inset-0 post-detail-overlay z-50 flex items-center justify-center hidden">
      <div class="post-detail-panel p-0">
        <div id="post-detail-content"></div>
      </div>
    </div>

    <!-- New Post Modal -->
    <div id="new-post-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:560px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold" id="post-modal-title">New Post</h3>
          <button onclick="closeNewPostModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
        </div>
        <form onsubmit="submitPost(event)">
          <input type="hidden" id="post-edit-id">
          <div class="mb-3">
            <label class="form-label">Title / Hook</label>
            <input type="text" id="post-title" class="form-input" placeholder="Short title for calendar" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Content</label>
            <textarea id="post-content" class="form-input" style="height:120px;" placeholder="Full post text..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="form-label">Platform</label>
              <select id="post-platform" class="form-input">
                <option value="x">ùïè (Twitter)</option>
                <option value="linkedin_company">LinkedIn Company</option>
                <option value="linkedin_personal">LinkedIn Personal</option>
              </select>
            </div>
            <div>
              <label class="form-label">Status</label>
              <select id="post-status-input" class="form-input">
                <option value="draft">Draft</option>
                <option value="pending_review">Submit for Review</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="form-label">Scheduled Date/Time</label>
              <input type="datetime-local" id="post-scheduled" class="form-input">
            </div>
            <div>
              <label class="form-label">Hashtags</label>
              <input type="text" id="post-hashtags" class="form-input" placeholder="#amtecco #cdn">
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeNewPostModal()" class="btn-ghost text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm">Save Post</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Visual Requests ‚ïê‚ïê‚ïê -->
    <section id="sec-visual-requests" class="hidden">
      <style>
        .vr-status-pending { background: #eab30833; color: #eab308; }
        .vr-status-in_progress { background: #3b82f633; color: #3b82f6; }
        .vr-status-done { background: #22c55e33; color: #22c55e; }
        .vr-status-changes_requested { background: #f9731633; color: #f97316; }
        .vr-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.15s; }
        .vr-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .vr-chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
        .vr-chat-bubble.david { background: #1E3A5F; border-bottom-left-radius: 4px; margin-right: auto; }
        .vr-chat-bubble.agent { background: #2D1F4E; border-bottom-right-radius: 4px; margin-left: auto; }
        .vr-chat-bubble.system { background: #1E2235; margin: 0 auto; font-style: italic; color: var(--text-muted); font-size: 12px; text-align: center; max-width: 100%; }
      </style>
      <div class="flex justify-between items-center mb-6 flex-header">
        <div>
          <h2 class="text-2xl font-bold">üé® Visual Requests</h2>
          <p class="text-sm text-[#94a3b8] mt-1">AI generation queue ¬∑ Visual assets requested by the team</p>
        </div>
        <div class="flex gap-2 items-center">
          <select id="vr-status-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="loadVisualRequests()">
            <option value="">All Statuses</option>
            <option value="pending">‚è≥ Pending</option>
            <option value="in_progress">üîÑ In Progress</option>
            <option value="changes_requested">‚úèÔ∏è Changes Requested</option>
            <option value="done">‚úÖ Done</option>
          </select>
          <button onclick="openNewVRModal()" class="btn-primary text-xs px-4 py-1.5">+ New Request</button>
        </div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="vr-summary"></div>
      <div id="vr-list" class="space-y-3"></div>
    </section>

    <!-- Visual Request Detail Modal -->
    <div id="vr-detail-modal" class="fixed inset-0 post-detail-overlay z-50 flex items-center justify-center hidden">
      <div class="post-detail-panel p-0" style="max-width:950px;">
        <div id="vr-detail-content"></div>
      </div>
    </div>

    <!-- New Visual Request Modal -->
    <div id="new-vr-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:560px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">New Visual Request</h3>
          <button onclick="closeNewVRModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
        </div>
        <form onsubmit="submitVR(event)">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" id="vr-title" class="form-input" placeholder="What visual is needed?" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description / Specs</label>
            <textarea id="vr-description" class="form-input" style="height:100px;" placeholder="Dimensions, style, colors, references..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="form-label">Requesting Agent</label>
              <select id="vr-agent" class="form-input">
                <option value="Zara">Zara (Design)</option>
                <option value="Max">Max (Marketing)</option>
                <option value="Nadia">Nadia (Research)</option>
                <option value="Elena">Elena (Sales)</option>
                <option value="Viktor">Viktor (Engineering)</option>
                <option value="Sylvia">Sylvia (COO)</option>
              </select>
            </div>
            <div>
              <label class="form-label">Deadline (optional)</label>
              <input type="date" id="vr-deadline" class="form-input">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Associated Social Post (optional)</label>
            <select id="vr-post-id" class="form-input">
              <option value="">‚Äî None ‚Äî</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Reference Specs / URLs</label>
            <input type="text" id="vr-ref-specs" class="form-input" placeholder="Links to reference images, specs, etc.">
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeNewVRModal()" class="btn-ghost text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm">Create Request</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Mark Done Modal (Drive URL input) -->
    <div id="vr-done-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:460px;">
        <h3 class="text-lg font-bold mb-4">‚úÖ Mark as Done</h3>
        <div class="mb-3">
          <label class="form-label">Google Drive URL</label>
          <input type="url" id="vr-done-drive-url" class="form-input" placeholder="https://drive.google.com/...">
        </div>
        <div class="mb-3">
          <label class="form-label">Drive File ID (optional)</label>
          <input type="text" id="vr-done-drive-id" class="form-input" placeholder="File ID">
        </div>
        <input type="hidden" id="vr-done-id">
        <div class="flex justify-end gap-2">
          <button onclick="closeVRDoneModal()" class="btn-ghost text-sm">Cancel</button>
          <button onclick="submitVRDone()" class="btn-primary text-sm">‚úÖ Mark Done</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Research Requests ‚ïê‚ïê‚ïê -->
    <section id="sec-research-requests" class="hidden">
      <style>
        .rr-status-pending { background: #eab30833; color: #eab308; }
        .rr-status-in_progress { background: #3b82f633; color: #3b82f6; }
        .rr-status-done { background: #22c55e33; color: #22c55e; }
        .rr-status-changes_requested { background: #f9731633; color: #f97316; }
        .rr-priority-urgent { background: #ef444433; color: #ef4444; }
        .rr-priority-high { background: #eab30833; color: #eab308; }
        .rr-priority-normal { background: #64748b33; color: #94a3b8; }
        .rr-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.15s; }
        .rr-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .rr-chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
        .rr-chat-bubble.david { background: #1E3A5F; border-bottom-left-radius: 4px; margin-right: auto; }
        .rr-chat-bubble.agent { background: #2D1F4E; border-bottom-right-radius: 4px; margin-left: auto; }
        .rr-chat-bubble.system { background: #1E2235; margin: 0 auto; font-style: italic; color: var(--text-muted); font-size: 12px; text-align: center; max-width: 100%; }
      </style>
      <div class="flex justify-between items-center mb-6 flex-header">
        <div>
          <h2 class="text-2xl font-bold">üî¨ Research Requests</h2>
          <p class="text-sm text-[#94a3b8] mt-1">Deep research queue ¬∑ Research requests from the team</p>
        </div>
        <div class="flex gap-2 items-center">
          <select id="rr-status-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="loadResearchRequests()">
            <option value="">All Statuses</option>
            <option value="pending">‚è≥ Pending</option>
            <option value="in_progress">üîÑ In Progress</option>
            <option value="changes_requested">‚úèÔ∏è Changes Requested</option>
            <option value="done">‚úÖ Done</option>
          </select>
          <button onclick="openNewRRModal()" class="btn-primary text-xs px-4 py-1.5">+ New Request</button>
        </div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="rr-summary"></div>
      <div id="rr-list" class="space-y-3"></div>
    </section>

    <!-- Research Request Detail Modal -->
    <div id="rr-detail-modal" class="fixed inset-0 post-detail-overlay z-50 flex items-center justify-center hidden">
      <div class="post-detail-panel p-0" style="max-width:950px;">
        <div id="rr-detail-content"></div>
      </div>
    </div>

    <!-- New Research Request Modal -->
    <div id="new-rr-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:560px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">New Research Request</h3>
          <button onclick="closeNewRRModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
        </div>
        <form onsubmit="submitRR(event)">
          <div class="mb-3">
            <label class="form-label">Title / Research Question</label>
            <input type="text" id="rr-title" class="form-input" placeholder="What do you need researched?" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description / Scope</label>
            <textarea id="rr-description" class="form-input" style="height:80px;" placeholder="Describe the research question in detail..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Context / Background</label>
            <textarea id="rr-context" class="form-input" style="height:60px;" placeholder="Why is this research needed? What decisions depend on it?"></textarea>
          </div>
          <div class="grid grid-cols-3 gap-3 mb-3">
            <div>
              <label class="form-label">Requesting Agent</label>
              <select id="rr-agent" class="form-input">
                <option value="Nadia">Nadia (Research)</option>
                <option value="Max">Max (Marketing)</option>
                <option value="Elena">Elena (Sales)</option>
                <option value="Viktor">Viktor (Engineering)</option>
                <option value="Zara">Zara (Design)</option>
                <option value="Sylvia">Sylvia (COO)</option>
              </select>
            </div>
            <div>
              <label class="form-label">Priority</label>
              <select id="rr-priority" class="form-input">
                <option value="normal">‚ö™ Normal</option>
                <option value="high">üü° High</option>
                <option value="urgent">üî¥ Urgent</option>
              </select>
            </div>
            <div>
              <label class="form-label">Deadline</label>
              <input type="date" id="rr-deadline" class="form-input">
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeNewRRModal()" class="btn-ghost text-sm">Cancel</button>
            <button type="submit" class="btn-primary text-sm">Create Request</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Research Request Done Modal -->
    <div id="rr-done-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
      <div class="modal-content p-6" style="max-width:460px;">
        <h3 class="text-lg font-bold mb-4">‚úÖ Mark Research as Done</h3>
        <p class="text-xs text-[#94a3b8] mb-3">File to: Research & Intelligence / Deep Research Requests / Completed</p>
        <div class="mb-3">
          <label class="form-label">Google Drive URL</label>
          <input type="url" id="rr-done-drive-url" class="form-input" placeholder="https://drive.google.com/...">
        </div>
        <div class="mb-3">
          <label class="form-label">Drive File ID (optional)</label>
          <input type="text" id="rr-done-drive-id" class="form-input" placeholder="File ID">
        </div>
        <input type="hidden" id="rr-done-id">
        <div class="flex justify-end gap-2">
          <button onclick="closeRRDoneModal()" class="btn-ghost text-sm">Cancel</button>
          <button onclick="submitRRDone()" class="btn-primary text-sm">‚úÖ Mark Done</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Blockers ‚ïê‚ïê‚ïê -->
    <section id="sec-blockers" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold">Blockers & Alerts</h2>
        <div class="flex gap-2 flex-wrap">
          <button class="text-xs px-3 py-1.5 rounded-full tab-active blocker-filter" data-filter="all">All</button>
          <button class="text-xs px-3 py-1.5 rounded-full tab-inactive blocker-filter" data-filter="open">Open</button>
          <button class="text-xs px-3 py-1.5 rounded-full tab-inactive blocker-filter" data-filter="red">üî¥ Critical</button>
          <button class="text-xs px-3 py-1.5 rounded-full tab-inactive blocker-filter" data-filter="yellow">üü° High</button>
          <button class="text-xs px-3 py-1.5 rounded-full tab-inactive blocker-filter" data-filter="blue">üîµ Medium</button>
        </div>
      </div>
      <div id="actions-list" class="space-y-3"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Report Archive ‚ïê‚ïê‚ïê -->
    <section id="sec-reports" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Report Archive</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="col-span-1">
          <div class="card">
            <div class="card-header px-5 py-3 font-semibold text-sm">üìÇ Files</div>
            <div id="report-file-list" class="p-2 max-h-96 overflow-y-auto"></div>
          </div>
        </div>
        <div class="lg:col-span-2">
          <div class="card">
            <div class="card-header px-5 py-3 font-semibold text-sm flex justify-between items-center">
              <span id="report-viewer-title">Select a report</span>
              <button id="report-print-btn" class="btn-ghost text-xs hidden" onclick="printReport()">üñ®Ô∏è Print</button>
            </div>
            <div id="report-viewer" class="p-5 report-content text-sm" style="min-height:300px;">
              <p class="text-[#64748b]">Click a file to view its contents</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Priorities ‚ïê‚ïê‚ïê -->
    <section id="sec-priorities" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Top Priorities</h2>
      <div id="priorities-list" class="grid grid-cols-1 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Initiatives ‚ïê‚ïê‚ïê -->
    <section id="sec-initiatives" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Strategic Initiatives</h2>
      <div id="initiatives-list" class="space-y-4"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Reporting ‚ïê‚ïê‚ïê -->
    <section id="sec-reporting" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Reporting Status</h2>
      <div class="card"><table class="w-full text-sm"><thead><tr class="border-b border-[#2d3148]">
        <th class="text-left px-5 py-3">Report</th><th class="text-left px-3 py-3">Frequency</th><th class="text-left px-3 py-3">Flow</th><th class="text-left px-3 py-3">Next Due</th><th class="text-left px-3 py-3">Status</th>
      </tr></thead><tbody id="reporting-table"></tbody></table></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Revenue ‚ïê‚ïê‚ïê -->
    <section id="sec-revenue" class="hidden">
      <h2 class="text-2xl font-bold mb-6">Revenue & Metrics</h2>
      <div id="revenue-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Organization ‚ïê‚ïê‚ïê -->
    <section id="sec-org" class="hidden">
      <style>
        .org-summary-bar { display:flex; gap:24px; flex-wrap:wrap; margin-bottom:24px; padding:16px 20px; background:var(--surface); border:1px solid var(--border); border-radius:12px; }
        .org-summary-stat { text-align:center; }
        .org-summary-stat .num { font-size:24px; font-weight:700; }
        .org-summary-stat .lbl { font-size:11px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; }
        .org-tree { position:relative; }
        .org-level { display:flex; flex-wrap:wrap; justify-content:center; gap:16px; margin-bottom:32px; }
        .org-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 18px; min-width:180px; max-width:240px; cursor:pointer; transition:all 0.2s; position:relative; }
        .org-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 4px 16px rgba(0,0,0,0.3); }
        .org-card.active-agent { border-left:3px solid #22c55e; }
        .org-card .agent-name { font-weight:600; font-size:14px; }
        .org-card .agent-role { font-size:12px; color:var(--text-secondary); }
        .org-card .agent-dept { display:inline-block; font-size:10px; padding:2px 8px; border-radius:99px; font-weight:500; margin-top:4px; }
        .org-card .model-pill { font-size:9px; padding:1px 6px; border-radius:99px; background:#1e293b; color:#94a3b8; margin-top:4px; display:inline-block; }
        .org-card .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; }
        .status-dot.active { background:#22c55e; animation:pulse-green 2s infinite; }
        .status-dot.sleeping { background:#64748b; }
        @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)} 50%{box-shadow:0 0 0 6px rgba(34,197,94,0)} }
        .org-card .task-text { font-size:11px; color:var(--text-secondary); margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
        .dept-eng { background:rgba(59,130,246,0.15); color:#60a5fa; }
        .dept-ri { background:rgba(168,85,247,0.15); color:#c084fc; }
        .dept-mc { background:rgba(251,146,60,0.15); color:#fb923c; }
        .dept-sbd { background:rgba(34,197,94,0.15); color:#4ade80; }
        .dept-db { background:rgba(244,114,182,0.15); color:#f472b6; }
        .dept-ops { background:rgba(148,163,184,0.15); color:#94a3b8; }
        .org-dept-group { margin-bottom:24px; }
        .org-dept-header { font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:12px; cursor:pointer; user-select:none; }
        .org-dept-header:hover { color:var(--text-primary); }
        .org-connector { text-align:center; color:var(--border); font-size:20px; margin:-12px 0; }
        /* Side panel */
        .org-panel { position:fixed; right:-420px; top:0; width:400px; height:100vh; background:var(--surface); border-left:1px solid var(--border); z-index:100; transition:right 0.3s ease; overflow-y:auto; padding:24px; box-shadow:-4px 0 24px rgba(0,0,0,0.3); }
        .org-panel.open { right:0; }
        .org-panel .close-btn { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer; }
        .org-panel .cap-pill { display:inline-block; font-size:10px; padding:2px 8px; border-radius:99px; background:#1e293b; color:#94a3b8; margin:2px; }
        .org-panel .wake-input { width:100%; padding:8px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:13px; margin-top:8px; }
        .org-panel .wake-btn { margin-top:8px; padding:8px 16px; background:#22c55e; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
        .org-panel .wake-btn:hover { background:#16a34a; }
        .org-panel .activity-item { padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; }
        /* Vendor panel */
        .vendor-panel { position:fixed; right:-420px; top:0; width:400px; height:100vh; background:var(--surface); border-left:1px solid var(--border); z-index:100; transition:right 0.3s ease; overflow-y:auto; padding:24px; box-shadow:-4px 0 24px rgba(0,0,0,0.3); }
        .vendor-panel.open { right:0; }
        .vendor-panel .close-btn { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer; }
        .vendor-panel .form-input { width:100%; padding:8px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:13px; margin-bottom:12px; }
        .vendor-panel .form-label { display:block; font-size:12px; font-weight:500; color:var(--text-secondary); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em; }
        .vendor-panel .form-select { width:100%; padding:8px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:13px; margin-bottom:12px; }
        .vendor-panel .form-textarea { width:100%; padding:8px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:13px; margin-bottom:12px; resize:vertical; }
        .vendor-panel .btn-save { margin-right:8px; padding:8px 16px; background:#22c55e; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
        .vendor-panel .btn-save:hover { background:#16a34a; }
        .vendor-panel .btn-delete { padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
        .vendor-panel .btn-delete:hover { background:#dc2626; }
        /* Toast */
        .org-toast { position:fixed; bottom:24px; right:24px; background:#22c55e; color:white; padding:12px 20px; border-radius:10px; font-size:14px; z-index:200; opacity:0; transition:opacity 0.3s; pointer-events:none; }
        .org-toast.show { opacity:1; }
        /* Mobile */
        @media(max-width:768px) {
          .org-level { flex-direction:column; align-items:center; }
          .org-card { max-width:100%; min-width:auto; }
          .org-panel { width:100%; right:-100%; }
          .vendor-panel { width:100%; right:-100%; }
        }
/* Fleet Management Styles */
        .fleet-mode .model-pill { display:none; }
        .fleet-mode .model-select { display:inline-block; font-size:10px; padding:1px; background:#1e293b; color:white; border:1px solid #334155; border-radius:4px; margin-top:4px; max-width:100px; }
        .fleet-toolbar { background:#1e293b; padding:8px 16px; border-radius:8px; margin-bottom:16px; display:flex; justify-content:between; align-items:center; border:1px solid #334155; }
        .fleet-pending-bar { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0f172a; border:1px solid #334155; padding:12px 24px; border-radius:12px; display:flex; gap:16px; align-items:center; z-index:9999; box-shadow:0 10px 25px rgba(0,0,0,0.5); animation:slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform:translate(-50%, 100%); } to { transform:translate(-50%, 0); } }
      </style>

      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">üèõ Organization & Fleet</h2>
        <div class="text-xs text-[#64748b]" id="org-refresh-time"></div>
      </div>

      <!-- Summary Bar / Fleet Legend -->
      <div class="org-summary-bar flex-col items-stretch" id="org-summary"></div>

      <!-- Fleet Controls (Hidden by default) -->
      <div id="fleet-controls" class="hidden fleet-toolbar">
        <div class="flex gap-2 items-center">
          <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">üõ†Ô∏è Fleet Manager</span>
          <div class="h-4 w-px bg-slate-600 mx-2"></div>
          <button onclick="bulkSwapModel('anthropic/claude-opus-4-6', 'openai-codex/gpt-5.2')" class="btn-ghost text-xs px-2 py-1">Opus ‚Üí GPT-5</button>
          <button onclick="bulkSwapProvider('Anthropic', 'OpenAI')" class="btn-ghost text-xs px-2 py-1">Anthropic ‚Üí OpenAI</button>
        </div>
        <div class="flex gap-2">
          <button onclick="saveFleetDefaults()" class="btn-secondary text-xs px-3 py-1.5" title="Save current config as default">üíæ Save Defaults</button>
          <button onclick="restoreFleetDefaults()" class="btn-secondary text-xs px-3 py-1.5" title="Restore from saved defaults">‚Ü∫ Restore Defaults</button>
        </div>
      </div>

      <!-- Org Tree -->
      <div class="org-tree" id="org-tree"></div>

      <!-- Side Panel -->
      <div class="org-panel" id="org-panel">
        <button class="close-btn" onclick="closeOrgPanel()">‚úï</button>
        <div id="org-panel-content"></div>
      </div>

      <!-- Toast -->
      <div class="org-toast" id="org-toast"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Vendors ‚ïê‚ïê‚ïê -->
    <section id="sec-vendors" class="hidden">
      <div class="flex justify-between items-center mb-6 flex-header">
        <h2 class="text-2xl font-bold">üí≥ Vendor Registry</h2>
        <div class="flex gap-2 items-center">
          <span class="text-xs text-[#64748b]" id="vendor-sync-time">Loading...</span>
          <button onclick="syncVendors()" class="btn-secondary text-xs px-3 py-1.5">üîÑ Sync</button>
          <button onclick="openVendorModal()" class="btn-primary text-xs px-4 py-1.5">+ Add Vendor</button>
        </div>
      </div>
      
      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="vendor-summary-cards">
        <div class="card p-4">
          <div class="text-xs text-[#94a3b8] mb-1">Total Monthly Spend</div>
          <div class="text-2xl font-bold text-[#eab308]" id="vendor-total-monthly-spend">Loading...</div>
          <div class="text-xs text-[#64748b] mt-1">Active vendors cost</div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-[#94a3b8] mb-1">Active Accounts</div>
          <div class="text-2xl font-bold text-[#22c55e]" id="vendor-active-accounts">-</div>
          <div class="text-xs text-[#64748b] mt-1">Currently active</div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-[#94a3b8] mb-1">Pending Approval</div>
          <div class="text-2xl font-bold text-[#3b82f6]" id="vendor-pending-approval">-</div>
          <div class="text-xs text-[#64748b] mt-1">Awaiting approval</div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-[#94a3b8] mb-1">By Department</div>
          <div class="text-sm" id="vendor-by-department">Loading...</div>
          <div class="text-xs text-[#64748b] mt-1">Top 3 departments</div>
        </div>
      </div>

      <!-- Cost Breakdown -->
      <div class="card mb-6">
        <div class="card-header px-5 py-3">
          <h3 class="font-semibold text-sm">üí∞ Cost Breakdown by Department</h3>
        </div>
        <div class="p-5">
          <div class="flex justify-center">
            <div style="width:400px;height:300px;position:relative;">
              <canvas id="cost-breakdown-chart"></canvas>
            </div>
          </div>
          <div class="text-center text-xs text-[#64748b] mt-3">
            Monthly spend by department (active vendors only)
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <select id="vendor-status-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="updateFiltersAndLoad()">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="trial">Trial</option>
          <option value="pending-approval">Pending Approval</option>
          <option value="suspended">Suspended</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <select id="vendor-category-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="updateFiltersAndLoad()">
          <option value="">All Categories</option>
          <option value="lead-gen">Lead Generation</option>
          <option value="design">Design</option>
          <option value="infrastructure">Infrastructure</option>
          <option value="analytics">Analytics</option>
          <option value="social">Social</option>
          <option value="communication">Communication</option>
          <option value="other">Other</option>
        </select>
        <select id="vendor-department-filter" class="form-input text-xs" style="width:auto;padding:6px 12px;" onchange="updateFiltersAndLoad()">
          <option value="">All Departments</option>
          <!-- Populated dynamically from API -->
        </select>
        <input type="text" id="vendor-search-input" class="form-input text-xs" style="width:200px;padding:6px 12px;" placeholder="Search vendors..." onkeyup="updateFiltersAndLoad()">
      </div>

      <!-- Vendors Table -->
      <div class="card">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-[#2d3148]">
                <th class="text-left px-5 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('name')">
                  Name <span id="sort-name" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('category')">
                  Category <span id="sort-category" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('plan')">
                  Plan <span id="sort-plan" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('cost_monthly')">
                  Cost/mo <span id="sort-cost_monthly" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('owner')">
                  Owner <span id="sort-owner" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('department')">
                  Department <span id="sort-department" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
                <th class="text-left px-3 py-3 cursor-pointer hover:bg-[#252a40] transition-colors" onclick="sortVendorsTable('status')">
                  Status <span id="sort-status" class="ml-1 text-[#64748b]">‚Üï</span>
                </th>
              </tr>
            </thead>
            <tbody id="vendors-table-body">
              <tr>
                <td colspan="7" class="px-5 py-8 text-center text-[#64748b]">Loading vendors...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Vendor Detail Panel -->
      <div class="vendor-panel" id="vendor-panel">
        <button class="close-btn" onclick="closeVendorPanel()">‚úï</button>
        <div id="vendor-panel-content"></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê Sync Status ‚ïê‚ïê‚ïê -->
    <section id="sec-sync" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">üîÑ Sync Status</h2>
        <button onclick="syncAll()" id="sync-all-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
          <span id="sync-spinner" class="hidden animate-spin">‚ü≥</span>
          Sync All Now
        </button>
      </div>
      <p class="text-[#94a3b8] mb-6">Shows the last sync time for each data source. The scheduler runs every 2 hours during business hours (07:00‚Äì19:00 UTC) and a full action-items sync daily at 07:00 UTC.</p>
      <div id="sync-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div class="mt-6 card p-4">
        <h3 class="text-sm font-semibold text-[#94a3b8] uppercase tracking-wider mb-3">VP Push Endpoints (API Reference)</h3>
        <div class="space-y-3 text-sm">
          <div class="p-3 bg-[#252a40] rounded-lg">
            <code class="text-blue-400">POST /api/kpis/push</code>
            <p class="text-[#94a3b8] mt-1">Push KPI snapshots. Body: <code>{ department, kpi_name, target, current_value, status, trend }</code></p>
          </div>
          <div class="p-3 bg-[#252a40] rounded-lg">
            <code class="text-blue-400">POST /api/tasks/sync</code>
            <p class="text-[#94a3b8] mt-1">Sync tasks from VP reports. Body (single or array): <code>{ title, department, owner, status, priority }</code></p>
          </div>
          <div class="p-3 bg-[#252a40] rounded-lg">
            <code class="text-blue-400">POST /api/sync/all</code>
            <p class="text-[#94a3b8] mt-1">Trigger a full sync of all sources (CRM, action items, KPIs, tasks).</p>
          </div>
          <div class="p-3 bg-[#252a40] rounded-lg">
            <code class="text-blue-400">GET /api/sync/status</code>
            <p class="text-[#94a3b8] mt-1">Returns last sync times and status for all data sources.</p>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Task Modal -->
<div id="task-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
  <div class="modal-content p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold" id="modal-title">New Task</h3>
      <button onclick="closeTaskModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <form id="task-form" onsubmit="saveTask(event)" class="space-y-4">
      <input type="hidden" id="task-id">
      <div><label class="form-label">Title</label><input id="task-title" class="form-input" required></div>
      <div><label class="form-label">Description</label><textarea id="task-desc" class="form-input h-20"></textarea></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="form-label">Department</label><select id="task-dept" class="form-input"><option>Operations</option><option>Research & Intelligence</option><option>Marketing & Content</option><option>Sales & Business Dev</option><option>Engineering & Product</option><option>Documentation & KB</option><option>Design & Brand</option><option>Mission Control</option></select></div>
        <div><label class="form-label">Owner</label><input id="task-owner" class="form-input" placeholder="e.g. Viktor"></div>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div><label class="form-label">Priority</label><select id="task-priority" class="form-input"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
        <div><label class="form-label">Status</label><select id="task-status" class="form-input"><option value="backlog">Backlog</option><option value="in_progress">In Progress</option><option value="review">Review</option><option value="done">Done</option></select></div>
        <div><label class="form-label">Due Date</label><input type="date" id="task-due" class="form-input"></div>
      </div>
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="task-blocker" class="rounded"><span class="text-[#94a3b8]">Blocker</span></label>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeTaskModal()" class="btn-ghost text-sm">Cancel</button>
        <button type="submit" class="btn-primary text-sm">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Deal Modal -->
<div id="deal-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
  <div class="modal-content p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold" id="deal-modal-title">New Deal</h3>
      <button onclick="closeDealModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <form id="deal-form" onsubmit="saveDeal(event)" class="space-y-4">
      <input type="hidden" id="deal-id">
      <div class="grid grid-cols-2 gap-4">
        <div><label class="form-label">Company</label><input id="deal-company" class="form-input" required></div>
        <div><label class="form-label">Contact</label><input id="deal-contact" class="form-input"></div>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div><label class="form-label">Stage</label><select id="deal-stage" class="form-input"><option value="lead">Lead</option><option value="qualified">Qualified</option><option value="opportunity">Opportunity</option><option value="proposal">Proposal</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
        <div><label class="form-label">Value ($)</label><input type="number" id="deal-value" class="form-input" step="1000" value="0"></div>
        <div><label class="form-label">Expected Close</label><input type="date" id="deal-close" class="form-input"></div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="form-label">Owner</label><input id="deal-owner" class="form-input"></div>
        <div><label class="form-label">Source</label><input id="deal-source" class="form-input" placeholder="e.g. inbound, referral"></div>
      </div>
      <div><label class="form-label">Products (comma-separated)</label><input id="deal-products" class="form-input" placeholder="e.g. CDN, Live Encoding, Analytics"></div>
      <div><label class="form-label">Notes</label><textarea id="deal-notes" class="form-input h-16"></textarea></div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeDealModal()" class="btn-ghost text-sm">Cancel</button>
        <button type="submit" class="btn-primary text-sm">Save Deal</button>
      </div>
    </form>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê
let DATA={}, TASKS=[], ACTIONS=[], STATS={}, KPIS=[], GANTT={tasks:[],milestones:[]}, PIPELINE={};
let currentBlockerFilter='all', selectedKPIDept='', pipelineView='board';

// ‚ïê‚ïê‚ïê WebSocket (live updates) ‚ïê‚ïê‚ïê
let ws;
function connectWS() {
  const proto = location.protocol==='https:'?'wss':'ws';
  ws = new WebSocket(`${proto}://${location.host}`);
  ws.onopen = () => { document.getElementById('ws-status').innerHTML = '<span class="status-icon bg-green-500 pulse inline-block mr-1"></span> Live'; };
  ws.onclose = () => { document.getElementById('ws-status').innerHTML = '<span class="status-icon bg-red-500 inline-block mr-1"></span> Disconnected'; setTimeout(connectWS, 3000); };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type.startsWith('task')) loadTasks();
    if (msg.type.startsWith('action')) { loadActionCounts(); refreshActionItemsInPlace(); if (panelActionId) refreshExpandedThread(panelActionId); }
    if (msg.type.startsWith('deal') || msg.type.startsWith('crm')) loadPipeline();
    if (msg.type.startsWith('post')) loadCalendar();
    if (msg.type.startsWith('visual_request')) { if (!document.getElementById('sec-visual-requests').classList.contains('hidden')) loadVisualRequests(); if (vrDetailId) openVRDetail(vrDetailId); }
    if (msg.type.startsWith('research_request')) { if (!document.getElementById('sec-research-requests').classList.contains('hidden')) loadResearchRequests(); if (rrDetailId) openRRDetail(rrDetailId); }
    if (msg.type.startsWith('agent')) { if (!document.getElementById('sec-org').classList.contains('hidden')) loadOrgData(); }
  };
}
connectWS();

// ‚ïê‚ïê‚ïê API helper ‚ïê‚ïê‚ïê
async function api(url, opts) { const r = await fetch(url, { headers: {'Content-Type':'application/json'}, ...opts }); return r.json(); }

// ‚ïê‚ïê‚ïê Load all data ‚ïê‚ïê‚ïê
async function loadAll() {
  let actionsData;
  [DATA, TASKS, actionsData, STATS, KPIS, GANTT] = await Promise.all([
    api('/api/data'), api('/api/tasks'), api('/api/actions?limit=999'), api('/api/stats'), api('/api/kpis'), api('/api/gantt'),
  ]);
  ACTIONS = actionsData.items || actionsData;
  loadPipeline();
  render();
}
async function loadTasks() { TASKS = await api('/api/tasks'); STATS = await api('/api/stats'); GANTT = await api('/api/gantt'); renderKanban(); renderCommandCenter(); renderGantt(); }
async function loadActionsLegacy() { try { const data = await api('/api/actions?limit=999'); ACTIONS = data.items || data; } catch(e) { ACTIONS = []; } STATS = await api('/api/stats'); renderActions(); renderCommandCenter(); }
async function loadPipeline() { 
  try { 
    const stageFilter = document.getElementById('crm-stage-filter')?.value || '';
    
    if (stageFilter) {
      // Use deals endpoint for filtering and build pipeline client-side
      const deals = await api(`/api/crm/deals?stage=${stageFilter}`);
      
      // Build pipeline structure for filtered stage
      const stages = ['lead', 'qualified', 'opportunity', 'proposal', 'closed_won'];
      const pipeline = stages.map(s => {
        const stageDeals = s === stageFilter ? deals : [];
        const count = stageDeals.length;
        const value = stageDeals.reduce((sum, d) => sum + (d.value || 0), 0);
        return { stage: s, count, value, deals: stageDeals };
      });
      
      const totalValue = deals.reduce((sum, d) => sum + (d.value || 0), 0);
      const weights = { lead: 0.1, qualified: 0.25, opportunity: 0.5, proposal: 0.75, closed_won: 1.0 };
      const weightedValue = totalValue * (weights[stageFilter] || 0);
      
      // Cross-sell tracking for filtered deals
      const crossSell = [];
      for (const d of deals) {
        try {
          const products = JSON.parse(d.cross_sell_products || '[]');
          if (products.length > 1) crossSell.push({ company: d.company_name, products, value: d.value });
        } catch(e) {}
      }
      
      PIPELINE = { pipeline, totalValue, weightedValue, crossSell, totalDeals: deals.length };
    } else {
      // Use full pipeline endpoint when no filter
      PIPELINE = await api('/api/crm/pipeline');
    }
  } catch(e) { 
    PIPELINE = {pipeline:[],totalValue:0,weightedValue:0,crossSell:[],totalDeals:0}; 
  } 
  renderPipeline(); 
  renderCommandPipeline(); 
}

// ‚ïê‚ïê‚ïê Utility ‚ïê‚ïê‚ïê
function statusBadge(s) {
  let c='bg-slate-500';
  if(s.includes('üü¢')||/active|healthy|delivering|complete|live|on track/i.test(s))c='bg-green-500';
  else if(s.includes('üü°')||/degraded|pending|setting|migrating/i.test(s))c='bg-yellow-500';
  else if(s.includes('üî¥')||/critical|blocked|down/i.test(s))c='bg-red-500';
  return `<span class="inline-flex items-center gap-1.5"><span class="status-icon ${c}"></span><span class="text-xs">${s}</span></span>`;
}
function priorityBadge(p){const m={critical:'üî¥',high:'üü†',medium:'üü°',low:'üü¢'};return `<span class="text-xs">${m[p]||'‚ö™'} ${p}</span>`;}
function deptClass(d){if(d.includes('Research'))return'dept-ri';if(d.includes('Marketing'))return'dept-mc';if(d.includes('Sales'))return'dept-sb';if(d.includes('Engineering'))return'dept-ep';if(d.includes('Documentation'))return'dept-dk';if(d.includes('Design'))return'dept-db';return'dept-ops';}
function deptColor(d){if(d.includes('Research'))return'#8b5cf6';if(d.includes('Marketing'))return'#06b6d4';if(d.includes('Sales'))return'#22c55e';if(d.includes('Engineering'))return'#3b82f6';if(d.includes('Design'))return'#ec4899';return'#64748b';}
function daysAgo(ds){if(!ds)return'';const d=new Date(ds),n=new Date(),df=Math.floor((n-d)/864e5);if(df===0)return'today';if(df===1)return'1d ago';return df+'d ago';}
function timeAgo(ds){if(!ds)return'';const d=new Date(ds.endsWith('Z')?ds:ds+'Z'),n=new Date(),m=Math.floor((n-d)/6e4);if(m<0)return'just now';if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago';}
function kpiStatusColor(s){if(/on track|green|üü¢|healthy/i.test(s))return'#22c55e';if(/at risk|amber|yellow|üü°/i.test(s))return'#eab308';if(/behind|red|üî¥|critical/i.test(s))return'#ef4444';return'#64748b';}
function fmtMoney(v){if(v>=1e6)return'$'+(v/1e6).toFixed(1)+'M';if(v>=1e3)return'$'+(v/1e3).toFixed(0)+'K';return'$'+v;}
const stageLabels={lead:'Leads',qualified:'Qualified',opportunity:'Opportunity',proposal:'Proposal',closed_won:'Closed Won',closed_lost:'Closed Lost'};
const stageColors={lead:'#3b82f6',qualified:'#06b6d4',opportunity:'#8b5cf6',proposal:'#eab308',closed_won:'#22c55e',closed_lost:'#ef4444'};

function toggleMobileMenu(){document.getElementById('sidebar').classList.toggle('mobile-open');}

// ‚ïê‚ïê‚ïê Render all ‚ïê‚ïê‚ïê
function render() {
  document.getElementById('update-time').textContent=`Updated: ${DATA.lastUpdated||'Unknown'}`;
  renderCommandCenter();renderKanban();renderGantt();renderDepartments();renderKPIs();renderActions();loadActionCounts();loadActionItems();
  renderPriorities();renderInitiatives();renderReporting();renderRevenue();renderFunnel();renderReports();renderPipeline();renderCommandPipeline();
}

// ‚ïê‚ïê‚ïê Command Center ‚ïê‚ïê‚ïê
function renderCommandCenter() {
  document.getElementById('cmd-time').textContent = new Date().toUTCString();
  const alerts=[];
  if(STATS.blockers>0)alerts.push({type:'red',text:`${STATS.blockers} active blocker${STATS.blockers>1?'s':''}`});
  if(STATS.overdue>0)alerts.push({type:'yellow',text:`${STATS.overdue} overdue task${STATS.overdue>1?'s':''}`});
  if(STATS.criticalActions>0)alerts.push({type:'red',text:`${STATS.criticalActions} critical action item${STATS.criticalActions>1?'s':''}`});
  if(!alerts.length)alerts.push({type:'green',text:'All systems nominal'});
  document.getElementById('alert-bar').innerHTML=`<div class="flex gap-3 flex-wrap">${alerts.map(a=>`<div class="card px-4 py-2 border-l-4 alert-${a.type} text-sm flex items-center gap-2"><span class="status-icon bg-${a.type==='red'?'red':a.type==='yellow'?'yellow':'green'}-500 ${a.type!=='green'?'pulse':''}"></span>${a.text}</div>`).join('')}</div>`;

  const ts=STATS.tasksByStatus||{};
  const cards=[
    {label:'Total Tasks',value:STATS.totalTasks||0,sub:`${ts.done||0} completed`,color:'#3b82f6'},
    {label:'In Progress',value:ts.in_progress||0,sub:`${ts.review||0} in review`,color:'#06b6d4'},
    {label:'Blockers',value:STATS.blockers||0,sub:`${STATS.overdue||0} overdue`,color:STATS.blockers>0?'#ef4444':'#22c55e'},
    {label:'Action Items',value:STATS.openActions||0,sub:`${STATS.criticalActions||0} critical`,color:STATS.criticalActions>0?'#eab308':'#22c55e'},
  ];
  document.getElementById('stat-cards').innerHTML=cards.map(c=>`<div class="card p-4"><div class="text-xs text-[#94a3b8] mb-1">${c.label}</div><div class="text-2xl font-bold" style="color:${c.color}">${c.value}</div><div class="text-xs text-[#64748b] mt-1">${c.sub}</div></div>`).join('');

  const todayDue=STATS.todayDue||[],overdue=(STATS.overdueTasks||[]).slice(0,5);
  let ah='';
  if(overdue.length){ah+=`<div class="mb-3"><span class="text-xs font-semibold text-red-400">‚ö†Ô∏è OVERDUE</span></div>`;ah+=overdue.map(t=>`<div class="flex justify-between items-center py-1.5 border-b border-[#2d3148]"><span class="text-sm">${t.title}</span><span class="text-xs text-red-400">${t.due_date}</span></div>`).join('');}
  if(todayDue.length){ah+=`<div class="mb-3 ${overdue.length?'mt-4':''}"><span class="text-xs font-semibold text-blue-400">üìÖ DUE TODAY</span></div>`;ah+=todayDue.map(t=>`<div class="flex justify-between items-center py-1.5 border-b border-[#2d3148]"><span class="text-sm">${t.title}</span><span class="text-xs">${priorityBadge(t.priority)}</span></div>`).join('');}
  if(!ah)ah='<p class="text-sm text-[#64748b]">No items due today ‚úì</p>';
  document.getElementById('today-agenda').innerHTML=ah;

  const act=STATS.recentActivity||[];
  document.getElementById('recent-activity').innerHTML=act.length===0?'<p class="text-sm text-[#64748b]">No recent activity</p>':act.map(a=>`<div class="flex justify-between items-start py-1.5 border-b border-[#2d3148]"><span class="text-sm text-[#e2e8f0]">${a.message}</span><span class="text-xs text-[#64748b] shrink-0 ml-2">${timeAgo(a.created_at)}</span></div>`).join('');

  document.getElementById('org-table').innerHTML=(DATA.org||[]).map(d=>`<tr class="cursor-pointer" onclick="navigate('departments');showDeptDetail('${d.dept}')"><td class="px-5 py-3 font-medium">${d.dept}</td><td class="px-3 py-3">${d.vp}</td><td class="px-3 py-3">${statusBadge(d.status)}</td><td class="px-3 py-3 text-[#94a3b8]">${d.agents}</td><td class="px-3 py-3">${statusBadge(d.health)}</td><td class="px-3 py-3 text-[#64748b]">${d.lastUpdate}</td></tr>`).join('');
}

// Command center pipeline summary
let cmdPipelineChart=null;
function renderCommandPipeline() {
  const p=PIPELINE;
  if(!p.pipeline)return;
  const stages=p.pipeline||[];
  document.getElementById('cmd-pipeline-summary').innerHTML=`
    <div class="grid grid-cols-2 gap-3">
      <div><div class="text-xs text-[#94a3b8]">Total Pipeline</div><div class="text-xl font-bold text-[#3b82f6]">${fmtMoney(p.totalValue||0)}</div></div>
      <div><div class="text-xs text-[#94a3b8]">Weighted Value</div><div class="text-xl font-bold text-[#8b5cf6]">${fmtMoney(p.weightedValue||0)}</div></div>
      <div><div class="text-xs text-[#94a3b8]">Active Deals</div><div class="text-xl font-bold text-[#e2e8f0]">${p.totalDeals||0}</div></div>
      <div><div class="text-xs text-[#94a3b8]">Cross-Sell</div><div class="text-xl font-bold text-[#22c55e]">${(p.crossSell||[]).length}</div></div>
    </div>
    <div class="mt-4 space-y-2">${stages.map(s=>{
      const maxV=Math.max(...stages.map(x=>x.value),1);
      const pct=Math.max(5,(s.value/maxV)*100);
      return `<div class="flex items-center gap-3"><span class="text-xs text-[#94a3b8] w-24 shrink-0">${stageLabels[s.stage]||s.stage}</span><div class="flex-1 h-5 bg-[#0f1117] rounded overflow-hidden"><div class="h-full rounded" style="width:${pct}%;background:${stageColors[s.stage]};transition:width 0.5s;"></div></div><span class="text-xs font-bold w-16 text-right">${fmtMoney(s.value)}</span></div>`;
    }).join('')}</div>`;

  // Mini chart
  const canvas=document.getElementById('cmd-pipeline-chart');
  if(!canvas||!stages.length)return;
  if(cmdPipelineChart)cmdPipelineChart.destroy();
  cmdPipelineChart=new Chart(canvas,{
    type:'doughnut',
    data:{
      labels:stages.map(s=>stageLabels[s.stage]||s.stage),
      datasets:[{data:stages.map(s=>s.value||0),backgroundColor:stages.map(s=>stageColors[s.stage]),borderWidth:0}]
    },
    options:{responsive:true,plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{size:11,family:'Inter'},padding:8}}},cutout:'60%'}
  });
}

// ‚ïê‚ïê‚ïê Kanban ‚ïê‚ïê‚ïê
let sortables=[];
function renderKanban(){
  const df=document.getElementById('kanban-filter-dept')?.value||'';
  const pf=document.getElementById('kanban-filter-priority')?.value||'';
  let filtered=TASKS;
  if(df)filtered=filtered.filter(t=>t.department===df);
  if(pf)filtered=filtered.filter(t=>t.priority===pf);
  const cols=['backlog','in_progress','review','done'];
  for(const s of cols){
    const tasks=filtered.filter(t=>t.status===s).sort((a,b)=>a.position-b.position);
    const el=document.getElementById(`col-${s}`);
    document.getElementById(`count-${s}`).textContent=tasks.length;
    el.innerHTML=tasks.map(t=>`<div class="kanban-card ${deptClass(t.department)} ${t.is_blocker?'priority-critical':''}" data-id="${t.id}" ondblclick="editTask(${t.id})"><div class="flex justify-between items-start mb-1"><span class="text-sm font-medium leading-tight">${t.title}</span>${t.is_blocker?'<span class="text-xs text-red-400">üö´</span>':''}</div><div class="flex justify-between items-center mt-2"><span class="text-xs text-[#64748b]">${t.department.split(' ')[0]}</span><div class="flex items-center gap-2">${t.owner?`<span class="text-xs text-[#94a3b8]">${t.owner}</span>`:''}${priorityBadge(t.priority)}</div></div>${t.due_date?`<div class="text-xs mt-1 ${new Date(t.due_date)<new Date()&&t.status!=='done'?'text-red-400':'text-[#64748b]'}">üìÖ ${t.due_date}</div>`:''}${t.action_item_id?`<button onclick="event.stopPropagation();goToActionItem(${t.action_item_id})" class="mt-2 w-full text-xs px-2 py-1.5 rounded-md bg-[#1E3A5F] text-blue-300 hover:bg-[#264a73] transition-colors flex items-center justify-center gap-1" title="Go to linked action item">üìù Go to Action Item</button>`:''}</div>`).join('');
  }
  sortables.forEach(s=>s.destroy());sortables=[];
  for(const s of cols){
    sortables.push(new Sortable(document.getElementById(`col-${s}`),{group:'kanban',animation:150,ghostClass:'sortable-ghost',dragClass:'sortable-drag',onEnd:async(evt)=>{const items=[];evt.to.querySelectorAll('.kanban-card').forEach((c,i)=>items.push({id:+c.dataset.id,status:evt.to.dataset.status,position:i}));if(evt.from!==evt.to){evt.from.querySelectorAll('.kanban-card').forEach((c,i)=>items.push({id:+c.dataset.id,status:evt.from.dataset.status,position:i}));}await api('/api/tasks/reorder',{method:'POST',body:JSON.stringify({items})});loadTasks();}}));
  }
}
document.getElementById('kanban-filter-dept')?.addEventListener('change', function() {
  updateKanbanURL();
  renderKanban();
});
document.getElementById('kanban-filter-priority')?.addEventListener('change', function() {
  updateKanbanURL();
  renderKanban();
});

// ‚ïê‚ïê‚ïê Task Modal ‚ïê‚ïê‚ïê
function openTaskModal(task){
  document.getElementById('task-modal').classList.remove('hidden');
  document.getElementById('modal-title').textContent=task?'Edit Task':'New Task';
  document.getElementById('task-id').value=task?task.id:'';
  document.getElementById('task-title').value=task?task.title:'';
  document.getElementById('task-desc').value=task?task.description:'';
  document.getElementById('task-dept').value=task?task.department:'Operations';
  document.getElementById('task-owner').value=task?task.owner:'';
  document.getElementById('task-priority').value=task?task.priority:'medium';
  document.getElementById('task-status').value=task?task.status:'backlog';
  document.getElementById('task-due').value=task?(task.due_date||''):'';
  document.getElementById('task-blocker').checked=task?!!task.is_blocker:false;
}
function closeTaskModal(){document.getElementById('task-modal').classList.add('hidden');}
function editTask(id){const t=TASKS.find(t=>t.id===id);if(t)openTaskModal(t);}
async function saveTask(e){e.preventDefault();const id=document.getElementById('task-id').value;const d={title:document.getElementById('task-title').value,description:document.getElementById('task-desc').value,department:document.getElementById('task-dept').value,owner:document.getElementById('task-owner').value,priority:document.getElementById('task-priority').value,status:document.getElementById('task-status').value,due_date:document.getElementById('task-due').value||null,is_blocker:document.getElementById('task-blocker').checked};if(id)await api(`/api/tasks/${id}`,{method:'PUT',body:JSON.stringify(d)});else await api('/api/tasks',{method:'POST',body:JSON.stringify(d)});closeTaskModal();loadTasks();}

// ‚ïê‚ïê‚ïê CRM Pipeline ‚ïê‚ïê‚ïê
let pipelineValueChart=null;

function renderPipeline(){
  const p=PIPELINE;
  if(!p.pipeline)return;
  const stages=p.pipeline||[];

  // Stats cards
  document.getElementById('pipeline-stats').innerHTML=`
    <div class="card p-4"><div class="text-xs text-[#94a3b8] mb-1">Total Pipeline</div><div class="text-2xl font-bold text-[#3b82f6]">${fmtMoney(p.totalValue||0)}</div><div class="text-xs text-[#64748b] mt-1">${p.totalDeals||0} deals</div></div>
    <div class="card p-4"><div class="text-xs text-[#94a3b8] mb-1">Weighted Value</div><div class="text-2xl font-bold text-[#8b5cf6]">${fmtMoney(p.weightedValue||0)}</div><div class="text-xs text-[#64748b] mt-1">probability-adjusted</div></div>
    <div class="card p-4"><div class="text-xs text-[#94a3b8] mb-1">Avg Deal Size</div><div class="text-2xl font-bold text-[#06b6d4]">${p.totalDeals?fmtMoney(Math.round((p.totalValue||0)/(p.totalDeals||1))):'$0'}</div><div class="text-xs text-[#64748b] mt-1">across pipeline</div></div>
    <div class="card p-4"><div class="text-xs text-[#94a3b8] mb-1">Cross-Sell Opps</div><div class="text-2xl font-bold text-[#22c55e]">${(p.crossSell||[]).length}</div><div class="text-xs text-[#64748b] mt-1">multi-product deals</div></div>
  `;

  // Funnel
  const maxV=Math.max(...stages.map(s=>s.value),1);
  document.getElementById('pipeline-funnel').innerHTML=stages.map((s,i)=>{
    const pct=Math.max(25,(s.value/maxV)*100);
    return `<div class="funnel-stage mb-3">
      <div class="flex justify-between text-xs text-[#94a3b8] mb-1">
        <span>${stageLabels[s.stage]||s.stage}</span>
        <span class="font-bold text-[#e2e8f0]">${s.count} deals ¬∑ ${fmtMoney(s.value)}</span>
      </div>
      <div class="h-10 bg-[#0f1117] rounded-lg overflow-hidden" style="width:${pct}%;margin:0 auto 0 0;">
        <div class="h-full funnel-bar flex items-center justify-center text-xs font-bold text-white" style="background:${stageColors[s.stage]};width:100%;">${fmtMoney(s.value)}</div>
      </div>
    </div>`;
  }).join('');

  // Value chart
  const canvas=document.getElementById('pipeline-value-chart');
  if(canvas&&stages.length){
    if(pipelineValueChart)pipelineValueChart.destroy();
    pipelineValueChart=new Chart(canvas,{
      type:'bar',
      data:{
        labels:stages.map(s=>stageLabels[s.stage]||s.stage),
        datasets:[
          {label:'Pipeline Value',data:stages.map(s=>s.value||0),backgroundColor:stages.map(s=>stageColors[s.stage]+'88'),borderColor:stages.map(s=>stageColors[s.stage]),borderWidth:1,borderRadius:6},
        ]
      },
      options:{responsive:true,plugins:{legend:{display:false}},scales:{
        y:{grid:{color:'#2d3148'},ticks:{color:'#64748b',callback:v=>fmtMoney(v)}},
        x:{grid:{display:false},ticks:{color:'#94a3b8',font:{size:11,family:'Inter'}}}
      }}
    });
  }

  // Board/Table
  if(pipelineView==='board')renderPipelineBoard(stages);
  else renderPipelineTable(stages);

  // Cross-sell
  const cs=p.crossSell||[];
  document.getElementById('cross-sell-list').innerHTML=cs.length===0
    ?'<p class="text-sm text-[#64748b]">No cross-sell opportunities detected</p>'
    :`<table class="w-full text-sm"><thead><tr class="border-b border-[#2d3148]"><th class="text-left px-4 py-2">Company</th><th class="text-left px-4 py-2">Products</th><th class="text-left px-4 py-2">Value</th></tr></thead><tbody>${cs.map(c=>`<tr><td class="px-4 py-2 font-medium">${c.company}</td><td class="px-4 py-2">${c.products.map(p=>`<span class="inline-block text-xs px-2 py-0.5 rounded bg-[#252a40] text-[#94a3b8] mr-1 mb-1">${p}</span>`).join('')}</td><td class="px-4 py-2 text-[#22c55e] font-bold">${fmtMoney(c.value)}</td></tr>`).join('')}</tbody></table>`;
}

function renderPipelineBoard(stages){
  const stageOrder=['lead','qualified','opportunity','proposal','closed_won'];
  document.getElementById('pipeline-board').innerHTML=`<div class="flex gap-4 pipeline-scroll" style="min-width:max-content;">${stageOrder.map(s=>{
    const st=stages.find(x=>x.stage===s)||{stage:s,count:0,value:0,deals:[]};
    return `<div class="pipeline-col" style="min-width:220px;flex:1;">
      <div class="flex items-center gap-2 mb-3">
        <span class="w-3 h-3 rounded-full" style="background:${stageColors[s]}"></span>
        <span class="text-sm font-semibold">${stageLabels[s]}</span>
        <span class="text-xs text-[#64748b]">${st.count}</span>
        <span class="text-xs text-[#64748b] ml-auto">${fmtMoney(st.value)}</span>
      </div>
      <div class="space-y-2">${(st.deals||[]).map(d=>`
        <div class="deal-card" ondblclick="editDeal(${d.id})">
          <div class="text-sm font-medium mb-1">${d.company_name}</div>
          <div class="text-xs text-[#94a3b8]">${d.contact_name||''}</div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-sm font-bold" style="color:${stageColors[s]}">${fmtMoney(d.value)}</span>
            <span class="text-xs text-[#64748b]">${d.owner||''}</span>
          </div>
          ${d.expected_close?`<div class="text-xs text-[#64748b] mt-1">üìÖ ${d.expected_close}</div>`:''}
          ${(()=>{try{const prods=JSON.parse(d.cross_sell_products||'[]');return prods.length?`<div class="mt-2 flex flex-wrap gap-1">${prods.map(p=>`<span class="text-xs px-1.5 py-0.5 rounded bg-[#252a40] text-[#94a3b8]">${p}</span>`).join('')}</div>`:'';}catch(e){return'';}})()}
        </div>`).join('')}
      </div>
    </div>`;
  }).join('')}</div>`;
  document.getElementById('pipeline-table').classList.add('hidden');
  document.getElementById('pipeline-board').classList.remove('hidden');
}

function renderPipelineTable(stages){
  const allDeals=(stages||[]).flatMap(s=>(s.deals||[]).map(d=>({...d,_stage:s.stage})));
  document.getElementById('pipeline-table').innerHTML=`<table class="w-full text-sm"><thead><tr class="border-b border-[#2d3148]">
    <th class="text-left px-4 py-3">Company</th><th class="text-left px-4 py-3">Contact</th><th class="text-left px-4 py-3">Stage</th><th class="text-left px-4 py-3">Value</th><th class="text-left px-4 py-3">Owner</th><th class="text-left px-4 py-3">Expected Close</th><th class="text-left px-4 py-3">Products</th>
  </tr></thead><tbody>${allDeals.map(d=>`<tr class="cursor-pointer" ondblclick="editDeal(${d.id})">
    <td class="px-4 py-2 font-medium">${d.company_name}</td>
    <td class="px-4 py-2 text-[#94a3b8]">${d.contact_name||'‚Äî'}</td>
    <td class="px-4 py-2"><span class="text-xs px-2 py-0.5 rounded" style="background:${stageColors[d.stage]}22;color:${stageColors[d.stage]}">${stageLabels[d.stage]||d.stage}</span></td>
    <td class="px-4 py-2 font-bold" style="color:${stageColors[d.stage]}">${fmtMoney(d.value)}</td>
    <td class="px-4 py-2 text-[#94a3b8]">${d.owner||'‚Äî'}</td>
    <td class="px-4 py-2 text-[#64748b]">${d.expected_close||'‚Äî'}</td>
    <td class="px-4 py-2">${(()=>{try{return JSON.parse(d.cross_sell_products||'[]').join(', ');}catch(e){return'‚Äî';}})()}</td>
  </tr>`).join('')}</tbody></table>`;
  document.getElementById('pipeline-board').classList.add('hidden');
  document.getElementById('pipeline-table').classList.remove('hidden');
}

function setPipelineView(v){
  pipelineView=v;
  document.querySelectorAll('.pipeline-view-btn').forEach(b=>{b.className=`text-xs px-3 py-1 rounded ${b.dataset.view===v?'tab-active':'tab-inactive'} pipeline-view-btn`;});
  renderPipeline();
}

// Deal modal
function openDealModal(deal){
  document.getElementById('deal-modal').classList.remove('hidden');
  document.getElementById('deal-modal-title').textContent=deal?'Edit Deal':'New Deal';
  document.getElementById('deal-id').value=deal?deal.id:'';
  document.getElementById('deal-company').value=deal?deal.company_name:'';
  document.getElementById('deal-contact').value=deal?deal.contact_name:'';
  document.getElementById('deal-stage').value=deal?deal.stage:'lead';
  document.getElementById('deal-value').value=deal?deal.value:0;
  document.getElementById('deal-close').value=deal?(deal.expected_close||''):'';
  document.getElementById('deal-owner').value=deal?deal.owner:'';
  document.getElementById('deal-source').value=deal?deal.source:'';
  document.getElementById('deal-notes').value=deal?deal.notes:'';
  try{document.getElementById('deal-products').value=deal?JSON.parse(deal.cross_sell_products||'[]').join(', '):'';}catch(e){document.getElementById('deal-products').value='';}
}
function closeDealModal(){document.getElementById('deal-modal').classList.add('hidden');}
function editDeal(id){
  // Find deal in pipeline data
  const allDeals=(PIPELINE.pipeline||[]).flatMap(s=>(s.deals||[]));
  const deal=allDeals.find(d=>d.id===id);
  if(deal)openDealModal(deal);
}
async function saveDeal(e){
  e.preventDefault();
  const id=document.getElementById('deal-id').value;
  const products=document.getElementById('deal-products').value.split(',').map(s=>s.trim()).filter(Boolean);
  const d={
    company_name:document.getElementById('deal-company').value,
    contact_name:document.getElementById('deal-contact').value,
    stage:document.getElementById('deal-stage').value,
    value:parseFloat(document.getElementById('deal-value').value)||0,
    expected_close:document.getElementById('deal-close').value||null,
    owner:document.getElementById('deal-owner').value,
    source:document.getElementById('deal-source').value,
    notes:document.getElementById('deal-notes').value,
    cross_sell_products:products,
  };
  if(id)await api(`/api/crm/deals/${id}`,{method:'PUT',body:JSON.stringify(d)});
  else await api('/api/crm/deals',{method:'POST',body:JSON.stringify(d)});
  closeDealModal();loadPipeline();
}
async function syncCRM(){await api('/api/crm/sync');loadPipeline();}

// ‚ïê‚ïê‚ïê Gantt Timeline (Overhauled) ‚ïê‚ïê‚ïê
let tlZoom = 'week';
let tlCollapsed = {};
let tlDragState = null;

const DEPT_COLORS = {
  'Engineering & Product': '#3b82f6',
  'Research & Intelligence': '#8b5cf6',
  'Marketing & Content': '#f97316',
  'Sales & Business Dev': '#22c55e',
  'Design & Brand': '#ec4899',
  'Operations': '#64748b',
  'Documentation & KB': '#06b6d4',
  'Mission Control': '#6366f1',
};
function tlDeptColor(d) { for (const [k,v] of Object.entries(DEPT_COLORS)) { if (d && d.includes(k.split(' ')[0])) return v; } return '#64748b'; }

function setTlZoom(z) { tlZoom = z; document.querySelectorAll('.tl-zoom-btn').forEach(b => b.classList.toggle('active', b.dataset.zoom === z)); renderGantt(); }
function tlJumpToday() { document.getElementById('tl-date-from').value = ''; document.getElementById('tl-date-to').value = ''; renderGantt(); setTimeout(() => { const todayLine = document.querySelector('.tl-today-line'); if (todayLine) todayLine.scrollIntoView({ inline: 'center', behavior: 'smooth' }); }, 100); }

function renderTlSummary(tasks, milestones) {
  const now = new Date();
  const total = tasks.length;
  const done = tasks.filter(t => t.status === 'done').length;
  const overdue = tasks.filter(t => t.end_date && new Date(t.end_date) < now && t.status !== 'done').length;
  const totalProgress = total ? Math.round(tasks.reduce((s, t) => s + (t.progress || 0), 0) / total) : 0;
  const upcoming = milestones.filter(m => m.target_date && new Date(m.target_date) >= now && m.status !== 'completed').sort((a,b) => new Date(a.target_date) - new Date(b.target_date))[0];
  
  document.getElementById('tl-summary').innerHTML = `
    <div class="card" style="border-top:2px solid var(--accent)"><div class="text-xs text-[#94a3b8]">Overall Progress</div><div class="text-2xl font-bold text-[#3b82f6]">${totalProgress}%</div><div class="text-xs text-[#64748b]">${done}/${total} tasks complete</div><div style="height:4px;background:var(--bg);border-radius:2px;margin-top:6px;"><div style="height:100%;width:${totalProgress}%;background:var(--accent);border-radius:2px;transition:width 0.5s;"></div></div></div>
    <div class="card" style="border-top:2px solid ${overdue ? 'var(--red)' : 'var(--green)'}"><div class="text-xs text-[#94a3b8]">Overdue Tasks</div><div class="text-2xl font-bold ${overdue ? 'text-red-400' : 'text-green-400'}">${overdue}</div><div class="text-xs text-[#64748b]">${overdue ? 'need attention' : 'all on track'}</div></div>
    <div class="card" style="border-top:2px solid var(--purple)"><div class="text-xs text-[#94a3b8]">In Progress</div><div class="text-2xl font-bold text-purple-400">${tasks.filter(t=>t.status==='in_progress').length}</div><div class="text-xs text-[#64748b]">${tasks.filter(t=>t.status==='review').length} in review</div></div>
    <div class="card" style="border-top:2px solid var(--amber)"><div class="text-xs text-[#94a3b8]">Next Milestone</div><div class="text-sm font-bold text-amber-400">${upcoming ? upcoming.name : 'None'}</div><div class="text-xs text-[#64748b]">${upcoming ? upcoming.target_date : '‚Äî'}</div></div>
  `;
}

function populateAssigneeFilter(tasks) {
  const assignees = [...new Set(tasks.map(t => t.owner).filter(Boolean))].sort();
  const sel = document.getElementById('tl-filter-assignee');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All Assignees</option>' + assignees.map(a => `<option value="${a}">${a}</option>`).join('');
  sel.value = cur;
}

function renderGantt() {
  const container = document.getElementById('gantt-chart');
  const zoom = tlZoom;
  const deptFilter = document.getElementById('gantt-filter-dept')?.value || '';
  const statusFilter = document.getElementById('tl-filter-status')?.value || '';
  const assigneeFilter = document.getElementById('tl-filter-assignee')?.value || '';
  const searchQ = (document.getElementById('tl-search')?.value || '').toLowerCase();
  const groupBy = document.getElementById('tl-group-by')?.value || 'department';
  const dateFrom = document.getElementById('tl-date-from')?.value;
  const dateTo = document.getElementById('tl-date-to')?.value;

  let tasks = (GANTT.tasks || []).map(t => ({ ...t, depends_on: typeof t.depends_on === 'string' ? JSON.parse(t.depends_on || '[]') : (t.depends_on || []) }));
  let milestones = GANTT.milestones || [];

  // Filters
  if (deptFilter) { tasks = tasks.filter(t => t.department === deptFilter); milestones = milestones.filter(m => m.department === deptFilter); }
  const now = new Date();
  if (statusFilter === 'overdue') tasks = tasks.filter(t => t.end_date && new Date(t.end_date) < now && t.status !== 'done');
  else if (statusFilter) tasks = tasks.filter(t => t.status === statusFilter);
  if (assigneeFilter) tasks = tasks.filter(t => t.owner === assigneeFilter);
  if (searchQ) tasks = tasks.filter(t => t.title.toLowerCase().includes(searchQ) || (t.owner || '').toLowerCase().includes(searchQ));

  renderTlSummary(tasks, milestones);
  populateAssigneeFilter(GANTT.tasks || []);

  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const allDates = [today];
  tasks.forEach(t => { if (t.start_date) allDates.push(new Date(t.start_date)); if (t.end_date) allDates.push(new Date(t.end_date)); if (t.due_date) allDates.push(new Date(t.due_date)); if (t.created_at) allDates.push(new Date(t.created_at)); });
  milestones.forEach(m => { if (m.target_date) allDates.push(new Date(m.target_date)); });

  let rangeStart, rangeEnd;
  if (dateFrom && dateTo) { rangeStart = new Date(dateFrom); rangeEnd = new Date(dateTo); }
  else {
    if (zoom === 'day') { rangeStart = new Date(today); rangeStart.setDate(rangeStart.getDate() - 3); rangeEnd = new Date(today); rangeEnd.setDate(rangeEnd.getDate() + 14); }
    else if (zoom === 'week') { rangeStart = new Date(today); rangeStart.setDate(rangeStart.getDate() - 7); rangeEnd = new Date(today); rangeEnd.setDate(rangeEnd.getDate() + 60); }
    else if (zoom === 'month') { rangeStart = new Date(today); rangeStart.setMonth(rangeStart.getMonth() - 1); rangeEnd = new Date(today); rangeEnd.setMonth(rangeEnd.getMonth() + 6); }
    else { rangeStart = new Date(today); rangeStart.setMonth(rangeStart.getMonth() - 3); rangeEnd = new Date(today); rangeEnd.setMonth(rangeEnd.getMonth() + 12); }
    if (allDates.length > 1) { const minD = new Date(Math.min(...allDates.map(d => d.getTime()))), maxD = new Date(Math.max(...allDates.map(d => d.getTime()))); if (minD < rangeStart) rangeStart = new Date(minD.getTime() - 3 * 864e5); if (maxD > rangeEnd) rangeEnd = new Date(maxD.getTime() + 7 * 864e5); }
  }

  const totalDays = Math.ceil((rangeEnd - rangeStart) / 864e5);
  const dayWidth = zoom === 'day' ? 48 : zoom === 'week' ? 18 : zoom === 'month' ? 6 : 2.5;
  const chartWidth = totalDays * dayWidth;
  const labelWidth = 240;

  function dateToX(d) { return Math.round(((new Date(d) - rangeStart) / 864e5) * dayWidth); }

  // Header
  let headerCells = '';
  if (zoom === 'day') { for (let d = new Date(rangeStart); d < rangeEnd; d.setDate(d.getDate() + 1)) { const x = dateToX(d); const isTd = d.toDateString() === today.toDateString(); const isWe = d.getDay() === 0 || d.getDay() === 6; headerCells += `<div class="tl-header-cell" style="position:absolute;left:${x}px;width:${dayWidth}px;${isTd ? 'color:#ef4444;font-weight:700;' : ''}${isWe ? 'background:#151828;' : ''}">${d.getDate()}<br>${d.toLocaleString('en', { month: 'short' })}</div>`; } }
  else if (zoom === 'week') { for (let d = new Date(rangeStart); d < rangeEnd; d.setDate(d.getDate() + 7)) { const x = dateToX(d); headerCells += `<div class="tl-header-cell" style="position:absolute;left:${x}px;width:${7 * dayWidth}px;">${d.getDate()} ${d.toLocaleString('en', { month: 'short' })}</div>`; } }
  else if (zoom === 'month') { for (let d = new Date(rangeStart.getFullYear(), rangeStart.getMonth(), 1); d < rangeEnd; d.setMonth(d.getMonth() + 1)) { const x = dateToX(d); const dim = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate(); headerCells += `<div class="tl-header-cell" style="position:absolute;left:${x}px;width:${dim * dayWidth}px;">${d.toLocaleString('en', { month: 'short' })} ${d.getFullYear()}</div>`; } }
  else { for (let d = new Date(rangeStart.getFullYear(), Math.floor(rangeStart.getMonth() / 3) * 3, 1); d < rangeEnd; d.setMonth(d.getMonth() + 3)) { const x = dateToX(d); const qEnd = new Date(d.getFullYear(), d.getMonth() + 3, 0); const qDays = Math.ceil((qEnd - d) / 864e5); headerCells += `<div class="tl-header-cell" style="position:absolute;left:${x}px;width:${qDays * dayWidth}px;">Q${Math.floor(d.getMonth() / 3) + 1} ${d.getFullYear()}</div>`; } }

  if (!tasks.length && !milestones.length) { container.innerHTML = '<div class="p-12 text-center text-[#64748b]"><div class="text-3xl mb-2">üìä</div>No tasks to display on timeline.</div>'; return; }

  // Group tasks
  let groups = {};
  if (groupBy === 'department') { tasks.forEach(t => { const g = t.department || 'Unassigned'; if (!groups[g]) groups[g] = []; groups[g].push(t); }); }
  else if (groupBy === 'assignee') { tasks.forEach(t => { const g = t.owner || 'Unassigned'; if (!groups[g]) groups[g] = []; groups[g].push(t); }); }
  else if (groupBy === 'status') { const order = ['in_progress', 'review', 'backlog', 'done']; tasks.forEach(t => { const g = t.status || 'backlog'; if (!groups[g]) groups[g] = []; groups[g].push(t); }); groups = Object.fromEntries(order.filter(k => groups[k]).map(k => [k, groups[k]])); }
  else if (groupBy === 'priority') { const order = ['critical', 'high', 'medium', 'low']; tasks.forEach(t => { const g = t.priority || 'medium'; if (!groups[g]) groups[g] = []; groups[g].push(t); }); groups = Object.fromEntries(order.filter(k => groups[k]).map(k => [k, groups[k]])); }

  const todayX = dateToX(today);
  let rowsHTML = '';
  let rowIndex = 0;
  const taskRowMap = {}; // id -> rowIndex for dependency arrows

  // Milestones group
  if (milestones.length) {
    const gKey = '__milestones__';
    const isCollapsed = tlCollapsed[gKey];
    rowsHTML += `<div class="tl-swimlane" onclick="toggleTlGroup('${gKey}')"><span class="tl-collapse ${isCollapsed ? 'collapsed' : ''}">‚ñº</span> ‚óÜ Milestones (${milestones.length})</div>`;
    if (!isCollapsed) {
      for (const m of milestones) {
        if (!m.target_date) continue;
        const x = dateToX(m.target_date);
        rowsHTML += `<div class="tl-row"><div class="tl-label text-[#94a3b8] truncate" title="${m.name}">‚óÜ ${m.name}</div><div class="tl-bars" style="width:${chartWidth}px;"><div class="tl-milestone ${m.status === 'completed' ? 'completed' : ''}" style="left:${x - 9}px;" onclick="openTlMilestoneModal(${m.id})" onmouseenter="showTlTooltip(event,'<b>${m.name.replace(/'/g,'\\\'')}</b><br>Date: ${m.target_date}<br>Status: ${m.status}<br>${(m.description||'').substring(0,80).replace(/'/g,'\\\'')}')" onmouseleave="hideTlTooltip()"></div></div></div>`;
        rowIndex++;
      }
    }
  }

  // Task groups
  for (const [groupName, groupTasks] of Object.entries(groups)) {
    const gKey = 'g_' + groupName;
    const isCollapsed = tlCollapsed[gKey];
    const color = groupBy === 'department' ? tlDeptColor(groupName) : 'var(--accent)';
    const label = groupBy === 'status' ? { backlog: '‚¨ú Not Started', in_progress: 'üîµ In Progress', review: 'üü° Review', done: '‚úÖ Done' }[groupName] || groupName : groupBy === 'priority' ? { critical: 'üî¥ Critical', high: 'üü† High', medium: 'üü° Medium', low: 'üü¢ Low' }[groupName] || groupName : groupName;
    const groupDone = groupTasks.filter(t => t.status === 'done').length;
    const groupPct = groupTasks.length ? Math.round(groupTasks.reduce((s, t) => s + (t.progress || 0), 0) / groupTasks.length) : 0;

    rowsHTML += `<div class="tl-swimlane" style="border-left:3px solid ${color};" onclick="toggleTlGroup('${gKey}')"><span class="tl-collapse ${isCollapsed ? 'collapsed' : ''}">‚ñº</span> ${label} (${groupTasks.length}) <span class="text-xs text-[#64748b] ml-auto">${groupPct}% ¬∑ ${groupDone} done</span></div>`;

    if (!isCollapsed) {
      for (const t of groupTasks) {
        taskRowMap[t.id] = rowIndex;
        const startDate = t.start_date ? new Date(t.start_date) : (t.created_at ? new Date(t.created_at) : today);
        const endDate = t.end_date ? new Date(t.end_date) : (t.due_date ? new Date(t.due_date) : new Date(startDate.getTime() + 7 * 864e5));
        const x1 = Math.max(0, dateToX(startDate)), x2 = dateToX(endDate), w = Math.max(8, x2 - x1);
        const dColor = tlDeptColor(t.department);
        const isOverdue = t.end_date && new Date(t.end_date) < now && t.status !== 'done';
        const prog = t.progress || 0;
        const progW = Math.round((prog / 100) * w);
        const titleTrunc = zoom !== 'quarter' && w > 60 ? t.title.substring(0, Math.floor(w / 6)) : '';

        rowsHTML += `<div class="tl-row"><div class="tl-label truncate ${t.is_blocker ? 'text-red-400' : 'text-[#e2e8f0]'}" title="${t.title.replace(/"/g, '&quot;')}">${t.is_blocker ? 'üö´ ' : ''}${t.title}</div><div class="tl-bars" style="width:${chartWidth}px;" data-task-id="${t.id}"><div class="tl-bar status-${t.status} ${isOverdue ? 'overdue' : ''}" style="left:${x1}px;width:${w}px;background:${dColor};" data-task-id="${t.id}" onclick="openTlTaskModal(${t.id})" onmouseenter="showTlTooltip(event, tlTaskTooltip(${t.id}))" onmouseleave="hideTlTooltip()" onmousedown="startTlDrag(event,${t.id},'move')"><div class="tl-progress" style="width:${progW}px;"></div><span class="tl-bar-text">${titleTrunc}</span></div></div></div>`;
        rowIndex++;
      }
    }
  }

  // Dependency arrows (SVG overlay)
  let depSVG = '';
  const rowH = 40;
  const swimH = 39;
  // We'll calculate positions after render ‚Äî use a simpler approach
  // Arrows are rendered as absolute positioned elements

  const headerHeight = 32;
  container.innerHTML = `
    <div style="display:flex;position:sticky;top:0;z-index:10;background:var(--sidebar);">
      <div style="width:${labelWidth}px;min-width:${labelWidth}px;background:var(--sidebar);border-bottom:2px solid var(--border);border-right:1px solid var(--border);padding:8px 12px;font-size:10px;color:var(--text-muted);font-weight:600;">TASK</div>
      <div style="position:relative;width:${chartWidth}px;height:${headerHeight}px;border-bottom:2px solid var(--border);">${headerCells}</div>
    </div>
    <div style="position:relative;" id="tl-body">${rowsHTML}
      <div class="tl-today-line" style="left:${labelWidth + todayX}px;"><div class="tl-today-label">TODAY</div></div>
    </div>`;

  // After render, draw dependency arrows
  setTimeout(() => renderTlDependencies(tasks, taskRowMap, dateToX, labelWidth, chartWidth), 50);
}

function renderTlDependencies(tasks, taskRowMap, dateToX, labelWidth, chartWidth) {
  const body = document.getElementById('tl-body');
  if (!body) return;
  // Remove old SVG
  const oldSvg = body.querySelector('.tl-dep-svg');
  if (oldSvg) oldSvg.remove();

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('tl-dep-svg');
  svg.style.cssText = `position:absolute;top:0;left:${labelWidth}px;width:${chartWidth}px;height:100%;pointer-events:none;z-index:4;`;

  const now = new Date();
  for (const t of tasks) {
    if (!t.depends_on || !t.depends_on.length) continue;
    const toRow = taskRowMap[t.id];
    if (toRow === undefined) continue;
    const toStart = t.start_date ? new Date(t.start_date) : (t.created_at ? new Date(t.created_at) : now);
    const toX = dateToX(toStart);

    for (const depId of t.depends_on) {
      const fromRow = taskRowMap[depId];
      if (fromRow === undefined) continue;
      const dep = tasks.find(x => x.id === depId);
      if (!dep) continue;
      const fromEnd = dep.end_date ? new Date(dep.end_date) : (dep.due_date ? new Date(dep.due_date) : now);
      const fromX = dateToX(fromEnd);

      // Calculate Y positions (approximate: swimlane headers shift things)
      // For now use row indices * 40 + offset
      const fromY = fromRow * 40 + 60;
      const toY = toRow * 40 + 60;

      const isBlocking = dep.status !== 'done' && t.status !== 'done';
      const color = isBlocking ? '#ef4444' : '#4b5563';

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const midX = (fromX + toX) / 2;
      path.setAttribute('d', `M${fromX},${fromY} C${midX},${fromY} ${midX},${toY} ${toX},${toY}`);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', color);
      path.setAttribute('stroke-width', isBlocking ? '2' : '1.5');
      path.setAttribute('stroke-dasharray', isBlocking ? '' : '4,4');
      path.setAttribute('opacity', '0.6');
      svg.appendChild(path);

      // Arrowhead
      const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      arrow.setAttribute('points', `${toX},${toY} ${toX - 6},${toY - 4} ${toX - 6},${toY + 4}`);
      arrow.setAttribute('fill', color);
      arrow.setAttribute('opacity', '0.6');
      svg.appendChild(arrow);
    }
  }
  body.appendChild(svg);
}

function toggleTlGroup(key) { tlCollapsed[key] = !tlCollapsed[key]; renderGantt(); }

// Tooltip
function showTlTooltip(e, html) {
  const tt = document.getElementById('tl-tooltip');
  tt.innerHTML = html;
  tt.style.display = 'block';
  tt.classList.remove('hidden');
  const rect = tt.getBoundingClientRect();
  let x = e.clientX + 12, y = e.clientY + 12;
  if (x + rect.width > window.innerWidth) x = e.clientX - rect.width - 12;
  if (y + rect.height > window.innerHeight) y = e.clientY - rect.height - 12;
  tt.style.left = x + 'px';
  tt.style.top = y + 'px';
}
function hideTlTooltip() { const tt = document.getElementById('tl-tooltip'); tt.style.display = 'none'; tt.classList.add('hidden'); }

function tlTaskTooltip(taskId) {
  const t = (GANTT.tasks || []).find(x => x.id === taskId);
  if (!t) return '';
  const prog = t.progress || 0;
  const isOverdue = t.end_date && new Date(t.end_date) < new Date() && t.status !== 'done';
  return `<div><b>${t.title}</b></div>
    <div style="margin:6px 0;display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:11px;">
      <span style="color:var(--text-muted)">Status:</span><span>${t.status.replace('_', ' ')}${isOverdue ? ' <span style="color:#ef4444">‚ö† OVERDUE</span>' : ''}</span>
      <span style="color:var(--text-muted)">Dates:</span><span>${t.start_date || '?'} ‚Üí ${t.end_date || t.due_date || '?'}</span>
      ${t.owner ? `<span style="color:var(--text-muted)">Assignee:</span><span>${t.owner}</span>` : ''}
      <span style="color:var(--text-muted)">Progress:</span><span>${prog}%</span>
    </div>
    <div style="height:4px;background:var(--bg);border-radius:2px;"><div style="height:100%;width:${prog}%;background:var(--accent);border-radius:2px;"></div></div>`;
}

// Task Detail Modal
async function openTlTaskModal(taskId) {
  const t = (GANTT.tasks || []).find(x => x.id === taskId);
  if (!t) return;
  hideTlTooltip();
  const deps = typeof t.depends_on === 'string' ? JSON.parse(t.depends_on || '[]') : (t.depends_on || []);
  const depNames = deps.map(id => { const d = (GANTT.tasks || []).find(x => x.id === id); return d ? d.title : `#${id}`; });
  const blocksNames = (GANTT.tasks || []).filter(x => { const xd = typeof x.depends_on === 'string' ? JSON.parse(x.depends_on || '[]') : (x.depends_on || []); return xd.includes(t.id); }).map(x => x.title);

  document.getElementById('tl-modal-title').textContent = t.title;
  document.getElementById('tl-modal-body').innerHTML = `
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div><label class="form-label">Title</label><input type="text" id="tl-ed-title" class="form-input" value="${t.title.replace(/"/g, '&quot;')}"></div>
      <div><label class="form-label">Assignee</label><input type="text" id="tl-ed-owner" class="form-input" value="${(t.owner || '').replace(/"/g, '&quot;')}"></div>
    </div>
    <div class="mb-4"><label class="form-label">Description</label><textarea id="tl-ed-desc" class="form-input" style="height:80px;">${(t.description || '').replace(/</g, '&lt;')}</textarea></div>
    <div class="grid grid-cols-3 gap-4 mb-4">
      <div><label class="form-label">Department</label><select id="tl-ed-dept" class="form-input"><option>Operations</option><option>Research & Intelligence</option><option>Marketing & Content</option><option>Sales & Business Dev</option><option>Engineering & Product</option><option>Design & Brand</option></select></div>
      <div><label class="form-label">Status</label><select id="tl-ed-status" class="form-input"><option value="backlog">Backlog</option><option value="in_progress">In Progress</option><option value="review">Review</option><option value="done">Done</option></select></div>
      <div><label class="form-label">Priority</label><select id="tl-ed-priority" class="form-input"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div><label class="form-label">Start Date</label><input type="date" id="tl-ed-start" class="form-input" value="${t.start_date || ''}"></div>
      <div><label class="form-label">End Date</label><input type="date" id="tl-ed-end" class="form-input" value="${t.end_date || t.due_date || ''}"></div>
    </div>
    <div class="mb-4"><label class="form-label">Progress: <span id="tl-ed-prog-val">${t.progress || 0}</span>%</label><input type="range" id="tl-ed-progress" class="tl-progress-slider" min="0" max="100" value="${t.progress || 0}" oninput="document.getElementById('tl-ed-prog-val').textContent=this.value"><div style="height:6px;background:var(--bg);border-radius:3px;margin-top:4px;"><div id="tl-ed-prog-bar" style="height:100%;width:${t.progress || 0}%;background:var(--accent);border-radius:3px;transition:width 0.2s;"></div></div></div>
    ${deps.length ? `<div class="mb-4"><label class="form-label">‚õì Blocked by</label><div class="flex flex-wrap gap-2">${depNames.map(n => `<span class="text-xs px-2 py-1 rounded bg-red-900/30 text-red-300">${n}</span>`).join('')}</div></div>` : ''}
    ${blocksNames.length ? `<div class="mb-4"><label class="form-label">üîó Blocks</label><div class="flex flex-wrap gap-2">${blocksNames.map(n => `<span class="text-xs px-2 py-1 rounded bg-amber-900/30 text-amber-300">${n}</span>`).join('')}</div></div>` : ''}
    ${t.action_item_id ? `<div class="mb-4"><button onclick="goToActionItem(${t.action_item_id});closeTlTaskModal()" class="btn-secondary text-xs">üìù Go to Action Item</button></div>` : ''}
  `;

  // Set dropdown values
  document.getElementById('tl-ed-dept').value = t.department || 'Operations';
  document.getElementById('tl-ed-status').value = t.status || 'backlog';
  document.getElementById('tl-ed-priority').value = t.priority || 'medium';

  // Progress slider live update
  document.getElementById('tl-ed-progress').oninput = function() {
    document.getElementById('tl-ed-prog-val').textContent = this.value;
    document.getElementById('tl-ed-prog-bar').style.width = this.value + '%';
  };

  document.getElementById('tl-modal-footer').innerHTML = `
    <button onclick="navigateToRoute('/kanban')" class="btn-ghost text-xs">üìã Go to Kanban</button>
    <button onclick="closeTlTaskModal()" class="btn-ghost text-sm">Cancel</button>
    <button onclick="saveTlTask(${t.id})" class="btn-primary text-sm">üíæ Save Changes</button>
  `;

  document.getElementById('tl-task-modal').classList.remove('hidden');
}

async function saveTlTask(id) {
  const data = {
    title: document.getElementById('tl-ed-title').value,
    description: document.getElementById('tl-ed-desc').value,
    owner: document.getElementById('tl-ed-owner').value,
    department: document.getElementById('tl-ed-dept').value,
    status: document.getElementById('tl-ed-status').value,
    priority: document.getElementById('tl-ed-priority').value,
    start_date: document.getElementById('tl-ed-start').value || null,
    end_date: document.getElementById('tl-ed-end').value || null,
    due_date: document.getElementById('tl-ed-end').value || null,
    progress: parseInt(document.getElementById('tl-ed-progress').value) || 0,
  };
  await api(`/api/tasks/${id}`, { method: 'PUT', body: JSON.stringify(data) });
  closeTlTaskModal();
  GANTT = await api('/api/gantt');
  renderGantt();
}

function closeTlTaskModal(e) { if (e && e.target !== e.currentTarget) return; document.getElementById('tl-task-modal').classList.add('hidden'); }

// Milestone modal
function openTlMilestoneModal(id) {
  const m = (GANTT.milestones || []).find(x => x.id === id);
  if (!m) return;
  hideTlTooltip();
  document.getElementById('tl-modal-title').textContent = '‚óÜ ' + m.name;
  document.getElementById('tl-modal-body').innerHTML = `
    <div class="mb-4"><label class="form-label">Name</label><div class="text-lg font-bold">${m.name}</div></div>
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div><label class="form-label">Department</label><div>${m.department || '‚Äî'}</div></div>
      <div><label class="form-label">Target Date</label><div>${m.target_date || '‚Äî'}</div></div>
    </div>
    <div class="mb-4"><label class="form-label">Status</label><span class="text-xs px-2 py-1 rounded ${m.status === 'completed' ? 'bg-green-900/50 text-green-300' : m.status === 'in_progress' ? 'bg-blue-900/50 text-blue-300' : 'bg-slate-700 text-[#94a3b8]'}">${m.status}</span></div>
    <div class="mb-4"><label class="form-label">Description</label><div class="text-sm text-[#94a3b8]">${m.description || 'No description'}</div></div>
  `;
  document.getElementById('tl-modal-footer').innerHTML = '<button onclick="closeTlTaskModal()" class="btn-secondary text-sm">Close</button>';
  document.getElementById('tl-task-modal').classList.remove('hidden');
}

// Drag to move/resize bars
function startTlDrag(e, taskId, mode) {
  if (e.button !== 0) return;
  const bar = e.currentTarget;
  const startX = e.clientX;
  const origLeft = parseInt(bar.style.left);
  const origWidth = parseInt(bar.style.width) || bar.offsetWidth;
  
  // Determine if resizing (clicking near right edge)
  const rect = bar.getBoundingClientRect();
  const isResize = e.clientX > rect.right - 8;
  
  const onMove = (ev) => {
    const dx = ev.clientX - startX;
    if (isResize) {
      bar.style.width = Math.max(8, origWidth + dx) + 'px';
    } else {
      bar.style.left = (origLeft + dx) + 'px';
    }
    bar.style.opacity = '0.7';
  };
  
  const onUp = async (ev) => {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    bar.style.opacity = '';
    
    const dx = ev.clientX - startX;
    if (Math.abs(dx) < 5) return; // Click, not drag
    
    const dayWidth = tlZoom === 'day' ? 48 : tlZoom === 'week' ? 18 : tlZoom === 'month' ? 6 : 2.5;
    const daysDelta = Math.round(dx / dayWidth);
    if (daysDelta === 0) { renderGantt(); return; }
    
    const t = (GANTT.tasks || []).find(x => x.id === taskId);
    if (!t) return;
    
    const sd = new Date(t.start_date || t.created_at || new Date());
    const ed = new Date(t.end_date || t.due_date || new Date(sd.getTime() + 7 * 864e5));
    
    if (isResize) {
      ed.setDate(ed.getDate() + daysDelta);
      await api(`/api/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify({ end_date: ed.toISOString().split('T')[0], due_date: ed.toISOString().split('T')[0] }) });
    } else {
      sd.setDate(sd.getDate() + daysDelta);
      ed.setDate(ed.getDate() + daysDelta);
      await api(`/api/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify({ start_date: sd.toISOString().split('T')[0], end_date: ed.toISOString().split('T')[0], due_date: ed.toISOString().split('T')[0] }) });
    }
    GANTT = await api('/api/gantt');
    renderGantt();
  };
  
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
  e.preventDefault();
  e.stopPropagation();
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (document.getElementById('sec-gantt').classList.contains('hidden')) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  const scroll = document.getElementById('tl-gantt-scroll');
  if (!scroll) return;
  if (e.key === 'ArrowRight') { scroll.scrollLeft += 100; e.preventDefault(); }
  if (e.key === 'ArrowLeft') { scroll.scrollLeft -= 100; e.preventDefault(); }
  if (e.key === 'ArrowDown') { scroll.scrollTop += 50; e.preventDefault(); }
  if (e.key === 'ArrowUp') { scroll.scrollTop -= 50; e.preventDefault(); }
  if (e.key === '+' || e.key === '=') { const zooms = ['day', 'week', 'month', 'quarter']; const i = zooms.indexOf(tlZoom); if (i > 0) setTlZoom(zooms[i - 1]); e.preventDefault(); }
  if (e.key === '-') { const zooms = ['day', 'week', 'month', 'quarter']; const i = zooms.indexOf(tlZoom); if (i < zooms.length - 1) setTlZoom(zooms[i + 1]); e.preventDefault(); }
  if (e.key === 't' || e.key === 'T') { tlJumpToday(); e.preventDefault(); }
});

// ‚ïê‚ïê‚ïê Departments ‚ïê‚ïê‚ïê
function renderDepartments(){
  document.getElementById('dept-tabs').innerHTML=(DATA.org||[]).map(d=>`<button class="text-xs px-4 py-2 rounded-lg tab-inactive dept-tab" onclick="showDeptDetail('${d.dept}')" style="border-left:3px solid ${deptColor(d.dept)}">${d.dept}</button>`).join('');
}
async function showDeptDetail(dept){
  document.querySelectorAll('.dept-tab').forEach(b=>{b.className=b.textContent===dept?'text-xs px-4 py-2 rounded-lg tab-active dept-tab':'text-xs px-4 py-2 rounded-lg tab-inactive dept-tab';});
  const orgInfo=(DATA.org||[]).find(o=>o.dept===dept);
  let detail;try{detail=await api(`/api/departments/${encodeURIComponent(dept)}`);}catch(e){detail={tasks:[],kpis:[],actions:[],blockers:[],deliverables:[],milestones:[],activity:[]};}
  const tasks=detail.tasks||[],kpis=detail.kpis||[],blockers=detail.blockers||[],deliverables=detail.deliverables||[],deptMilestones=detail.milestones||[],deptActions=detail.actions||[];
  const byStatus={};tasks.forEach(t=>byStatus[t.status]=(byStatus[t.status]||0)+1);
  const inProg=byStatus.in_progress||0,done=byStatus.done||0,total=tasks.length;
  const completionPct=total?Math.round(done/total*100):0;
  const vp=orgInfo?.vp||'N/A',health=orgInfo?.health||'Unknown',agents=orgInfo?.agents||'N/A',status=orgInfo?.status||'Unknown';
  const kpiCards=kpis.map((k,i)=>{const col=kpiStatusColor(k.status);return `<div class="card p-4"><div class="flex justify-between items-center mb-1"><span class="text-xs text-[#94a3b8]">${k.kpi_name}</span><span class="text-xs" style="color:${col};">‚óè</span></div><div class="text-lg font-bold" style="color:${col}">${k.current_value}</div><div class="text-xs text-[#64748b]">Target: ${k.target}</div><canvas id="dept-spark-${i}" width="160" height="40" class="mt-2"></canvas></div>`;}).join('');
  const el=document.getElementById('dept-detail');
  el.innerHTML=`
    <div class="card p-5" style="border-left:4px solid ${deptColor(dept)}"><div class="flex justify-between items-start flex-wrap gap-4"><div><h3 class="text-xl font-bold">${dept}</h3><div class="flex gap-6 mt-2 text-sm flex-wrap"><span class="text-[#94a3b8]">üë§ VP: <strong class="text-white">${vp}</strong></span><span class="text-[#94a3b8]">ü§ñ Agents: <strong class="text-white">${agents}</strong></span><span class="text-[#94a3b8]">üìä Status: ${statusBadge(status)}</span></div></div><div class="text-right"><div class="text-sm text-[#94a3b8]">Health</div><div class="text-lg">${statusBadge(health)}</div></div></div><div class="mt-4"><div class="flex justify-between text-xs text-[#94a3b8] mb-1"><span>${done}/${total} tasks complete</span><span>${completionPct}%</span></div><div class="w-full h-2 bg-[#0f1117] rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:${completionPct}%;background:${deptColor(dept)};transition:width 0.3s;"></div></div></div></div>
    <div class="grid grid-cols-5 gap-3"><div class="card p-3 text-center"><div class="text-lg font-bold">${total}</div><div class="text-xs text-[#64748b]">Total</div></div><div class="card p-3 text-center"><div class="text-lg font-bold text-blue-400">${inProg}</div><div class="text-xs text-[#64748b]">In Progress</div></div><div class="card p-3 text-center"><div class="text-lg font-bold text-green-400">${done}</div><div class="text-xs text-[#64748b]">Done</div></div><div class="card p-3 text-center"><div class="text-lg font-bold text-yellow-400">${byStatus.review||0}</div><div class="text-xs text-[#64748b]">Review</div></div><div class="card p-3 text-center"><div class="text-lg font-bold text-red-400">${blockers.length}</div><div class="text-xs text-[#64748b]">Blockers</div></div></div>
    ${kpis.length?`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm">üìà KPIs</div><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 p-4">${kpiCards}</div></div>`:''}
    ${deptMilestones.length?`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm">‚óÜ Milestones</div><div class="p-4 space-y-2">${deptMilestones.map(m=>`<div class="flex justify-between items-center py-2 border-b border-[#2d3148]"><div><span class="font-medium text-sm">${m.name}</span><span class="text-xs text-[#64748b] ml-2">${m.description||''}</span></div><div class="flex items-center gap-3"><span class="text-xs text-[#94a3b8]">${m.target_date||'TBD'}</span><span class="text-xs px-2 py-0.5 rounded ${m.status==='completed'?'bg-green-900/50 text-green-300':m.status==='in_progress'?'bg-blue-900/50 text-blue-300':'bg-slate-700 text-[#94a3b8]'}">${m.status}</span></div></div>`).join('')}</div></div>`:''}
    ${tasks.length?`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm">üìã Tasks (${tasks.length})</div><div class="overflow-x-auto p-4"><table class="w-full text-sm"><thead><tr class="text-[#64748b] text-xs"><th class="text-left py-1">Task</th><th class="text-left py-1">Owner</th><th class="text-left py-1">Priority</th><th class="text-left py-1">Status</th><th class="text-left py-1">Due</th></tr></thead><tbody>${tasks.map(t=>`<tr><td class="py-2">${t.is_blocker?'üö´ ':''}${t.title}</td><td class="text-[#94a3b8]">${t.owner||'‚Äî'}</td><td>${priorityBadge(t.priority)}</td><td><span class="text-xs px-2 py-0.5 rounded bg-[#0f1117] text-[#94a3b8]">${t.status.replace('_',' ')}</span></td><td class="text-xs ${t.due_date&&new Date(t.due_date)<new Date()&&t.status!=='done'?'text-red-400':'text-[#64748b]'}">${t.due_date||'‚Äî'}</td></tr>`).join('')}</tbody></table></div></div>`:''}
    ${blockers.length?`<div class="card border-red-900/50"><div class="card-header px-5 py-3 font-semibold text-sm text-red-400">üö´ Active Blockers</div><div class="p-4 space-y-2">${blockers.map(b=>`<div class="severity-red card p-3"><div class="text-sm font-medium">${b.title}</div><div class="text-xs text-[#94a3b8] mt-1">${b.blocker_note||b.description||''}</div></div>`).join('')}</div></div>`:''}
    ${deliverables.length?`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm text-green-400">‚úÖ Recent Deliverables</div><div class="p-4 space-y-1">${deliverables.map(d=>`<div class="flex justify-between items-center py-1.5 border-b border-[#2d3148]"><span class="text-sm">${d.title}</span><span class="text-xs text-[#64748b]">${d.updated_at?timeAgo(d.updated_at):''}</span></div>`).join('')}</div></div>`:''}
    ${deptActions.length?`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm">üìù Related Action Items</div><div class="p-4 space-y-2">${deptActions.map(a=>`<div class="severity-${a.severity} card p-3"><div class="flex justify-between"><div class="text-sm font-medium">${a.title}</div><span class="text-xs px-2 py-0.5 rounded ${a.status==='open'?'bg-red-900/50 text-red-300':'bg-green-900/50 text-green-300'}">${a.status}</span></div><div class="text-xs text-[#94a3b8] mt-1">Owner: ${a.owner} ¬∑ ${daysAgo(a.opened_date)}</div></div>`).join('')}</div></div>`:''}`;
  setTimeout(()=>{kpis.forEach((k,i)=>{const canvas=document.getElementById(`dept-spark-${i}`);if(!canvas)return;const ctx=canvas.getContext('2d');drawMiniSparkline(ctx,canvas.width,canvas.height,kpiStatusColor(k.status),generateSparkData(k));});},100);
}

// ‚ïê‚ïê‚ïê KPIs & Sparklines ‚ïê‚ïê‚ïê
function renderKPIs(){
  const depts=[...new Set(KPIS.map(k=>k.department))];
  if(!depts.length){const ld=Object.keys(DATA.kpis||{});if(!ld.length)return;document.getElementById('kpi-tabs').innerHTML=ld.map((d,i)=>`<button class="text-xs px-3 py-1.5 rounded-full ${i===0?'tab-active':'tab-inactive'} kpi-tab" onclick="selectKPILegacy('${d}')">${d}</button>`).join('');selectKPILegacy(ld[0]);return;}
  document.getElementById('kpi-tabs').innerHTML=depts.map((d,i)=>`<button class="text-xs px-3 py-1.5 rounded-full ${i===0?'tab-active':'tab-inactive'} kpi-tab" onclick="selectKPI('${d}')">${d}</button>`).join('');
  selectKPI(depts[0]);
}
async function selectKPI(dept){
  selectedKPIDept=dept;
  document.querySelectorAll('.kpi-tab').forEach(b=>{b.className=b.textContent===dept?'text-xs px-3 py-1.5 rounded-full tab-active kpi-tab':'text-xs px-3 py-1.5 rounded-full tab-inactive kpi-tab';});
  const kpis=KPIS.filter(k=>k.department===dept);
  let history={};try{history=await api(`/api/kpis/history/${encodeURIComponent(dept)}`);}catch(e){}
  document.getElementById('kpi-sparkline-grid').innerHTML=kpis.map((k,i)=>{const col=kpiStatusColor(k.status);const tc=/on track|green|üü¢/i.test(k.status)?'border-green-600':/at risk|amber|üü°/i.test(k.status)?'border-yellow-600':'border-red-600';return `<div class="card p-4 border-t-2 ${tc}"><div class="flex justify-between items-start"><div><div class="text-xs text-[#94a3b8] mb-1">${k.kpi_name}</div><div class="text-xl font-bold" style="color:${col}">${k.current_value}</div><div class="text-xs text-[#64748b] mt-1">Target: ${k.target}</div></div><canvas id="kpi-spark-${i}" width="120" height="50"></canvas></div><div class="flex items-center gap-2 mt-2"><span class="text-xs">${k.trend||'‚Äî'}</span><span class="text-xs px-1.5 py-0.5 rounded" style="background:${col}22;color:${col}">${k.status}</span></div></div>`;}).join('');
  document.getElementById('kpi-table').innerHTML=kpis.map((k,i)=>`<tr><td class="px-5 py-3 font-medium">${k.kpi_name}</td><td class="px-3 py-3 text-[#94a3b8]">${k.target}</td><td class="px-3 py-3">${k.current_value}</td><td class="px-3 py-3">${statusBadge(k.status)}</td><td class="px-3 py-3">${k.trend||'‚Äî'}</td><td class="px-3 py-3"><canvas id="kpi-tbl-spark-${i}" width="100" height="30"></canvas></td></tr>`).join('');
  setTimeout(()=>{kpis.forEach((k,i)=>{const col=kpiStatusColor(k.status);const histData=history[k.kpi_name]||[];const data=histData.length>1?histData.map(h=>parseFloat(h.current_value)||0):generateSparkData(k);const c1=document.getElementById(`kpi-spark-${i}`);if(c1)drawSparkline(c1,data,col);const c2=document.getElementById(`kpi-tbl-spark-${i}`);if(c2)drawMiniSparkline(c2.getContext('2d'),c2.width,c2.height,col,data);});},100);
}
function selectKPILegacy(dept){document.querySelectorAll('.kpi-tab').forEach(b=>{b.className=b.textContent===dept?'text-xs px-3 py-1.5 rounded-full tab-active kpi-tab':'text-xs px-3 py-1.5 rounded-full tab-inactive kpi-tab';});const kpis=DATA.kpis[dept]||[];document.getElementById('kpi-sparkline-grid').innerHTML='';document.getElementById('kpi-table').innerHTML=kpis.map(k=>`<tr><td class="px-5 py-3 font-medium">${k.kpi}</td><td class="px-3 py-3 text-[#94a3b8]">${k.target}</td><td class="px-3 py-3">${k.current}</td><td class="px-3 py-3">${statusBadge(k.status)}</td><td class="px-3 py-3">${k.trend||'‚Äî'}</td><td></td></tr>`).join('');}
function drawSparkline(canvas,data,color){if(!data.length)return;const ctx=canvas.getContext('2d'),w=canvas.width,h=canvas.height;ctx.clearRect(0,0,w,h);const min=Math.min(...data),max=Math.max(...data),range=max-min||1;const pts=data.map((v,i)=>({x:(i/(data.length-1||1))*w,y:h-((v-min)/range)*(h-8)-4}));ctx.beginPath();ctx.moveTo(pts[0].x,h);pts.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(pts[pts.length-1].x,h);ctx.closePath();ctx.fillStyle=color+'15';ctx.fill();ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();const last=pts[pts.length-1];ctx.beginPath();ctx.arc(last.x,last.y,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();}
function drawMiniSparkline(ctx,w,h,color,data){if(!data.length)return;ctx.clearRect(0,0,w,h);const min=Math.min(...data),max=Math.max(...data),range=max-min||1;const pts=data.map((v,i)=>({x:(i/(data.length-1||1))*(w-4)+2,y:h-((v-min)/range)*(h-6)-3}));ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.stroke();}
function generateSparkData(kpi){const val=parseFloat(kpi.current_value)||50;const data=[];let v=val*0.7;for(let i=0;i<10;i++){v+=(val-v)*0.2+(Math.random()-0.4)*val*0.1;data.push(Math.max(0,v));}data.push(val);return data;}
async function syncKPIs(){await api('/api/kpis/sync',{method:'POST'});KPIS=await api('/api/kpis');renderKPIs();}

// ‚ïê‚ïê‚ïê Action Items (Overhauled) ‚ïê‚ïê‚ïê
let actionCurrentFilter = '';
let actionCurrentSeverity = '';
let actionCurrentRequester = '';
let actionCurrentOwner = '';
let actionCurrentPage = 1;
let actionCounts = {};
let actionExpandedId = null;
let actionSearchTimeout = null;
let resolveTargetId = null;
let actionSortField = 'severity';
let actionSortDir = 'desc';

function debounceActionSearch() {
  clearTimeout(actionSearchTimeout);
  actionSearchTimeout = setTimeout(() => { actionCurrentPage = 1; loadActionItems(); }, 300);
}

function setActionFilter(f, type = 'status') {
  if (type === 'status') {
    actionCurrentFilter = actionCurrentFilter === f ? '' : f;
  } else if (type === 'severity') {
    actionCurrentSeverity = actionCurrentSeverity === f ? '' : f;
  } else if (type === 'requester') {
    actionCurrentRequester = actionCurrentRequester === f ? '' : f;
  } else if (type === 'owner') {
    actionCurrentOwner = actionCurrentOwner === f ? '' : f;
  }
  actionCurrentPage = 1;
  updateActionURL();
  renderProFilterBar();
  loadActionItems();
}

function clearAllActionFilters() {
  actionCurrentFilter = '';
  actionCurrentSeverity = '';
  actionCurrentRequester = '';
  actionCurrentOwner = '';
  const searchEl = document.getElementById('action-search');
  if (searchEl) searchEl.value = '';
  actionCurrentPage = 1;
  updateActionURL();
  renderProFilterBar();
  loadActionItems();
}

function toggleFilterDropdown(id) {
  const el = document.getElementById(id);
  const wasOpen = el.classList.contains('open');
  // Close all
  document.querySelectorAll('.filter-dropdown.open').forEach(d => d.classList.remove('open'));
  if (!wasOpen) el.classList.add('open');
}

// Close dropdowns on outside click / Escape
document.addEventListener('click', e => {
  if (!e.target.closest('.filter-dropdown')) {
    document.querySelectorAll('.filter-dropdown.open').forEach(d => d.classList.remove('open'));
  }
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.filter-dropdown.open').forEach(d => d.classList.remove('open'));
});

function setActionSort(field) {
  if (actionSortField === field) {
    actionSortDir = actionSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    actionSortField = field;
    actionSortDir = field === 'title' || field === 'owner' ? 'asc' : 'desc';
  }
  updateSortArrows();
  loadActionItems();
}

function updateSortArrows() {
  document.querySelectorAll('.action-table thead th').forEach(th => th.classList.remove('sort-active'));
  ['title','owner','status','severity','last_activity'].forEach(f => {
    const arrow = document.getElementById('sort-arrow-' + f);
    if (arrow) {
      if (actionSortField === f) {
        arrow.textContent = actionSortDir === 'asc' ? ' ‚Üë' : ' ‚Üì';
        arrow.closest('th').classList.add('sort-active');
      } else {
        arrow.textContent = '';
      }
    }
  });
}

function renderProFilterBar() {
  const c = actionCounts;
  const hasFilters = actionCurrentFilter || actionCurrentSeverity || actionCurrentOwner;
  
  // Status dropdown
  const statuses = [
    { key: 'open', label: 'Open', count: c.open || 0 },
    { key: 'awaiting_david', label: 'Awaiting David', count: c.awaiting_david || 0 },
    { key: 'awaiting_vp', label: 'Awaiting VP', count: c.awaiting_vp || 0 },
    { key: 'resolved', label: 'Resolved', count: c.resolved || 0 },
    { key: 'deferred', label: 'Deferred', count: c.deferred || 0 },
  ];
  document.getElementById('fd-status-menu').innerHTML = statuses.map(s =>
    `<div class="fd-option ${actionCurrentFilter === s.key ? 'selected' : ''}" onclick="event.stopPropagation();setActionFilter('${s.key}','status')"><span><span class="fd-check">‚úì</span>${s.label}</span><span class="fd-count">${s.count}</span></div>`
  ).join('');
  const statusTrigger = document.querySelector('#fd-status .filter-trigger');
  const statusLabel = document.getElementById('fd-status-label');
  if (actionCurrentFilter) {
    statusLabel.textContent = statuses.find(s => s.key === actionCurrentFilter)?.label || 'Status';
    statusTrigger.classList.add('has-value');
  } else {
    statusLabel.textContent = 'Status';
    statusTrigger.classList.remove('has-value');
  }

  // Severity dropdown
  const sevs = [
    { key: 'red', label: 'üî¥ Critical', count: c.red || 0 },
    { key: 'yellow', label: 'üü° Blocking', count: c.yellow || 0 },
    { key: 'blue', label: 'üîµ Decision', count: c.blue || 0 },
  ];
  document.getElementById('fd-severity-menu').innerHTML = sevs.map(s =>
    `<div class="fd-option ${actionCurrentSeverity === s.key ? 'selected' : ''}" onclick="event.stopPropagation();setActionFilter('${s.key}','severity')"><span><span class="fd-check">‚úì</span>${s.label}</span><span class="fd-count">${s.count}</span></div>`
  ).join('');
  const sevTrigger = document.querySelector('#fd-severity .filter-trigger');
  const sevLabel = document.getElementById('fd-severity-label');
  if (actionCurrentSeverity) {
    sevLabel.textContent = sevs.find(s => s.key === actionCurrentSeverity)?.label || 'Severity';
    sevTrigger.classList.add('has-value');
  } else {
    sevLabel.textContent = 'Severity';
    sevTrigger.classList.remove('has-value');
  }

  // Owner dropdown
  const owners = Object.entries(c.owners || {}).sort((a,b) => b[1] - a[1]);
  document.getElementById('fd-owner-menu').innerHTML = owners.map(([name, count]) =>
    `<div class="fd-option ${actionCurrentOwner === name ? 'selected' : ''}" onclick="event.stopPropagation();setActionFilter('${name.replace(/'/g,"\\'")}','owner')"><span><span class="fd-check">‚úì</span>${name}</span><span class="fd-count">${count}</span></div>`
  ).join('');
  const ownerTrigger = document.querySelector('#fd-owner .filter-trigger');
  const ownerLabel = document.getElementById('fd-owner-label');
  if (actionCurrentOwner) {
    ownerLabel.textContent = actionCurrentOwner;
    ownerTrigger.classList.add('has-value');
  } else {
    ownerLabel.textContent = 'Owner';
    ownerTrigger.classList.remove('has-value');
  }

  // Clear all btn
  const clearBtn = document.getElementById('filter-clear-all-btn');
  if (clearBtn) {
    if (hasFilters) clearBtn.classList.remove('hidden');
    else clearBtn.classList.add('hidden');
  }

  // Active chips
  const chipsEl = document.getElementById('filter-active-chips');
  let chips = [];
  if (actionCurrentFilter) {
    const sl = statuses.find(s => s.key === actionCurrentFilter);
    chips.push(`<span class="active-chip chip-status">${sl?.label || actionCurrentFilter}<span class="chip-x" onclick="setActionFilter('${actionCurrentFilter}','status')">‚úï</span></span>`);
  }
  if (actionCurrentSeverity) {
    const sl = sevs.find(s => s.key === actionCurrentSeverity);
    chips.push(`<span class="active-chip chip-severity-${actionCurrentSeverity}">${sl?.label || actionCurrentSeverity}<span class="chip-x" onclick="setActionFilter('${actionCurrentSeverity}','severity')">‚úï</span></span>`);
  }
  if (actionCurrentOwner) {
    chips.push(`<span class="active-chip chip-owner">Owner: ${actionCurrentOwner}<span class="chip-x" onclick="setActionFilter('${actionCurrentOwner.replace(/'/g,"\\'")}','owner')">‚úï</span></span>`);
  }
  if (chips.length) {
    chipsEl.innerHTML = `<span class="chip-label">Filters:</span>${chips.join('')}<span class="chip-label" style="cursor:pointer;color:#f87171;" onclick="clearAllActionFilters()">Clear all</span>`;
    chipsEl.classList.add('has-chips');
  } else {
    chipsEl.innerHTML = '';
    chipsEl.classList.remove('has-chips');
  }

  // Stats row (always unfiltered totals)
  const statsEl = document.getElementById('filter-stats-row');
  if (statsEl) {
    const total = c.total || 0;
    const filtered = document.querySelectorAll('#action-items-tbody tr').length;
    statsEl.innerHTML = `<span>Showing ${actionFilteredTotal ?? total} of ${total} items</span><span class="stat-sep">¬∑</span><span>üî¥ ${c.awaiting_david || 0} awaiting David</span><span class="stat-sep">¬∑</span><span>üü° ${c.awaiting_vp || 0} awaiting VP</span><span class="stat-sep">¬∑</span><span>‚úÖ ${c.resolved || 0} resolved</span>`;
  }
}

let actionFilteredTotal = null;

// Update URL with current action filter state
function updateActionURL() {
  if (window.location.pathname !== '/actions') return;
  
  const params = new URLSearchParams();
  
  if (actionCurrentFilter) {
    params.set('status', actionCurrentFilter);
  }
  
  if (actionCurrentSeverity) {
    params.set('severity', actionCurrentSeverity);
  }
  
  if (actionCurrentRequester) {
    params.set('department', actionCurrentRequester);
  }
  
  if (actionCurrentOwner) {
    params.set('owner', actionCurrentOwner);
  }
  
  const search = document.getElementById('action-search')?.value;
  if (search) params.set('search', search);
  
  const queryString = params.toString();
  const newURL = '/actions' + (queryString ? '?' + queryString : '');
  
  if (window.location.pathname + window.location.search !== newURL) {
    history.pushState({}, '', newURL);
  }
}

// Parse action query parameters from URL and update filter state
function parseActionQueryParams() {
  if (window.location.pathname !== '/actions') return;
  
  const params = new URLSearchParams(window.location.search);
  
  // Reset to defaults
  actionCurrentFilter = '';
  actionCurrentSeverity = '';
  actionCurrentRequester = '';
  actionCurrentOwner = '';
  
  // Parse status parameter
  const status = params.get('status');
  if (status && ['open', 'awaiting_david', 'awaiting_vp', 'resolved', 'deferred'].includes(status)) {
    actionCurrentFilter = status;
  }
  
  // Parse severity parameter  
  const severity = params.get('severity');
  if (severity && ['red', 'yellow', 'blue'].includes(severity)) {
    actionCurrentSeverity = severity;
  }
  
  // Parse department parameter
  const department = params.get('department');
  if (department) {
    actionCurrentRequester = decodeURIComponent(department);
  }
  
  // Parse owner parameter
  const owner = params.get('owner');
  if (owner) {
    actionCurrentOwner = decodeURIComponent(owner);
  }
  
  // Parse search parameter
  const search = params.get('search');
  if (search) {
    const searchEl = document.getElementById('action-search');
    if (searchEl) searchEl.value = search;
  }
}

// Parse kanban query parameters from URL and update filter state
function parseKanbanQueryParams() {
  if (window.location.pathname !== '/kanban') return;
  
  const params = new URLSearchParams(window.location.search);
  
  // Parse department parameter
  const department = params.get('department');
  if (department) {
    const deptFilter = document.getElementById('kanban-filter-dept');
    if (deptFilter) {
      // Check if the department value exists in the dropdown options
      const option = Array.from(deptFilter.options).find(opt => opt.value === department);
      if (option) {
        deptFilter.value = department;
      }
    }
  }
}

// Update URL with current kanban filter state
function updateKanbanURL() {
  if (window.location.pathname !== '/kanban') return; // Only update URL if we're on the kanban page
  
  const params = new URLSearchParams();
  
  const deptFilter = document.getElementById('kanban-filter-dept');
  const priorityFilter = document.getElementById('kanban-filter-priority');
  
  if (deptFilter && deptFilter.value) {
    params.set('department', deptFilter.value);
  }
  
  if (priorityFilter && priorityFilter.value) {
    params.set('priority', priorityFilter.value);
  }
  
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
  if (newUrl !== window.location.pathname + window.location.search) {
    history.pushState(null, '', newUrl);
  }
}

// Parse calendar query parameters from URL and update filter state
function parseCalendarQueryParams() {
  if (window.location.pathname !== '/calendar') return;
  
  const params = new URLSearchParams(window.location.search);
  
  // Parse platform parameter
  const platform = params.get('platform');
  if (platform) {
    const platformFilter = document.getElementById('cal-platform-filter');
    if (platformFilter) {
      // Check if the platform value exists in the dropdown options
      const option = Array.from(platformFilter.options).find(opt => opt.value === platform);
      if (option) {
        platformFilter.value = platform;
      }
    }
  }
}

// Update URL with current calendar filter state  
function updateCalendarURL() {
  if (window.location.pathname !== '/calendar') return; // Only update URL if we're on the calendar page
  
  const params = new URLSearchParams();
  
  const platformFilter = document.getElementById('cal-platform-filter');
  const statusFilter = document.getElementById('cal-status-filter');
  
  if (platformFilter && platformFilter.value) {
    params.set('platform', platformFilter.value);
  }
  
  if (statusFilter && statusFilter.value) {
    params.set('status', statusFilter.value);
  }
  
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
  if (newUrl !== window.location.pathname + window.location.search) {
    history.pushState(null, '', newUrl);
  }
}

// Parse CRM query parameters from URL and update filter state
function parseCrmQueryParams() {
  if (window.location.pathname !== '/crm') return;
  
  const params = new URLSearchParams(window.location.search);
  
  // Parse stage parameter
  const stage = params.get('stage');
  if (stage) {
    const stageFilter = document.getElementById('crm-stage-filter');
    if (stageFilter) {
      // Check if the stage value exists in the dropdown options
      const option = Array.from(stageFilter.options).find(opt => opt.value === stage);
      if (option) {
        stageFilter.value = stage;
      }
    }
  }
}

// Update URL with current CRM filter state
function updateCrmURL() {
  if (window.location.pathname !== '/crm') return; // Only update URL if we're on the CRM page
  
  const params = new URLSearchParams();
  
  const stageFilter = document.getElementById('crm-stage-filter');
  
  if (stageFilter && stageFilter.value) {
    params.set('stage', stageFilter.value);
  }
  
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
  if (newUrl !== window.location.pathname + window.location.search) {
    history.pushState(null, '', newUrl);
  }
}

function statusLabel(s) {
  const map = { open: 'Open', awaiting_david: "Awaiting David's Reply", awaiting_vp: 'Awaiting VP Reply', resolved: 'Resolved', deferred: 'Deferred' };
  return map[s] || s;
}
function severityLabel(s) { return s === 'red' ? 'üî¥ Blocking Revenue' : s === 'yellow' ? 'üü° Blocking Progress' : 'üîµ Decision Pending'; }
function severityShort(s) { return s === 'red' ? 'üî¥ Critical' : s === 'yellow' ? 'üü° Progress' : 'üîµ Decision'; }

async function loadActionCounts() {
  actionCounts = await api('/api/actions/counts');
  renderProFilterBar();
}

function renderActionSummaryCards() { renderProFilterBar(); }
function renderActionFilterChips() { renderProFilterBar(); }

const ACTION_PAGE_SIZE = 25;

async function loadActionItems() {
  const search = document.getElementById('action-search')?.value || '';
  const sort = actionSortField || 'severity';
  let statusParam = actionCurrentFilter;
  
  let url = `/api/actions?page=${actionCurrentPage}&limit=${ACTION_PAGE_SIZE}`;
  if (statusParam) url += `&status=${statusParam}`;
  if (actionCurrentSeverity) url += `&severity=${actionCurrentSeverity}`;
  if (actionCurrentRequester) url += `&requester=${encodeURIComponent(actionCurrentRequester)}`;
  if (actionCurrentOwner) url += `&owner=${encodeURIComponent(actionCurrentOwner)}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;

  const data = await api(url);
  let items = data.items || [];
  actionFilteredTotal = data.total;
  
  // Client-side sort
  const dir = actionSortDir === 'asc' ? 1 : -1;
  const sevOrder = { red: 0, yellow: 1, blue: 2 };
  const statusOrder = { awaiting_david: 0, open: 1, awaiting_vp: 2, deferred: 3, resolved: 4 };
  if (sort === 'severity') items.sort((a, b) => dir * ((sevOrder[a.severity] ?? 9) - (sevOrder[b.severity] ?? 9)));
  else if (sort === 'last_activity') items.sort((a, b) => dir * (new Date(b.last_activity || b.updated_at) - new Date(a.last_activity || a.updated_at)));
  else if (sort === 'title') items.sort((a, b) => dir * (a.title || '').localeCompare(b.title || ''));
  else if (sort === 'owner') items.sort((a, b) => dir * (a.owner || '').localeCompare(b.owner || ''));
  else if (sort === 'status') items.sort((a, b) => dir * ((statusOrder[a.status] ?? 9) - (statusOrder[b.status] ?? 9)));

  renderActionTable(items);
  renderActionPagination(data);
  renderProFilterBar();
  updateSortArrows();
  loadSyncStatus();
}

function renderActionTable(items) {
  const tbody = document.getElementById('action-items-tbody');
  if (!tbody) return;
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-[#64748b]" style="padding:40px;">No action items match this filter</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(a => {
    const stale = Math.floor((new Date() - new Date(a.last_activity || a.updated_at || a.opened_date)) / 864e5);
    const staleTag = ['open', 'awaiting_david'].includes(a.status) && stale >= 3 ? ` <span class="text-xs px-1 py-0.5 rounded bg-red-900/40 text-red-300">‚ö†${stale}d</span>` : '';
    const needsAttention = a.status === 'awaiting_david';
    const dimClass = (a.status === 'resolved' || a.status === 'deferred') ? ' style="opacity:0.5;"' : '';
    const activeClass = actionExpandedId === a.id ? ' active-row' : '';
    const owner = (a.owner || a.requester || '').replace(' (todo-sync)', '');
    return `<tr class="action-row${activeClass}" id="action-row-${a.id}" onclick="openActionPanel(${a.id})"${dimClass}>
      <td>${needsAttention ? '<span class="unread-dot"></span>' : '<span class="sev-dot sev-dot-' + a.severity + '"></span>'}</td>
      <td class="title-cell"><span class="font-medium">${a.title}</span>${staleTag}</td>
      <td class="text-xs text-[#94a3b8]">${owner}</td>
      <td><span class="status-badge status-${a.status}">${statusLabel(a.status)}</span></td>
      <td><span class="sev-badge-${a.severity} px-2 py-0.5 rounded text-xs">${severityShort(a.severity)}</span></td>
      <td class="text-xs text-[#64748b]">${timeAgo(a.last_activity || a.updated_at)}</td>
      <td class="text-xs text-[#64748b]">${a.message_count || ''}</td>
      <td onclick="event.stopPropagation()">
        <div class="summon-dropdown" id="table-summon-${a.id}">
          <button onclick="toggleSummonDropdown('table-summon-${a.id}')" class="btn-ghost text-xs px-2 py-1 text-[#64748b] hover:text-white">üìû</button>
          <div class="summon-dropdown-menu"></div>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ Slide-out Panel ‚îÄ‚îÄ
let panelActionId = null;

function openActionPanel(id) {
  panelActionId = id;
  actionExpandedId = id;
  const panel = document.getElementById('action-detail-panel');
  const overlay = document.getElementById('action-panel-overlay');
  panel.classList.add('open');
  overlay.classList.add('open');
  // Highlight row
  document.querySelectorAll('.action-row').forEach(r => r.classList.remove('active-row'));
  document.getElementById(`action-row-${id}`)?.classList.add('active-row');
  // Update URL
  history.pushState({ section: 'actions', actionId: id }, '', `/actions/${id}`);
  // Load panel content
  loadPanelContent(id);
}

function closeActionPanel() {
  const panel = document.getElementById('action-detail-panel');
  const overlay = document.getElementById('action-panel-overlay');
  panel.classList.remove('open');
  overlay.classList.remove('open');
  document.querySelectorAll('.action-row').forEach(r => r.classList.remove('active-row'));
  if (panelActionId) {
    history.pushState({ section: 'actions', actionId: null }, '', '/actions');
  }
  panelActionId = null;
  actionExpandedId = null;
}

async function loadPanelContent(id) {
  const action = ACTIONS.find(a => a.id === id);
  const titleEl = document.getElementById('panel-title');
  const metaEl = document.getElementById('panel-meta');
  const dotEl = document.getElementById('panel-sev-dot');
  const statusRow = document.getElementById('panel-status-row');
  const threadEl = document.getElementById('panel-thread');
  const actionsEl = document.getElementById('panel-actions');

  if (!action) {
    // Fetch it
    const data = await api(`/api/actions?page=1&limit=999`);
    ACTIONS = data.items || [];
    const a = ACTIONS.find(x => x.id === id);
    if (!a) { threadEl.innerHTML = '<div class="text-center text-[#64748b] py-8">Action item not found</div>'; return; }
    return loadPanelContent(id);
  }

  titleEl.textContent = action.title;
  dotEl.className = `sev-dot sev-dot-${action.severity}`;
  const owner = (action.owner || action.requester || '').replace(' (todo-sync)', '');
  metaEl.innerHTML = `Owner: <strong>${owner}</strong> ¬∑ Opened: ${action.opened_date} ¬∑ Last activity: ${timeAgo(action.last_activity || action.updated_at)}`;

  statusRow.innerHTML = `
    <span class="status-badge status-${action.status}">${statusLabel(action.status)}</span>
    <span class="sev-badge-${action.severity} px-2 py-0.5 rounded text-xs">${severityShort(action.severity)}</span>
  `;

  // Action buttons
  if (action.status !== 'resolved' && action.status !== 'deferred') {
    actionsEl.innerHTML = `
      <div class="summon-dropdown" id="panel-summon-dd">
        <button onclick="toggleSummonDropdown('panel-summon-dd')" class="btn-secondary text-xs px-3 py-1.5 summon-dropdown-btn">üìû Call VP ‚ñæ</button>
        <div class="summon-dropdown-menu" id="panel-summon-menu"></div>
      </div>
      <button onclick="panelDefer()" class="btn-secondary text-xs px-3 py-1.5">‚è∏ Defer</button>
      <button onclick="panelResolve()" class="btn-primary text-xs px-3 py-1.5">‚úÖ Resolve</button>
      <select onchange="panelChangeSeverity(this.value)" class="sort-select" style="padding:4px 8px;font-size:11px;">
        <option value="red" ${action.severity === 'red' ? 'selected' : ''}>üî¥ Critical</option>
        <option value="yellow" ${action.severity === 'yellow' ? 'selected' : ''}>üü° Progress</option>
        <option value="blue" ${action.severity === 'blue' ? 'selected' : ''}>üîµ Decision</option>
      </select>
    `;
  } else {
    actionsEl.innerHTML = `<button onclick="panelReopen()" class="btn-secondary text-xs px-3 py-1.5">‚Ü© Reopen</button>`;
  }

  // Load thread
  threadEl.innerHTML = '<div class="text-xs text-[#64748b] text-center py-4">Loading thread...</div>';
  const messages = await api(`/api/actions/${id}/messages`);
  renderPanelThread(id, action, messages);
}

function renderPanelThread(actionId, action, messages) {
  const threadEl = document.getElementById('panel-thread');
  if (!threadEl) return;

  const descBubble = action && action.description ? `<div class="flex justify-end mb-3">
      <div>
        <div class="text-xs text-[#64748b] mb-1 text-right">${action.requester ? action.requester.replace(' (todo-sync)', '') : 'VP'} ¬∑ opened</div>
        <div class="chat-bubble vp">${action.description.replace(/</g,'&lt;').replace(/\n/g, '<br>')}</div>
      </div>
    </div>` : '';

  const msgsHtml = (descBubble || messages.length) ? descBubble + messages.map(m => {
    const isDavid = m.sender === 'David';
    const isSystem = m.message.startsWith('‚úÖ') || m.message.startsWith('‚è∏') || m.message.startsWith('‚Ü©') || m.message.startsWith('üîÑ') || m.sender === 'System';
    const bubbleClass = isSystem ? 'system' : isDavid ? 'david' : 'vp';
    const align = isSystem ? 'justify-center' : isDavid ? 'justify-start' : 'justify-end';
    return `<div class="flex ${align} mb-3">
      <div>
        ${!isSystem ? `<div class="text-xs text-[#64748b] mb-1 ${isDavid ? '' : 'text-right'}">${m.sender} ¬∑ ${timeAgo(m.created_at)}</div>` : ''}
        <div class="chat-bubble ${bubbleClass}">${m.message.replace(/\n/g, '<br>')}</div>
      </div>
    </div>`;
  }).join('') : '<div class="text-xs text-[#64748b] text-center py-3">No messages yet. Start the conversation below.</div>';

  threadEl.innerHTML = msgsHtml;
  threadEl.scrollTop = threadEl.scrollHeight;
}

async function sendPanelReply() {
  if (!panelActionId) return;
  const input = document.getElementById('panel-reply-input');
  if (!input || !input.value.trim()) return;
  const message = input.value.trim();
  input.value = '';
  input.disabled = true;
  try {
    await api(`/api/actions/${panelActionId}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'David', message }) });
    const messages = await api(`/api/actions/${panelActionId}/messages`);
    const action = ACTIONS.find(a => a.id === panelActionId);
    renderPanelThread(panelActionId, action, messages);
    loadActionCounts();
  } catch (e) { input.value = message; console.error('Failed to send reply:', e); }
  input.disabled = false;
}

async function panelDefer() { if (!panelActionId) return; await api(`/api/actions/${panelActionId}/defer`, { method: 'PATCH', body: JSON.stringify({ notes: 'Deferred by David' }) }); loadActionCounts(); loadActionItems(); loadPanelContent(panelActionId); }
async function panelResolve() { if (!panelActionId) return; quickResolve(panelActionId, document.getElementById('panel-title')?.textContent); }
async function panelChangeSeverity(sev) { if (!panelActionId) return; await api(`/api/actions/${panelActionId}/severity`, { method: 'PATCH', body: JSON.stringify({ severity: sev }) }); const a = ACTIONS.find(x => x.id === panelActionId); if (a) a.severity = sev; loadActionCounts(); loadActionItems(); loadPanelContent(panelActionId); }
async function panelReopen() { if (!panelActionId) return; await api(`/api/actions/${panelActionId}/reopen`, { method: 'PATCH', body: JSON.stringify({}) }); loadActionCounts(); loadActionItems(); loadPanelContent(panelActionId); }

// Legacy compat ‚Äî keep these working for other callers
async function toggleActionThread(id) { openActionPanel(id); }
function renderThread(actionId, messages) { if (panelActionId === actionId) { const action = ACTIONS.find(a => a.id === actionId); renderPanelThread(actionId, action, messages); } }
async function sendActionReply(actionId) { sendPanelReply(); }
async function deferActionItem(id) { panelActionId = id; panelDefer(); }
async function changeActionSeverity(id, severity) { panelActionId = id; panelChangeSeverity(severity); }
async function reopenAction(id) { panelActionId = id; panelReopen(); }

// Keyboard shortcuts for actions
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (document.getElementById('sec-actions')?.classList.contains('hidden')) return;
  if (e.key === 'Escape' && panelActionId) { closeActionPanel(); return; }
  const rows = document.querySelectorAll('.action-row');
  if (!rows.length) return;
  const currentIdx = Array.from(rows).findIndex(r => r.classList.contains('active-row'));
  if (e.key === 'j' || e.key === 'ArrowDown') { e.preventDefault(); const next = Math.min(currentIdx + 1, rows.length - 1); const id = parseInt(rows[next].id.replace('action-row-', '')); openActionPanel(id); }
  if (e.key === 'k' || e.key === 'ArrowUp') { e.preventDefault(); const prev = Math.max(currentIdx - 1, 0); const id = parseInt(rows[prev].id.replace('action-row-', '')); openActionPanel(id); }
  if (e.key === 'r' && panelActionId) { e.preventDefault(); document.getElementById('panel-reply-input')?.focus(); }
});

function renderActionPagination(data) {
  const { page, pages, total } = data;
  const el = document.getElementById('action-pagination');
  if (!el) return;
  if (pages <= 1) { el.innerHTML = `<span class="text-xs text-[#64748b]">${total} item${total !== 1 ? 's' : ''}</span><div></div>`; return; }
  
  let btns = '';
  const maxBtns = 7;
  let start = Math.max(1, page - Math.floor(maxBtns/2));
  let end = Math.min(pages, start + maxBtns - 1);
  start = Math.max(1, end - maxBtns + 1);
  for (let i = start; i <= end; i++) {
    btns += `<button class="pagination-btn ${i === page ? 'active' : ''}" onclick="actionCurrentPage=${i};loadActionItems()">${i}</button>`;
  }
  el.innerHTML = `
    <span class="text-xs text-[#64748b]">${total} items ¬∑ Page ${page} of ${pages}</span>
    <div class="flex gap-1">
      <button class="pagination-btn" onclick="actionCurrentPage=Math.max(1,actionCurrentPage-1);loadActionItems()" ${page <= 1 ? 'disabled' : ''}>‚Äπ</button>
      ${btns}
      <button class="pagination-btn" onclick="actionCurrentPage=Math.min(${pages},actionCurrentPage+1);loadActionItems()" ${page >= pages ? 'disabled' : ''}>‚Ä∫</button>
    </div>`;
}

async function loadSyncStatus() {
  try { const s = await api('/api/actions/sync-status'); document.getElementById('action-sync-time').textContent = `Last synced: ${timeAgo(s.lastSynced)}`; } catch(e) {}
}

async function syncTodoItems() { await api('/api/actions/sync-todo', { method: 'POST' }); loadActionCounts(); loadActionItems(); }

const VP_ROSTER = ['Nadia', 'Max', 'Elena', 'Zara', 'Viktor'];
const summonCooldowns = {};

function toggleSummonDropdown(ddId) {
  const dd = document.getElementById(ddId);
  const wasOpen = dd.classList.contains('open');
  // Close all dropdowns first
  document.querySelectorAll('.summon-dropdown.open').forEach(d => d.classList.remove('open'));
  // Clean up any fixed menus
  document.querySelectorAll('.summon-dropdown-menu.fixed-menu').forEach(m => {
    m.style.display = 'none'; 
    m.classList.remove('fixed-menu');
  });
  
  if (wasOpen) return;
  
  // Build menu
  const menu = dd.querySelector('.summon-dropdown-menu');
  const isHeader = ddId === 'header-summon-dropdown';
  const actionId = isHeader ? null : ddId.replace('summon-dd-', '').replace('table-summon-', '').replace('card-summon-', ''); // Handle various ID formats
  
  menu.innerHTML = VP_ROSTER.map(vp => {
    const key = actionId && !isNaN(parseInt(actionId)) ? `${actionId}-${vp}` : `all-${vp}`;
    const cooled = summonCooldowns[key] && Date.now() - summonCooldowns[key] < 60000;
    return `<div class="summon-dropdown-item ${cooled ? 'summoned' : ''}" onclick="event.stopPropagation();doSummon('${ddId}', ${actionId && !isNaN(parseInt(actionId)) ? actionId : 'null'}, '${vp}', this)">${cooled ? '‚úÖ ' : 'üìû '}${vp}${cooled ? ' (summoned)' : ''}</div>`;
  }).join('') +
    '<div class="summon-dropdown-divider"></div>' +
    `<div class="summon-dropdown-item" onclick="event.stopPropagation();doSummon('${ddId}', ${actionId && !isNaN(parseInt(actionId)) ? actionId : 'null'}, 'ALL', this)" style="font-weight:600;">üìû All VPs</div>`;
  
  dd.classList.add('open');

  // Positioning Fix: Use fixed positioning to escape overflow clipping
  const rect = dd.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.top = (rect.bottom + 5) + 'px';
  menu.style.right = (window.innerWidth - rect.right) + 'px';
  menu.style.left = 'auto';
  menu.style.zIndex = '99999';
  menu.style.display = 'block';
  menu.classList.add('fixed-menu');
}

// Update close handler to hide fixed menus
document.addEventListener('click', (e) => {
  if (!e.target.closest('.summon-dropdown') && !e.target.closest('.summon-dropdown-menu')) {
    document.querySelectorAll('.summon-dropdown.open').forEach(d => d.classList.remove('open'));
    document.querySelectorAll('.summon-dropdown-menu.fixed-menu').forEach(m => {
      m.style.display = 'none';
    });
  }
});

function openNewActionModal() { document.getElementById('new-action-modal').classList.remove('hidden'); document.getElementById('new-action-title').value=''; document.getElementById('new-action-desc').value=''; document.getElementById('new-action-requester').value=''; document.getElementById('new-action-severity').value='yellow'; document.getElementById('new-action-error').classList.add('hidden'); document.getElementById('new-action-char-count').textContent='0'; }
function closeNewActionModal() { document.getElementById('new-action-modal').classList.add('hidden'); }
document.addEventListener('DOMContentLoaded', () => { const d=document.getElementById('new-action-desc'); if(d) d.addEventListener('input', () => { document.getElementById('new-action-char-count').textContent=d.value.trim().length; }); });
async function submitNewAction(e) {
  e.preventDefault();
  const title = document.getElementById('new-action-title').value.trim();
  const description = document.getElementById('new-action-desc').value.trim();
  const requester = document.getElementById('new-action-requester').value.trim();
  const severity = document.getElementById('new-action-severity').value;
  const errEl = document.getElementById('new-action-error');
  if (description.length < 20) { errEl.textContent='Description must be at least 20 characters. Explain what you need and why.'; errEl.classList.remove('hidden'); return; }
  errEl.classList.add('hidden');
  const resp = await fetch('/api/actions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title, description, requester, severity }) });
  if (!resp.ok) { const err = await resp.json(); errEl.textContent=err.error||'Failed to create'; errEl.classList.remove('hidden'); return; }
  closeNewActionModal(); loadActionCounts(); loadActionItems();
}

// Override loadActions to use new system
async function loadActions() {
  await loadActionCounts();
  await loadActionItems();
  STATS = await api('/api/stats');
  renderActions();
  renderCommandCenter();
}

function quickResolve(id, title){
  resolveTargetId=id;
  document.getElementById('resolve-modal').classList.remove('hidden');
  document.getElementById('resolve-modal-title').textContent='Resolve Action Item';
  document.getElementById('resolve-modal-item').textContent=title||'';
  document.getElementById('resolve-notes').value='';
  document.getElementById('resolve-notes').focus();
}
function closeResolveModal(){document.getElementById('resolve-modal').classList.add('hidden');resolveTargetId=null;}
async function confirmResolve(){
  if(!resolveTargetId)return;
  const notes=document.getElementById('resolve-notes').value;
  await api(`/api/actions/${resolveTargetId}/resolve`,{method:'PATCH',body:JSON.stringify({notes})});
  closeResolveModal();loadActions();
}
async function confirmDefer(){
  if(!resolveTargetId)return;
  const notes=document.getElementById('resolve-notes').value;
  await api(`/api/actions/${resolveTargetId}/defer`,{method:'PATCH',body:JSON.stringify({notes})});
  closeResolveModal();loadActions();
}

// Blockers
function renderActions(){
  let filtered=ACTIONS;
  if(currentBlockerFilter==='open')filtered=filtered.filter(a=>a.status==='open');
  else if(['red','yellow','blue'].includes(currentBlockerFilter))filtered=filtered.filter(a=>a.severity===currentBlockerFilter);
  document.getElementById('actions-list').innerHTML=filtered.length===0?'<div class="card p-5 text-center text-[#64748b]">No items match this filter</div>':filtered.map(a=>`<div class="card p-4 severity-${a.severity} ${a.status==='resolved'?'opacity-50':''}"><div class="flex justify-between items-start"><div><div class="font-medium text-sm">${a.title}</div><div class="text-xs text-[#64748b] mt-1">Owner: ${a.owner} ¬∑ ${a.opened_date} (${daysAgo(a.opened_date)})</div></div><div class="flex items-center gap-2 shrink-0"><span class="text-xs px-2 py-0.5 rounded ${a.status==='open'?'bg-red-900/50 text-red-300':'bg-green-900/50 text-green-300'}">${a.status}</span>${a.status==='open'?`<button onclick="resolveAction(${a.id})" class="btn-primary text-xs px-3 py-1">‚úì Resolve</button>`:''}</div></div></div>`).join('');
}
document.querySelectorAll('.blocker-filter').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.blocker-filter').forEach(b=>b.className='text-xs px-3 py-1.5 rounded-full tab-inactive blocker-filter');btn.className='text-xs px-3 py-1.5 rounded-full tab-active blocker-filter';currentBlockerFilter=btn.dataset.filter;renderActions();});});
async function resolveAction(id){quickResolve(id,'');}

// ‚ïê‚ïê‚ïê Sales Funnel (legacy from markdown) ‚ïê‚ïê‚ïê
let revenueChart=null;
async function renderFunnel(){
  let funnel;try{funnel=await api('/api/funnel');}catch(e){return;}
  const stages=funnel.stages||[];const maxCount=Math.max(...stages.map(s=>s.count),1);
  const colors=['#3b82f6','#06b6d4','#8b5cf6','#eab308','#22c55e'];
  document.getElementById('funnel-visual').innerHTML=stages.map((s,i)=>{const pct=Math.max(20,(s.count/maxCount)*100);return `<div class="funnel-stage"><div class="flex justify-between items-center text-xs text-[#94a3b8] mb-1"><span>${s.name}</span><span class="font-bold text-white">${s.count}</span></div><div class="w-full h-8 bg-[#0f1117] rounded-lg overflow-hidden" style="max-width:${pct}%;"><div class="h-full rounded-lg flex items-center justify-center text-xs font-bold" style="background:${colors[i]};width:100%;">${s.count||''}</div></div></div>`;}).join('');
  const allMetrics=funnel.metrics||{};const revenueIndicators=allMetrics['Revenue Indicators']||[];
  if(revenueChart)revenueChart.destroy();
  const canvas=document.getElementById('revenue-chart');
  if(canvas&&revenueIndicators.length){revenueChart=new Chart(canvas,{type:'bar',data:{labels:revenueIndicators.map(m=>m.metric.substring(0,20)),datasets:[{label:'Status',data:revenueIndicators.map(m=>{const v=parseFloat(m.current.replace(/[^0-9.]/g,''));return isNaN(v)?1:v;}),backgroundColor:revenueIndicators.map(m=>kpiStatusColor(m.status)+'88'),borderColor:revenueIndicators.map(m=>kpiStatusColor(m.status)),borderWidth:1,borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{grid:{color:'#2d3148'},ticks:{color:'#64748b'}},x:{grid:{display:false},ticks:{color:'#94a3b8',font:{size:10,family:'Inter'}}}}}});}
  const tasks=funnel.tasks||[];
  document.getElementById('funnel-tasks').innerHTML=tasks.length===0?'<p class="text-sm text-[#64748b]">No sales tasks</p>':`<table class="w-full text-sm"><thead><tr class="text-[#64748b] text-xs"><th class="text-left py-1">Task</th><th class="text-left py-1">Owner</th><th class="text-left py-1">Priority</th><th class="text-left py-1">Status</th></tr></thead><tbody>${tasks.map(t=>`<tr><td class="py-2">${t.title}</td><td class="text-[#94a3b8]">${t.owner||'‚Äî'}</td><td>${priorityBadge(t.priority)}</td><td><span class="text-xs px-2 py-0.5 rounded bg-[#0f1117] text-[#94a3b8]">${t.status.replace('_',' ')}</span></td></tr>`).join('')}</tbody></table>`;
}

// ‚ïê‚ïê‚ïê Report Archive ‚ïê‚ïê‚ïê
async function renderReports(){
  let reports;try{reports=await api('/api/reports');}catch(e){reports=[];}
  const el=document.getElementById('report-file-list');
  if(!reports.length){el.innerHTML='<p class="text-sm text-[#64748b] p-3">No reports found</p>';return;}
  // Group by date
  const byDate={};reports.forEach(r=>{const d=r.modified.split('T')[0];if(!byDate[d])byDate[d]=[];byDate[d].push(r);});
  el.innerHTML=Object.entries(byDate).map(([date,files])=>`
    <div class="mb-2"><div class="text-xs text-[#64748b] px-3 py-1 font-semibold">${date}</div>
    ${files.map(r=>{const icon=r.type==='markdown'?'üìù':r.type==='pdf'?'üìÑ':'üåê';const size=r.size>1024?`${(r.size/1024).toFixed(1)}KB`:`${r.size}B`;return `<div class="px-3 py-2 hover:bg-[#252a40] rounded cursor-pointer text-sm flex justify-between items-center" onclick="viewReport('${r.path}','${r.name}')"><span>${icon} ${r.name}</span><span class="text-xs text-[#64748b]">${size}</span></div>`;}).join('')}
    </div>`).join('');
}
async function viewReport(path,name){
  document.getElementById('report-viewer-title').textContent=name;
  document.getElementById('report-print-btn').classList.remove('hidden');
  try{const data=await api(`/api/reports/${encodeURIComponent(path)}`);let html=(data.content||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  html=html.replace(/^### (.+)$/gm,'<h3 class="text-base font-semibold text-white mt-4 mb-2">$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2 class="text-lg font-bold text-white mt-5 mb-2">$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1 class="text-xl font-bold text-white mt-5 mb-3">$1</h1>');
  html=html.replace(/\*\*(.+?)\*\*/g,'<strong class="text-white">$1</strong>');
  html=html.replace(/^\- (.+)$/gm,'<li class="ml-4">‚Ä¢ $1</li>');
  html=html.replace(/^\d+\. (.+)$/gm,'<li class="ml-4">$1</li>');
  html=html.replace(/^---$/gm,'<hr class="border-[#2d3148] my-4">');
  html=html.replace(/\n\n/g,'<br><br>');
  document.getElementById('report-viewer').innerHTML=html;}catch(e){document.getElementById('report-viewer').innerHTML='<p class="text-red-400">Failed to load report</p>';}
}
function printReport(){const content=document.getElementById('report-viewer').innerHTML;const w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><head><title>${document.getElementById('report-viewer-title').textContent}</title><style>body{font-family:Inter,system-ui,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#333;line-height:1.6;}h1{font-size:24px;border-bottom:2px solid #3b82f6;padding-bottom:8px;}h2{font-size:18px;margin-top:24px;}h3{font-size:15px;margin-top:16px;}li{margin:4px 0;}hr{margin:16px 0;}strong{font-weight:600;}</style></head><body>${content}<script>setTimeout(()=>window.print(),300)<\/script></body></html>`);w.document.close();}

// ‚ïê‚ïê‚ïê PDF Export ‚ïê‚ïê‚ïê
async function exportSummary(){
  const data=await api('/api/export/summary');
  const byStatus=data.overview.byStatus||{};
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Mission Control Summary</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Inter',system-ui,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#e2e8f0;background:#0f1117;}
    h1{font-size:24px;border-bottom:2px solid #3b82f6;padding-bottom:12px;color:white;}h2{font-size:18px;margin-top:28px;color:#94a3b8;border-left:3px solid #3b82f6;padding-left:12px;}
    table{width:100%;border-collapse:collapse;margin:12px 0;}th,td{text-align:left;padding:8px 12px;border-bottom:1px solid #2d3148;font-size:13px;}
    th{color:#94a3b8;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;}
    .badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;}
    .red{background:#3b1111;color:#ef4444;}.yellow{background:#3b3b11;color:#eab308;}.blue{background:#112244;color:#3b82f6;}.green{background:#113311;color:#22c55e;}
    .stat{display:inline-block;margin-right:24px;}.stat-value{font-size:28px;font-weight:700;color:white;}.stat-label{font-size:12px;color:#64748b;}
    @media print{body{padding:20px;background:white;color:#333;}h1{color:#333;border-color:#333;}h2{color:#555;}th{color:#666;}td{border-color:#ddd;}.stat-value{color:#333;}}</style></head><body>
    <h1>üéØ Amtecco Mission Control ‚Äî Weekly Summary</h1>
    <p style="color:#64748b;font-size:13px;">Generated: ${new Date(data.generated).toLocaleString()} ¬∑ Confidential ‚Äî Amtecco</p>
    <div style="margin:24px 0;">
      <div class="stat"><div class="stat-value">${data.overview.totalTasks}</div><div class="stat-label">Total Tasks</div></div>
      <div class="stat"><div class="stat-value" style="color:#3b82f6">${byStatus.in_progress||0}</div><div class="stat-label">In Progress</div></div>
      <div class="stat"><div class="stat-value" style="color:#22c55e">${byStatus.done||0}</div><div class="stat-label">Completed</div></div>
      <div class="stat"><div class="stat-value" style="color:#ef4444">${data.overview.blockers}</div><div class="stat-label">Blockers</div></div>
    </div>
    <h2>Milestones</h2><table><tr><th>Name</th><th>Department</th><th>Target Date</th><th>Status</th></tr>${data.milestones.map(m=>`<tr><td>${m.name}</td><td>${m.dept}</td><td>${m.date||'TBD'}</td><td>${m.status}</td></tr>`).join('')}</table>
    <h2>Department Progress</h2><table><tr><th>Department</th><th>Total</th><th>In Progress</th><th>Done</th></tr>${Object.entries(data.tasksByDept).map(([d,v])=>`<tr><td>${d}</td><td>${v.total}</td><td>${v.inProgress}</td><td>${v.done}</td></tr>`).join('')}</table>
    <h2>Open Action Items</h2><table><tr><th>Item</th><th>Severity</th><th>Owner</th><th>Opened</th></tr>${data.actions.map(a=>`<tr><td>${a.title}</td><td><span class="badge ${a.severity}">${a.severity.toUpperCase()}</span></td><td>${a.owner}</td><td>${a.opened}</td></tr>`).join('')}</table>
    <h2>KPIs</h2><table><tr><th>Department</th><th>KPI</th><th>Current</th><th>Target</th><th>Status</th></tr>${data.kpis.map(k=>`<tr><td>${k.dept}</td><td>${k.name}</td><td>${k.current}</td><td>${k.target}</td><td>${k.status}</td></tr>`).join('')}</table>
    <div style="margin-top:40px;padding-top:16px;border-top:1px solid #2d3148;text-align:center;font-size:11px;color:#64748b;">Confidential ‚Äî Amtecco ¬∑ Page 1</div>
    <script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
  w.document.close();
}

// ‚ïê‚ïê‚ïê Remaining sections ‚ïê‚ïê‚ïê
function renderPriorities(){document.getElementById('priorities-list').innerHTML=(DATA.priorities||[]).map(s=>`<div class="card p-5"><h3 class="font-semibold text-blue-400 mb-3">${s.title}</h3><ul class="space-y-2">${s.items.map((it,i)=>`<li class="text-sm flex gap-2"><span class="text-[#64748b] shrink-0">${i+1}.</span><span>${it}</span></li>`).join('')}</ul></div>`).join('');}
function renderInitiatives(){document.getElementById('initiatives-list').innerHTML=(DATA.initiatives||[]).map(i=>`<div class="card p-5 ${i.category==='Deferred'?'opacity-60':''}"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">${i.name}</h3><span class="text-xs px-2 py-0.5 rounded-full ${i.category==='Active'?'bg-green-900 text-green-300':'bg-slate-700 text-[#94a3b8]'}">${i.category}</span></div><div class="text-sm text-[#94a3b8] space-y-1">${Object.entries(i.details).map(([k,v])=>`<div><span class="text-[#64748b]">${k}:</span> ${v}</div>`).join('')}</div></div>`).join('');}
function renderReporting(){document.getElementById('reporting-table').innerHTML=(DATA.reporting||[]).map(r=>`<tr><td class="px-5 py-3 font-medium">${r.report}</td><td class="px-3 py-3">${r.frequency}</td><td class="px-3 py-3 text-[#94a3b8]">${r.flow}</td><td class="px-3 py-3">${r.nextDue}</td><td class="px-3 py-3">${statusBadge(r.status)}</td></tr>`).join('');}
function renderRevenue(){document.getElementById('revenue-grid').innerHTML=Object.entries(DATA.revenue||{}).map(([cat,ms])=>`<div class="card"><div class="card-header px-5 py-3 font-semibold text-sm">${cat}</div><table class="w-full text-sm">${ms.map(m=>`<tr><td class="px-5 py-2.5">${m.metric}</td><td class="px-3 py-2.5 text-[#94a3b8]">${m.current}</td><td class="px-3 py-2.5 text-[#64748b]">${m.target}</td><td class="px-3 py-2.5">${statusBadge(m.status)}</td></tr>`).join('')}</table></div>`).join('');}

// ‚ïê‚ïê‚ïê Sync Dashboard ‚ïê‚ïê‚ïê
const SYNC_SOURCE_META = {
  crm: { icon: 'üîÑ', label: 'CRM (Twenty)', color: 'blue' },
  action_items: { icon: 'üìù', label: 'Action Items & VP Blockers', color: 'amber' },
  kpis: { icon: 'üìà', label: 'KPI Snapshots', color: 'purple' },
  tasks: { icon: 'üìã', label: 'Tasks & VP Status', color: 'green' },
};

async function renderSyncStatus() {
  try {
    const statuses = await api('/api/sync/status');
    const grid = document.getElementById('sync-grid');
    if (!grid) return;
    const sources = ['crm', 'action_items', 'kpis', 'tasks'];
    grid.innerHTML = sources.map(src => {
      const s = statuses.find(x => x.source === src);
      const meta = SYNC_SOURCE_META[src] || { icon: '‚ùì', label: src, color: 'slate' };
      const lastSync = s ? timeAgo(s.last_sync) : 'Never';
      const statusOk = s && s.status === 'ok';
      const details = s ? s.details : 'Not yet synced';
      return `<div class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <span class="text-2xl">${meta.icon}</span>
            <div>
              <div class="font-semibold">${meta.label}</div>
              <div class="text-xs text-[#64748b]">${details}</div>
            </div>
          </div>
          <span class="status-icon ${statusOk ? 'bg-green-500 pulse' : s ? 'bg-red-500' : 'bg-slate-600'}"></span>
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-[#94a3b8]">Last synced</span>
          <span class="${statusOk ? 'text-green-400' : 'text-[#94a3b8]'} font-medium">${lastSync}</span>
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.error('Sync status load error:', e); }
}

async function syncAll() {
  const btn = document.getElementById('sync-all-btn');
  const spinner = document.getElementById('sync-spinner');
  btn.disabled = true;
  spinner.classList.remove('hidden');
  try {
    await api('/api/sync/all', { method: 'POST' });
    await renderSyncStatus();
    await loadAll();
  } catch (e) { console.error('Sync all error:', e); }
  btn.disabled = false;
  spinner.classList.add('hidden');
}

// ‚ïê‚ïê‚ïê Organization Page ‚ïê‚ïê‚ïê
let orgAgents = [];
let orgTokenUsage = [];
let orgPanelOpen = false;
let fleetMode = false;

function toggleFleetMode() {
  fleetMode = !fleetMode;
  renderOrgSummary();
  renderOrgTree();
}

function deptClass(dept) {
  if (!dept) return 'dept-ops';
  if (dept.includes('Engineering')) return 'dept-eng';
  if (dept.includes('Research')) return 'dept-ri';
  if (dept.includes('Marketing')) return 'dept-mc';
  if (dept.includes('Sales')) return 'dept-sbd';
  if (dept.includes('Design')) return 'dept-db';
  return 'dept-ops';
}

function modelShort(m) {
  if (!m) return '';
  if (m === 'human') return 'üë§ Human';
  if (m.includes('opus-4-6')) return 'Opus 4.6';
  if (m.includes('opus-4')) return 'Opus 4';
  if (m.includes('sonnet-4.5')) return 'Sonnet 4.5';
  if (m.includes('haiku-4.5')) return 'Haiku 4.5';
  if (m.includes('gemini-3-pro')) return 'Gemini Pro';
  if (m.includes('gemini-3-flash')) return 'Gemini Flash';
  if (m.includes('gpt-5.2-mini')) return 'GPT-5.2 Mini';
  if (m.includes('gpt-5.2')) return 'GPT-5.2';
  return m.split('/').pop();
}

function relTime(iso) {
  if (!iso) return '‚Äî';
  const diff = new Date(iso) - new Date();
  const absDiff = Math.abs(diff);
  const mins = Math.floor(absDiff/60000);
  const hrs = Math.floor(mins/60);
  const days = Math.floor(hrs/24);
  if (days > 0) return diff > 0 ? `in ${days}d` : `${days}d ago`;
  if (hrs > 0) return diff > 0 ? `in ${hrs}h` : `${hrs}h ago`;
  if (mins > 0) return diff > 0 ? `in ${mins}m` : `${mins}m ago`;
  return 'just now';
}

function orgCardHtml(a) {
  const isActive = a.status === 'active';
  const dc = deptClass(a.department);
  const taskLine = isActive && a.current_task
    ? `<div class="task-text" title="${(a.current_task||'').replace(/"/g,'&quot;')}">üîß ${a.current_task}</div>`
    : a.last_task
      ? `<div class="task-text">Last: ${a.last_task}</div>`
      : '';
  const wakeLine = !isActive && a.next_wake_at ? `<div class="task-text">‚è∞ ${relTime(a.next_wake_at)}</div>` : '';
  return `<div class="org-card ${isActive?'active-agent':''}" onclick="openOrgPanel('${a.agent_id}')">
    <div class="flex items-center gap-2"><span class="status-dot ${isActive?'active':'sleeping'}"></span><span class="agent-name">${a.name}</span></div>
    <div class="agent-role">${a.role}</div>
    ${a.department ? `<span class="agent-dept ${dc}">${a.department}</span>` : ''}
    <span class="model-pill">${modelShort(a.model)}</span>
    ${taskLine}${wakeLine}
  </div>`;
}

async function loadOrgData() {
  const [agents, tokenUsage] = await Promise.all([
    api('/api/org/agents'),
    api('/api/org/token-usage/by-provider')
  ]);
  orgAgents = agents;
  orgTokenUsage = tokenUsage || [];
  renderOrgSummary();
  renderOrgTree();
  document.getElementById('org-refresh-time').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

function renderOrgSummary() {
  const active = orgAgents.filter(a => a.status === 'active').length;
  const sleeping = orgAgents.length - active;
  
  // Default limits (fallback if API doesn't provide them)
  const defaultLimits = { 'Anthropic': 50000, 'Google': 50000, 'OpenAI': 50000, 'Groq': 10000, 'unknown': 10000 };
  
  // Map API provider names to display names
  const providerMap = {
    'anthropic': 'Anthropic',
    'google': 'Google',
    'openai': 'OpenAI',
    'groq': 'Groq'
  };
  
  // Process token usage data from API
  // Stores: { provider: { inputTokens, outputTokens, totalTokens, cost, limit, percentage } }
  const providerData = {};
  
  if (orgTokenUsage && orgTokenUsage.length > 0) {
    // Use real token usage data from API
    orgTokenUsage.forEach(u => {
      const displayName = providerMap[u.provider?.toLowerCase()] || u.provider || 'unknown';
      providerData[displayName] = {
        inputTokens: u.total_input_tokens || 0,
        outputTokens: u.total_output_tokens || 0,
        totalTokens: u.total_tokens || 0,
        cost: u.total_cost_usd || 0,
        limit: u.limit || defaultLimits[displayName] || 10000,
        percentage: u.usage_percentage || 0
      };
    });
  }
  
  // Check if we have token data (for fallback logic)
  const hasTokenData = Object.keys(providerData).length > 0;
  
  // Format number with K/M suffixes
  function fmtNum(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toString();
  }
  
  // Format currency
  function fmtCost(c) {
    if (c >= 1000) return '$' + (c / 1000).toFixed(1) + 'k';
    return '$' + c.toFixed(0);
  }

  // Generate provider usage HTML
  const provHtml = Object.entries(providerData).map(([p, data]) => {
    const pct = Math.min(100, data.percentage || ((data.cost / data.limit) * 100));
    const color = pct >= 100 ? '#ef4444' : pct >= 80 ? '#eab308' : '#3b82f6';
    const limitDisplay = data.limit >= 1000 ? '$' + (data.limit / 1000).toFixed(0) + 'k' : '$' + data.limit;
    
    return `
      <div class="flex-1 min-w-[160px] p-2 rounded-lg bg-[#0f172a] border border-[#1e293b]">
        <div class="flex justify-between items-center mb-2">
          <span class="text-xs font-semibold text-[#e2e8f0]">${p}</span>
          <span class="text-[10px] text-[#64748b]">${pct.toFixed(1)}%</span>
        </div>
        <div class="h-1.5 bg-[#1e293b] rounded-full overflow-hidden mb-2">
          <div class="h-full rounded-full transition-all duration-500" style="width:${pct}%; background:${color}"></div>
        </div>
        <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[10px]">
          <div><span class="text-[#64748b]">In:</span> <span class="text-[#94a3b8]">${fmtNum(data.inputTokens)}</span></div>
          <div><span class="text-[#64748b]">Out:</span> <span class="text-[#94a3b8]">${fmtNum(data.outputTokens)}</span></div>
          <div><span class="text-[#64748b]">Cost:</span> <span class="text-[#22c55e]">${fmtCost(data.cost)}</span></div>
          <div><span class="text-[#64748b]">Limit:</span> <span class="text-[#94a3b8]">${limitDisplay}</span></div>
        </div>
      </div>
    `;
  }).join('');

  // Show token usage section if we have data, otherwise show message
  const tokenUsageSection = hasTokenData 
    ? provHtml 
    : `<div class="text-xs text-[#64748b] italic">No token usage data available</div>`;

  document.getElementById('org-summary').innerHTML = `
    <div class="flex justify-between items-center w-full mb-4">
      <div class="flex gap-6">
        <div class="org-summary-stat"><div class="num">${orgAgents.length}</div><div class="lbl">Agents</div></div>
        <div class="org-summary-stat"><div class="num" style="color:#22c55e">${active}</div><div class="lbl">Active</div></div>
        <div class="org-summary-stat"><div class="num" style="color:#64748b">${sleeping}</div><div class="lbl">Sleeping</div></div>
      </div>
      <div class="flex gap-4 items-center">
        <div class="flex gap-2 bg-[#1e293b] p-2 rounded-lg border border-[#334155] mr-4 overflow-x-auto">
          ${tokenUsageSection}
        </div>
        <button onclick="toggleFleetMode()" class="btn-secondary text-xs px-3 py-1.5 ${fleetMode ? 'bg-blue-900/50 border-blue-500 text-blue-200' : ''}">
          üõ†Ô∏è Manage Fleet
        </button>
      </div>
    </div>
  `;
}

function renderOrgTree() {
  const byMgr = {};
  orgAgents.forEach(a => {
    const key = a.reports_to || '__root__';
    if (!byMgr[key]) byMgr[key] = [];
    byMgr[key].push(a);
  });

  const ceo = orgAgents.find(a => !a.reports_to);
  const coo = orgAgents.find(a => a.reports_to === 'david' && a.agent_id !== 'david');
  const vps = byMgr['main'] || [];

  let html = '';
  // CEO
  if (ceo) html += `<div class="org-level">${orgCardHtml(ceo)}</div><div class="org-connector">‚îÇ</div>`;
  // COO
  if (coo) html += `<div class="org-level">${orgCardHtml(coo)}</div><div class="org-connector">‚îÇ</div>`;
  // VPs
  html += `<div class="org-level">${vps.map(v => orgCardHtml(v)).join('')}</div>`;

  // Department groups
  const depts = [...new Set(vps.map(v => v.department).filter(Boolean))];
  const collapsedDepts = {};
  for (const dept of depts) {
    const vp = vps.find(v => v.department === dept);
    const subs = byMgr[vp?.agent_id] || [];
    const deptId = dept.replace(/[^a-zA-Z]/g,'');

    // Engineering uses AntFarm ‚Äî show workflow cards instead of agents
    if (dept.includes('Engineering')) {
      const workflows = [
        { id: 'feature-dev', name: 'Feature Dev', icon: 'üöÄ', agents: 'Planner ‚Üí Setup ‚Üí Developer ‚Üí Verifier ‚Üí Tester ‚Üí Reviewer', model: 'Sonnet 4' },
        { id: 'bug-fix', name: 'Bug Fix', icon: 'üêõ', agents: 'Triager ‚Üí Investigator ‚Üí Setup ‚Üí Fixer ‚Üí Verifier ‚Üí PR Creator', model: 'Sonnet 4' },
        { id: 'security-audit', name: 'Security Audit', icon: 'üîí', agents: 'Scanner ‚Üí Prioritizer ‚Üí Setup ‚Üí Fixer ‚Üí Verifier ‚Üí Tester', model: 'Sonnet 4' }
      ];
      const wfCards = workflows.map(w => `
        <div class="org-card" style="cursor:default;min-width:220px;max-width:280px">
          <div class="flex items-center gap-2">
            <span style="font-size:16px">${w.icon}</span>
            <span class="agent-name">${w.name}</span>
          </div>
          <div class="agent-role" style="margin-top:4px">${w.agents}</div>
          <span class="agent-dept dept-eng">AntFarm Workflow</span>
          <span class="model-pill">${w.model}</span>
        </div>
      `).join('');
      html += `<div class="org-dept-group">
        <div class="org-dept-header" onclick="toggleDeptGroup('${deptId}')">‚ñº ${dept} ‚Äî Runs with AntFarm (3 workflows, 18 agents)</div>
        <div class="org-level" id="dept-${deptId}">${wfCards}</div>
      </div>`;
      continue;
    }

    if (subs.length === 0) continue;
    html += `<div class="org-dept-group">
      <div class="org-dept-header" onclick="toggleDeptGroup('${deptId}')">‚ñº ${dept} (${subs.length})</div>
      <div class="org-level" id="dept-${deptId}">${subs.map(s => orgCardHtml(s)).join('')}</div>
    </div>`;
  }
  document.getElementById('org-tree').innerHTML = html;
}

function toggleDeptGroup(deptId) {
  const el = document.getElementById('dept-' + deptId);
  if (!el) return;
  const isHidden = el.style.display === 'none';
  el.style.display = isHidden ? 'flex' : 'none';
  el.previousElementSibling.textContent = el.previousElementSibling.textContent.replace(/^[‚ñº‚ñ∂]/, isHidden ? '‚ñº' : '‚ñ∂');
}

async function openOrgPanel(agentId) {
  const data = await api(`/api/org/agents/${agentId}`);
  const a = data;
  const isActive = a.status === 'active';
  const dc = deptClass(a.department);
  const caps = (a.capabilities||[]).map(c => `<span class="cap-pill">${c}</span>`).join('');
  const activity = (a.recent_activity||[]).map(act => `<div class="activity-item"><strong>${act.task}</strong><br><span style="color:var(--text-secondary)">${act.status} ¬∑ ${relTime(act.completed_at)}</span></div>`).join('') || '<div class="text-xs text-[#64748b]">No recent activity</div>';

  const wakeSection = !isActive && a.model !== 'human' ? `
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
      <h4 style="font-size:13px;font-weight:600;margin-bottom:8px">üöÄ Wake Up ${a.name}</h4>
      <input class="wake-input" id="wake-msg" placeholder="What should ${a.name} work on?">
      <button class="wake-btn" onclick="wakeAgent('${a.agent_id}','${a.name}')">Send Wake Request</button>
    </div>` : '';

  document.getElementById('org-panel-content').innerHTML = `
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span class="status-dot ${isActive?'active':'sleeping'}"></span>
        <span style="font-size:20px;font-weight:700">${a.name}</span>
      </div>
      <div style="color:var(--text-secondary);font-size:14px">${a.role}</div>
      ${a.department ? `<span class="agent-dept ${dc}" style="margin-top:8px">${a.department}</span>` : ''}
    </div>
    <div style="margin-bottom:16px">
      <div class="text-xs text-[#64748b] uppercase mb-1">Model</div>
      <div class="model-pill" style="font-size:11px">${a.model}</div>
    </div>
    <div style="margin-bottom:16px">
      <div class="text-xs text-[#64748b] uppercase mb-1">Status</div>
      <div style="font-size:13px">${isActive ? 'üü¢ Active' : 'üí§ Sleeping'}${a.last_active_at ? ' ¬∑ Last active: '+relTime(a.last_active_at) : ''}</div>
      ${isActive && a.current_task ? `<div style="font-size:13px;margin-top:4px">üîß ${a.current_task}</div>` : ''}
      ${!isActive && a.last_task ? `<div style="font-size:13px;margin-top:4px;color:var(--text-secondary)">Last: ${a.last_task}</div>` : ''}
      ${a.next_wake_at ? `<div style="font-size:13px;margin-top:4px">‚è∞ Next wake: ${relTime(a.next_wake_at)}</div>` : ''}
    </div>
    ${caps ? `<div style="margin-bottom:16px"><div class="text-xs text-[#64748b] uppercase mb-1">Capabilities</div><div>${caps}</div></div>` : ''}
    <div style="margin-bottom:16px">
      <div class="text-xs text-[#64748b] uppercase mb-1">Recent Activity</div>
      ${activity}
    </div>
    ${wakeSection}
  `;
  document.getElementById('org-panel').classList.add('open');
  orgPanelOpen = true;
}

function closeOrgPanel() {
  document.getElementById('org-panel').classList.remove('open');
  orgPanelOpen = false;
}

async function wakeAgent(agentId, name) {
  const msg = document.getElementById('wake-msg').value;
  if (!msg.trim()) return;
  await api(`/api/org/agents/${agentId}/wake`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ message:msg, requested_by:'David' }) });
  const toast = document.getElementById('org-toast');
  toast.textContent = `Request sent to Sylvia. ${name} will be spawned shortly.`;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
  document.getElementById('wake-msg').value = '';
}

// Auto-refresh org data every 15s
setInterval(() => { if (!document.getElementById('sec-org').classList.contains('hidden')) loadOrgData(); }, 15000);

// ‚ïê‚ïê‚ïê URL-Based Router Infrastructure ‚ïê‚ïê‚ïê

// Route-to-section mapping
const routeMap = {
  '/dashboard': 'command',
  '/kanban': 'kanban', 
  '/actions': 'actions',
  '/gantt': 'gantt',
  '/timeline': 'gantt',
  '/calendar': 'calendar',
  '/org': 'org',
  '/vendors': 'vendors',
  '/sync': 'sync',
  '/crm': 'pipeline',
  '/funnel': 'funnel',
  '/departments': 'departments',
  '/kpis': 'kpis',
  '/blockers': 'blockers',
  '/reports': 'reports',
  '/priorities': 'priorities',
  '/initiatives': 'initiatives',
  '/reporting': 'reporting',
  '/revenue': 'revenue',
  '/visual-requests': 'visual-requests',
  '/research-requests': 'research-requests'
};

// Section-to-route mapping (reverse lookup)
const sectionToRoute = {};
Object.entries(routeMap).forEach(([route, section]) => {
  sectionToRoute[section] = route;
});

// Router function using History API
function navigateToRoute(path, pushState = true) {
  // Handle action item deep links (/actions/123)
  let section = routeMap[path];
  let actionId = null;
  
  if (path.startsWith('/actions/')) {
    section = 'actions';
    actionId = path.split('/')[2];
  }
  
  // Default to dashboard if route not found
  if (!section) {
    section = 'command';
    path = '/dashboard';
  }
  
  // Update URL if requested
  if (pushState) {
    history.pushState({ section, actionId }, '', path);
  }
  
  // Show the correct section
  document.querySelectorAll('#main > section').forEach(s => s.classList.add('hidden'));
  document.getElementById(`sec-${section}`).classList.remove('hidden');
  
  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
  
  // Handle special section logic
  if (section === 'sync') renderSyncStatus();
  if (section === 'org') loadOrgData();
  if (section === 'vendors') {
    loadFiltersFromURL();
    loadVendors();
  }
  
  // Parse query parameters for actions page
  if (section === 'actions' && !actionId) {
    parseActionQueryParams();
  }
  
  // Parse query parameters for kanban page
  if (section === 'kanban') {
    parseKanbanQueryParams();
  }
  
  // Parse query parameters for calendar page
  if (section === 'calendar') {
    parseCalendarQueryParams();
  }
  
  // Parse query parameters for crm page
  if (section === 'pipeline') {
    parseCrmQueryParams();
  }
  
  if (section === 'visual-requests') {
    loadVisualRequests();
  }
  
  if (section === 'research-requests') {
    loadResearchRequests();
  }
  
  // Handle action item deep linking
  if (section === 'actions' && actionId) {
    // Use the newer loadActionItemsAndExpand function for better deep linking
    loadActionItemsAndExpand(parseInt(actionId));
  }
  
  // Close mobile menu
  document.getElementById('sidebar').classList.remove('mobile-open');
}

// Handle browser back/forward buttons
window.onpopstate = function(event) {
  const path = window.location.pathname;
  navigateToRoute(path, false);
};

// Initialize from URL on page load - determines which page to show based on current URL
function initializeFromURL() {
  const currentPath = window.location.pathname;
  // Handle default route (/) to show dashboard
  const path = currentPath === '/' ? '/dashboard' : currentPath;
  
  // Parse query parameters for actions page
  if (path === '/actions') {
    parseActionQueryParams();
  }
  
  // Parse query parameters for kanban page
  if (path === '/kanban') {
    parseKanbanQueryParams();
  }
  
  // Parse query parameters for calendar page
  if (path === '/calendar') {
    parseCalendarQueryParams();
  }
  
  // Parse query parameters for crm page
  if (path === '/crm') {
    parseCrmQueryParams();
  }
  
  navigateToRoute(path, false);
}

// Legacy navigate function for backward compatibility
function navigate(section) {
  const route = sectionToRoute[section] || '/dashboard';
  navigateToRoute(route);
}

// Set up nav item click handlers for SPA routing
document.querySelectorAll('.nav-item').forEach(n => {
  n.addEventListener('click', e => {
    e.preventDefault();
    const route = n.getAttribute('href');
    navigateToRoute(route);
  });
});

// ‚ïê‚ïê‚ïê Go to Action Item ‚ïê‚ïê‚ïê
function goToActionItem(actionId) {
  // Navigate to actions page using new URL routing
  navigateToRoute(`/actions/${actionId}`);
}

async function loadActionItemsAndExpand(targetId) {
  // Load all items to find the target page
  const data = await api(`/api/actions?page=1&limit=999`);
  ACTIONS = data.items || [];
  const idx = ACTIONS.findIndex(a => a.id === targetId);
  if (idx >= 0) {
    actionCurrentPage = Math.floor(idx / ACTION_PAGE_SIZE) + 1;
  }
  await loadActionItems();
  // Open panel after render
  setTimeout(() => {
    openActionPanel(targetId);
    const row = document.getElementById(`action-row-${targetId}`);
    if (row) {
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      row.style.boxShadow = '0 0 0 2px var(--accent)';
      setTimeout(() => { row.style.boxShadow = ''; }, 3000);
    }
  }, 200);
}

// Handle hash on page load
function checkHashNavigation() {
  const hash = window.location.hash;
  if (hash.startsWith('#action-')) {
    const id = parseInt(hash.replace('#action-', ''));
    if (id) goToActionItem(id);
  }
}

// ‚ïê‚ïê‚ïê Incremental Refresh (preserves UI state) ‚ïê‚ïê‚ïê
async function incrementalRefresh() {
  try {
    // Fetch fresh data in parallel
    const [newData, newStats, newKpis, newGantt, newCounts] = await Promise.all([
      api('/api/data'), api('/api/stats'), api('/api/kpis'), api('/api/gantt'), api('/api/actions/counts')
    ]);

    // Update global state
    DATA = newData;
    STATS = newStats;
    KPIS = newKpis;
    GANTT = newGantt;
    actionCounts = newCounts;

    // Update non-action sections (these don't have input fields)
    document.getElementById('update-time').textContent = `Updated: ${DATA.lastUpdated || 'Unknown'}`;
    renderCommandCenter();
    renderKanban();
    renderGantt();
    renderPriorities();
    renderInitiatives();
    renderReporting();
    renderRevenue();

    // Update action items in-place (without destroying DOM)
    refreshActionItemsInPlace();

    // Refresh pipeline
    loadPipeline();

    // If an action thread is expanded, append any new messages
    if (actionExpandedId) {
      refreshExpandedThread(actionExpandedId);
    }
  } catch (e) {
    console.error('Incremental refresh error:', e);
  }
}

function refreshActionItemsInPlace() {
  // Update summary bar and filter chips from cached counts
  renderActionSummaryCards();
  renderActionFilterChips();
  loadSyncStatus();

  const tbody = document.getElementById('action-items-tbody');
  if (!tbody) return;

  // Fetch current page items for in-place updates
  const search = document.getElementById('action-search')?.value || '';
  let statusParam = actionCurrentFilter;
  let url = `/api/actions?page=${actionCurrentPage}&limit=${ACTION_PAGE_SIZE}`;
  if (statusParam) url += `&status=${statusParam}`;
  if (actionCurrentSeverity) url += `&severity=${actionCurrentSeverity}`;
  if (actionCurrentRequester) url += `&requester=${encodeURIComponent(actionCurrentRequester)}`;
  if (actionCurrentOwner) url += `&owner=${encodeURIComponent(actionCurrentOwner)}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;

  api(url).then(data => {
    let items = data.items || [];

    // Update rows in-place
    for (const a of items) {
      const row = document.getElementById(`action-row-${a.id}`);
      if (!row) continue;
      // Update status badge
      const statusEl = row.querySelector('.status-badge');
      if (statusEl) { statusEl.className = `status-badge status-${a.status}`; statusEl.textContent = statusLabel(a.status); }
      // Update severity badge
      const sevEl = row.querySelector('[class*="sev-badge-"]');
      if (sevEl) { sevEl.className = `sev-badge-${a.severity} px-2 py-0.5 rounded text-xs`; sevEl.textContent = severityShort(a.severity); }
    }

    renderActionPagination(data);

    // If row count changed, full re-render
    const existingRows = tbody.querySelectorAll('.action-row');
    if (existingRows.length !== items.length) {
      renderActionTable(items);
    }
  });
}

async function refreshExpandedThread(actionId) {
  // Refresh thread in the slide-out panel
  const threadEl = document.getElementById('panel-thread');
  if (!threadEl || panelActionId !== actionId) return;

  const messages = await api(`/api/actions/${actionId}/messages`);
  const currentMsgCount = threadEl.querySelectorAll('.chat-bubble').length;

  if (messages.length > currentMsgCount) {
    const action = ACTIONS.find(a => a.id === actionId);
    const newMsgs = messages.slice(currentMsgCount);
    for (const m of newMsgs) {
      const isDavid = m.sender === 'David';
      const isSystem = m.message.startsWith('‚úÖ') || m.message.startsWith('‚è∏') || m.message.startsWith('‚Ü©') || m.message.startsWith('üîÑ') || m.sender === 'System';
      const bubbleClass = isSystem ? 'system' : isDavid ? 'david' : 'vp';
      const align = isSystem ? 'justify-center' : isDavid ? 'justify-start' : 'justify-end';
      const html = `<div class="flex ${align} mb-3">
        <div>
          ${!isSystem ? `<div class="text-xs text-[#64748b] mb-1 ${isDavid ? '' : 'text-right'}">${m.sender} ¬∑ ${timeAgo(m.created_at)}</div>` : ''}
          <div class="chat-bubble ${bubbleClass}">${m.message.replace(/\n/g, '<br>')}</div>
        </div>
      </div>`;
      threadEl.insertAdjacentHTML('beforeend', html);
    }
    const nearBottom = threadEl.scrollHeight - threadEl.scrollTop - threadEl.clientHeight < 100;
    if (nearBottom) threadEl.scrollTop = threadEl.scrollHeight;
  }
}

// ‚ïê‚ïê‚ïê Social Calendar ‚ïê‚ïê‚ïê
let calDate = new Date();
let calPosts = [];
const platformLabels = { x: 'ùïè', linkedin_company: 'LinkedIn Co.', linkedin_personal: 'LinkedIn Personal' };
const platformIcons = { x: 'ùïè', linkedin_company: 'in', linkedin_personal: 'in' };
const postStatusLabels = { draft: 'Draft', pending_review: 'Pending Review', approved: 'Approved', declined: 'Declined', changes_requested: 'Changes Requested', posted: 'Posted' };

async function loadCalendar() {
  const pf = document.getElementById('cal-platform-filter')?.value || '';
  const sf = document.getElementById('cal-status-filter')?.value || '';
  let url = '/api/posts?';
  if (pf) url += `platform=${pf}&`;
  if (sf) url += `status=${sf}&`;
  calPosts = await api(url);
  renderCalendar();
}

function calNavPrev() { const v = document.getElementById('cal-view')?.value || 'month'; if (v === 'month') calDate.setMonth(calDate.getMonth() - 1); else calDate.setDate(calDate.getDate() - 7); renderCalendar(); }
function calNavNext() { const v = document.getElementById('cal-view')?.value || 'month'; if (v === 'month') calDate.setMonth(calDate.getMonth() + 1); else calDate.setDate(calDate.getDate() + 7); renderCalendar(); }
function calNavToday() { calDate = new Date(); renderCalendar(); }

function renderCalendar() {
  const view = document.getElementById('cal-view')?.value || 'month';
  const today = new Date(); today.setHours(0,0,0,0);
  const y = calDate.getFullYear(), m = calDate.getMonth();
  
  if (view === 'month') {
    document.getElementById('cal-title').textContent = calDate.toLocaleString('en', { month: 'long', year: 'numeric' });
    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const prevDays = new Date(y, m, 0).getDate();
    let cells = '';
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
      const d = prevDays - i;
      const dt = new Date(y, m - 1, d);
      cells += renderCalCell(dt, true);
    }
    // Current month
    for (let d = 1; d <= daysInMonth; d++) {
      const dt = new Date(y, m, d);
      const isToday = dt.toDateString() === today.toDateString();
      cells += renderCalCell(dt, false, isToday);
    }
    // Next month fill
    const totalCells = firstDay + daysInMonth;
    const remaining = (7 - totalCells % 7) % 7;
    for (let d = 1; d <= remaining; d++) {
      const dt = new Date(y, m + 1, d);
      cells += renderCalCell(dt, true);
    }
    document.getElementById('cal-grid').innerHTML = `<div class="cal-grid cal-grid-month">${cells}</div>`;
  } else {
    // Week view
    const startOfWeek = new Date(calDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(endOfWeek.getDate() + 6);
    document.getElementById('cal-title').textContent = `${startOfWeek.toLocaleDateString('en', { month: 'short', day: 'numeric' })} ‚Äî ${endOfWeek.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' })}`;
    let cells = '';
    for (let i = 0; i < 7; i++) {
      const dt = new Date(startOfWeek);
      dt.setDate(dt.getDate() + i);
      const isToday = dt.toDateString() === today.toDateString();
      cells += renderCalCell(dt, false, isToday);
    }
    document.getElementById('cal-grid').innerHTML = `<div class="cal-grid cal-grid-week" style="min-height:400px;">${cells}</div>`;
  }
  renderCalSummary();
}

function renderCalCell(date, otherMonth, isToday) {
  const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
  const dayPosts = calPosts.filter(p => p.scheduled_at && p.scheduled_at.startsWith(dateStr));
  const postsHtml = dayPosts.map(p => {
    const time = p.scheduled_at ? new Date(p.scheduled_at).toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
    let thumbHtml = '';
    try {
      const mediaUrls = JSON.parse(p.media_urls || '[]');
      const driveUrl = mediaUrls.find(u => u && u.includes('drive.google.com'));
      if (driveUrl) {
        const fid = driveUrl.match(/[-\w]{25,}/);
        if (fid) thumbHtml = `<img src="https://drive.google.com/thumbnail?id=${fid[0]}&sz=w100" style="width:100%;max-height:40px;object-fit:cover;border-radius:4px;margin-top:2px;" onerror="this.style.display='none'">`;
      }
    } catch(e) {}
    return `<div class="cal-post platform-${p.platform}" onclick="event.stopPropagation();openPostDetail(${p.id})" title="${p.title}">
      <div class="cal-post-time">${time} ¬∑ ${platformLabels[p.platform] || p.platform}</div>
      <div style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</div>
      <span class="text-xs px-1 rounded post-status-${p.status}" style="font-size:9px;">${postStatusLabels[p.status]}</span>
      ${thumbHtml}
    </div>`;
  }).join('');
  return `<div class="cal-cell ${otherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}">
    <div class="cal-day-num ${isToday ? 'today' : ''}">${date.getDate()}</div>
    ${postsHtml}
  </div>`;
}

function renderCalSummary() {
  const counts = { draft: 0, pending_review: 0, approved: 0, declined: 0, changes_requested: 0, posted: 0 };
  calPosts.forEach(p => { if (counts[p.status] !== undefined) counts[p.status]++; });
  const colors = { draft: '#94a3b8', pending_review: '#eab308', approved: '#22c55e', declined: '#ef4444', changes_requested: '#f97316', posted: '#3b82f6' };
  document.getElementById('cal-summary').innerHTML = Object.entries(counts).map(([s, c]) => `
    <div class="card p-3 text-center cursor-pointer" onclick="document.getElementById('cal-status-filter').value='${s}';loadCalendar();" style="border-top:2px solid ${colors[s]}">
      <div class="text-lg font-bold" style="color:${colors[s]}">${c}</div>
      <div class="text-xs text-[#64748b]">${postStatusLabels[s]}</div>
    </div>`).join('');
}

async function openPostDetail(id) {
  const post = calPosts.find(p => p.id === id) || await api(`/api/posts?`).then(ps => ps.find(p => p.id === id));
  if (!post) return;
  const messages = await api(`/api/posts/${id}/messages`);
  const el = document.getElementById('post-detail-content');
  
  const scheduledStr = post.scheduled_at ? new Date(post.scheduled_at).toLocaleString('en', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Not scheduled';
  const hashtags = (post.hashtags || '').split(/\s+/).filter(h => h.startsWith('#'));
  const contentWithHashtags = (post.content || '').replace(/#(\w+)/g, '<span class="${ post.platform === "x" ? "x-hashtag" : "li-hashtag" }">#$1</span>');
  
  let previewHtml = '';
  if (post.platform === 'x') {
    const text = (post.content || '').replace(/</g,'&lt;').replace(/#(\w+)/g, '<span class="x-hashtag">#$1</span>');
    previewHtml = `<div class="x-preview">
      <div class="flex gap-3">
        <div class="x-avatar">A</div>
        <div class="flex-1">
          <div class="flex items-center gap-2"><span class="x-name">Amtecco</span><span class="x-handle">@amtecco</span></div>
          <div class="x-content">${text}</div>
        </div>
      </div>
    </div>`;
  } else {
    const isCompany = post.platform === 'linkedin_company';
    const text = (post.content || '').replace(/</g,'&lt;').replace(/#(\w+)/g, '<span class="li-hashtag">#$1</span>');
    previewHtml = `<div class="li-preview">
      <div class="flex gap-3 items-start">
        <div class="li-avatar">${isCompany ? 'A' : 'D'}</div>
        <div>
          <div class="li-name">${isCompany ? 'Amtecco' : 'David ¬∑ CEO'}</div>
          <div class="li-headline">${isCompany ? 'Media Technology & CDN Solutions' : 'CEO at Amtecco'}</div>
        </div>
      </div>
      <div class="li-content">${text}</div>
    </div>`;
  }

  const msgsHtml = messages.length ? messages.map(m => {
    const isDavid = m.sender === 'David';
    const isSystem = m.message.startsWith('‚úÖ') || m.message.startsWith('‚ùå') || m.message.startsWith('üîÑ') || m.sender === 'System';
    const cls = isSystem ? 'system' : isDavid ? 'david' : 'max';
    const align = isSystem ? 'justify-center' : isDavid ? 'justify-start' : 'justify-end';
    return `<div class="flex ${align} mb-3"><div>${!isSystem ? `<div class="text-xs text-[#64748b] mb-1 ${isDavid ? '' : 'text-right'}">${m.sender} ¬∑ ${timeAgo(m.created_at)}</div>` : ''}<div class="post-chat-bubble ${cls}">${m.message.replace(/\n/g,'<br>')}</div></div></div>`;
  }).join('') : '<div class="text-xs text-[#64748b] text-center py-3">No messages yet</div>';

  const canApprove = ['pending_review', 'changes_requested'].includes(post.status);
  const canDecline = ['pending_review', 'changes_requested'].includes(post.status);

  el.innerHTML = `
    <div class="flex justify-between items-center px-6 py-4 border-b border-[#2d3148]">
      <div class="flex items-center gap-3">
        <span class="platform-badge platform-badge-${post.platform}">${platformLabels[post.platform]}</span>
        <h3 class="text-lg font-bold">${post.title}</h3>
        <span class="text-xs px-2 py-0.5 rounded post-status-${post.status}">${postStatusLabels[post.status]}</span>
      </div>
      <button onclick="closePostDetail()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
      <div class="p-6 border-r border-[#2d3148]">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Platform Preview</div>
        ${previewHtml}
        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <div><span class="text-[#64748b]">Scheduled:</span><br><span class="font-medium">${scheduledStr}</span></div>
          <div><span class="text-[#64748b]">Author:</span><br><span class="font-medium">${post.author || 'Max'}</span></div>
          <div><span class="text-[#64748b]">Hashtags:</span><br><span class="font-medium">${post.hashtags || '‚Äî'}</span></div>
          <div><span class="text-[#64748b]">Status:</span><br><span class="font-medium">${postStatusLabels[post.status]}</span></div>
        </div>
        ${canApprove || canDecline ? `<div class="flex gap-2 mt-4">
          ${canApprove ? `<button onclick="approvePost(${post.id})" class="btn-primary text-sm flex-1">‚úÖ Approve</button>` : ''}
          ${canDecline ? `<button onclick="declinePost(${post.id})" class="btn-secondary text-sm flex-1" style="border-color:var(--red);color:var(--red);">‚ùå Decline</button>` : ''}
          <button onclick="requestChangesPost(${post.id})" class="btn-secondary text-sm flex-1" style="border-color:#f97316;color:#f97316;">‚úèÔ∏è Request Changes</button>
        </div>` : ''}
        <div class="flex gap-2 mt-2">
          <button onclick="editPostFromDetail(${post.id})" class="btn-ghost text-xs">‚úèÔ∏è Edit</button>
          ${post.status === 'draft' ? `<button onclick="submitForReview(${post.id})" class="btn-secondary text-xs">üì§ Submit for Review</button>` : ''}
        </div>
      </div>
      <div class="p-6 flex flex-col" style="max-height:70vh;">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Conversation</div>
        <div class="flex-1 overflow-y-auto mb-3" id="post-msgs-${post.id}" style="max-height:350px;">${msgsHtml}</div>
        <div class="flex gap-2">
          <textarea class="action-reply-input" id="post-reply-${post.id}" rows="2" placeholder="Type a reply..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendPostReply(${post.id});}"></textarea>
          <button onclick="sendPostReply(${post.id})" class="btn-primary text-xs px-4" style="align-self:flex-end;border-radius:10px;">Send</button>
        </div>
      </div>
    </div>`;
  document.getElementById('post-detail-modal').classList.remove('hidden');
}

function closePostDetail() { document.getElementById('post-detail-modal').classList.add('hidden'); }

async function sendPostReply(postId) {
  const input = document.getElementById(`post-reply-${postId}`);
  if (!input || !input.value.trim()) return;
  const message = input.value.trim();
  input.value = '';
  await api(`/api/posts/${postId}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'David', message }) });
  openPostDetail(postId);
}

async function approvePost(id) {
  await api(`/api/posts/${id}/approve`, { method: 'PATCH', body: JSON.stringify({ sender: 'David' }) });
  loadCalendar();
  openPostDetail(id);
}

async function declinePost(id) {
  const reason = prompt('Reason for declining:');
  if (reason === null) return;
  await api(`/api/posts/${id}/decline`, { method: 'PATCH', body: JSON.stringify({ sender: 'David', reason }) });
  loadCalendar();
  openPostDetail(id);
}

async function requestChangesPost(id) {
  const msg = prompt('What changes are needed?');
  if (!msg) return;
  await api(`/api/posts/${id}`, { method: 'PATCH', body: JSON.stringify({ status: 'changes_requested' }) });
  await api(`/api/posts/${id}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'David', message: '‚úèÔ∏è Changes requested: ' + msg }) });
  loadCalendar();
  openPostDetail(id);
}

async function submitForReview(id) {
  await api(`/api/posts/${id}`, { method: 'PATCH', body: JSON.stringify({ status: 'pending_review' }) });
  await api(`/api/posts/${id}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'Max', message: 'üì§ Submitted for review' }) });
  loadCalendar();
  openPostDetail(id);
}

function openNewPostModal(post) {
  document.getElementById('new-post-modal').classList.remove('hidden');
  document.getElementById('post-modal-title').textContent = post ? 'Edit Post' : 'New Post';
  document.getElementById('post-edit-id').value = post ? post.id : '';
  document.getElementById('post-title').value = post ? post.title : '';
  document.getElementById('post-content').value = post ? post.content : '';
  document.getElementById('post-platform').value = post ? post.platform : 'x';
  document.getElementById('post-status-input').value = post ? post.status : 'draft';
  document.getElementById('post-scheduled').value = post && post.scheduled_at ? post.scheduled_at.replace(' ', 'T').substring(0, 16) : '';
  document.getElementById('post-hashtags').value = post ? post.hashtags : '';
}
function closeNewPostModal() { document.getElementById('new-post-modal').classList.add('hidden'); }

function editPostFromDetail(id) {
  const post = calPosts.find(p => p.id === id);
  if (post) { closePostDetail(); openNewPostModal(post); }
}

async function submitPost(e) {
  e.preventDefault();
  const id = document.getElementById('post-edit-id').value;
  const data = {
    title: document.getElementById('post-title').value,
    content: document.getElementById('post-content').value,
    platform: document.getElementById('post-platform').value,
    status: document.getElementById('post-status-input').value,
    scheduled_at: document.getElementById('post-scheduled').value ? document.getElementById('post-scheduled').value.replace('T', ' ') + ':00' : null,
    hashtags: document.getElementById('post-hashtags').value,
  };
  if (id) await api(`/api/posts/${id}`, { method: 'PATCH', body: JSON.stringify(data) });
  else await api('/api/posts', { method: 'POST', body: JSON.stringify(data) });
  closeNewPostModal();
  loadCalendar();
}

// ‚ïê‚ïê‚ïê Visual Requests ‚ïê‚ïê‚ïê
let vrList = [];
let vrDetailId = null;

const vrStatusLabels = { pending: '‚è≥ Pending', in_progress: 'üîÑ In Progress', changes_requested: '‚úèÔ∏è Changes', done: '‚úÖ Done' };
const vrStatusColors = { pending: '#eab308', in_progress: '#3b82f6', changes_requested: '#f97316', done: '#22c55e' };

async function loadVisualRequests() {
  const status = document.getElementById('vr-status-filter')?.value || '';
  let url = '/api/visual-requests';
  if (status) url += `?status=${status}`;
  vrList = await api(url);
  renderVisualRequests();
}

function renderVisualRequests() {
  // Summary cards
  const counts = { pending: 0, in_progress: 0, changes_requested: 0, done: 0 };
  vrList.forEach(v => { if (counts[v.status] !== undefined) counts[v.status]++; });
  document.getElementById('vr-summary').innerHTML = Object.entries(counts).map(([s, c]) => `
    <div class="card p-3 text-center cursor-pointer" onclick="document.getElementById('vr-status-filter').value='${s}';loadVisualRequests();" style="border-top:2px solid ${vrStatusColors[s]}">
      <div class="text-lg font-bold" style="color:${vrStatusColors[s]}">${c}</div>
      <div class="text-xs text-[#64748b]">${vrStatusLabels[s]}</div>
    </div>`).join('');

  // VR cards
  if (!vrList.length) {
    document.getElementById('vr-list').innerHTML = '<div class="text-center text-[#64748b] py-8">No visual requests found</div>';
    return;
  }
  document.getElementById('vr-list').innerHTML = vrList.map(v => {
    const deadlineStr = v.deadline ? new Date(v.deadline).toLocaleDateString('en', { month: 'short', day: 'numeric' }) : '';
    const msgCount = v.message_count || 0;
    return `<div class="vr-card" onclick="openVRDetail(${v.id})">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold">${v.title}</span>
            <span class="text-xs px-2 py-0.5 rounded vr-status-${v.status}">${vrStatusLabels[v.status]}</span>
          </div>
          <div class="text-xs text-[#64748b]">${v.description ? v.description.substring(0, 120) + (v.description.length > 120 ? '‚Ä¶' : '') : ''}</div>
          <div class="flex gap-4 mt-2 text-xs text-[#94a3b8]">
            <span>üë§ ${v.requesting_agent || 'Unknown'}</span>
            ${deadlineStr ? `<span>üìÖ ${deadlineStr}</span>` : ''}
            ${msgCount ? `<span>üí¨ ${msgCount}</span>` : ''}
            ${v.drive_url ? `<span>üìÅ Drive</span>` : ''}
          </div>
        </div>
        ${v.drive_url ? `<img src="https://drive.google.com/thumbnail?id=${extractDriveId(v.drive_url)}&sz=w80" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-left:12px;" onerror="this.style.display='none'">` : ''}
      </div>
    </div>`;
  }).join('');
}

function extractDriveId(url) {
  if (!url) return '';
  const m = url.match(/[-\w]{25,}/);
  return m ? m[0] : '';
}

async function openVRDetail(id) {
  vrDetailId = id;
  const vr = vrList.find(v => v.id === id) || await api(`/api/visual-requests/${id}`);
  if (!vr) return;
  const messages = await api(`/api/visual-requests/${id}/messages`);
  const el = document.getElementById('vr-detail-content');

  const deadlineStr = vr.deadline ? new Date(vr.deadline).toLocaleDateString('en', { weekday: 'short', month: 'short', day: 'numeric' }) : 'No deadline';

  const msgsHtml = messages.length ? messages.map(m => {
    const isDavid = m.sender === 'David';
    const isSystem = m.sender === 'System' || m.message.startsWith('‚úÖ') || m.message.startsWith('üîÑ');
    const cls = isSystem ? 'system' : isDavid ? 'david' : 'agent';
    const align = isSystem ? 'justify-center' : isDavid ? 'justify-start' : 'justify-end';
    return `<div class="flex ${align} mb-3"><div>${!isSystem ? `<div class="text-xs text-[#64748b] mb-1 ${isDavid ? '' : 'text-right'}">${m.sender} ¬∑ ${timeAgo(m.created_at)}</div>` : ''}<div class="vr-chat-bubble ${cls}">${m.message.replace(/\n/g,'<br>')}</div></div></div>`;
  }).join('') : '<div class="text-xs text-[#64748b] text-center py-3">No messages yet</div>';

  const canProgress = ['pending', 'changes_requested'].includes(vr.status);
  const canDone = ['pending', 'in_progress', 'changes_requested'].includes(vr.status);
  const canChanges = ['in_progress'].includes(vr.status);

  el.innerHTML = `
    <div class="flex justify-between items-center px-6 py-4 border-b border-[#2d3148]">
      <div class="flex items-center gap-3">
        <span class="text-xs px-2 py-0.5 rounded vr-status-${vr.status}">${vrStatusLabels[vr.status]}</span>
        <h3 class="text-lg font-bold">${vr.title}</h3>
      </div>
      <button onclick="closeVRDetail()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
      <div class="p-6 border-r border-[#2d3148]">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Request Details</div>
        <div class="text-sm mb-4">${vr.description || 'No description'}</div>
        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
          <div><span class="text-[#64748b]">Requested by:</span><br><span class="font-medium">${vr.requesting_agent || '‚Äî'}</span></div>
          <div><span class="text-[#64748b]">Deadline:</span><br><span class="font-medium">${deadlineStr}</span></div>
          <div><span class="text-[#64748b]">Department:</span><br><span class="font-medium">${vr.department || '‚Äî'}</span></div>
          <div><span class="text-[#64748b]">Created:</span><br><span class="font-medium">${timeAgo(vr.created_at)}</span></div>
        </div>
        ${vr.reference_specs ? `<div class="text-sm mb-3"><span class="text-[#64748b]">Reference:</span> ${vr.reference_specs}</div>` : ''}
        ${vr.drive_url ? `<div class="text-sm mb-3"><a href="${vr.drive_url}" target="_blank" class="text-blue-400 hover:underline">üìÅ View in Google Drive</a></div>
        <img src="https://drive.google.com/thumbnail?id=${extractDriveId(vr.drive_url)}&sz=w300" style="max-width:100%;border-radius:8px;margin-bottom:12px;" onerror="this.style.display='none'">` : ''}
        ${vr.associated_post_id ? `<div class="text-sm mb-3"><a href="javascript:void(0)" onclick="closeVRDetail();openPostDetail(${vr.associated_post_id})" class="text-blue-400 hover:underline">üìù Linked Post #${vr.associated_post_id}</a></div>` : ''}
        <div class="flex gap-2 mt-4 flex-wrap">
          ${canProgress ? `<button onclick="vrSetStatus(${vr.id},'in_progress')" class="btn-secondary text-xs">üîÑ Start Progress</button>` : ''}
          ${canChanges ? `<button onclick="vrSetStatus(${vr.id},'changes_requested')" class="btn-secondary text-xs" style="border-color:#f97316;color:#f97316;">‚úèÔ∏è Request Changes</button>` : ''}
          ${canDone ? `<button onclick="openVRDoneModal(${vr.id})" class="btn-primary text-xs">‚úÖ Mark Done</button>` : ''}
        </div>
      </div>
      <div class="p-6 flex flex-col" style="max-height:70vh;">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Conversation</div>
        <div class="flex-1 overflow-y-auto mb-3" id="vr-msgs-${vr.id}" style="max-height:350px;">${msgsHtml}</div>
        <div class="flex gap-2">
          <textarea class="action-reply-input" id="vr-reply-${vr.id}" rows="2" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendVRReply(${vr.id});}"></textarea>
          <button onclick="sendVRReply(${vr.id})" class="btn-primary text-xs px-4" style="align-self:flex-end;border-radius:10px;">Send</button>
        </div>
      </div>
    </div>`;
  document.getElementById('vr-detail-modal').classList.remove('hidden');
  // Scroll chat to bottom
  setTimeout(() => { const c = document.getElementById(`vr-msgs-${vr.id}`); if (c) c.scrollTop = c.scrollHeight; }, 50);
}

function closeVRDetail() { document.getElementById('vr-detail-modal').classList.add('hidden'); vrDetailId = null; }

async function sendVRReply(id) {
  const input = document.getElementById(`vr-reply-${id}`);
  if (!input || !input.value.trim()) return;
  const message = input.value.trim();
  input.value = '';
  await api(`/api/visual-requests/${id}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'David', message }) });
  openVRDetail(id);
}

async function vrSetStatus(id, status) {
  await api(`/api/visual-requests/${id}/status`, { method: 'PATCH', body: JSON.stringify({ status, sender: 'David' }) });
  loadVisualRequests();
  openVRDetail(id);
}

async function openNewVRModal() {
  // Populate posts dropdown
  const posts = calPosts.length ? calPosts : await api('/api/posts');
  const sel = document.getElementById('vr-post-id');
  sel.innerHTML = '<option value="">‚Äî None ‚Äî</option>' + posts.map(p => `<option value="${p.id}">${p.title} (${p.platform})</option>`).join('');
  document.getElementById('new-vr-modal').classList.remove('hidden');
}
function closeNewVRModal() { document.getElementById('new-vr-modal').classList.add('hidden'); }

async function submitVR(event) {
  event.preventDefault();
  const data = {
    title: document.getElementById('vr-title').value,
    description: document.getElementById('vr-description').value,
    requesting_agent: document.getElementById('vr-agent').value,
    deadline: document.getElementById('vr-deadline').value || null,
    associated_post_id: document.getElementById('vr-post-id').value ? parseInt(document.getElementById('vr-post-id').value) : null,
    reference_specs: document.getElementById('vr-ref-specs').value || null,
    department: document.getElementById('vr-agent').selectedOptions[0]?.text.match(/\((.+)\)/)?.[1] || '',
    status: 'pending'
  };
  await api('/api/visual-requests', { method: 'POST', body: JSON.stringify(data) });
  closeNewVRModal();
  // Reset form
  document.getElementById('vr-title').value = '';
  document.getElementById('vr-description').value = '';
  document.getElementById('vr-ref-specs').value = '';
  document.getElementById('vr-deadline').value = '';
  loadVisualRequests();
}

function openVRDoneModal(id) {
  document.getElementById('vr-done-id').value = id;
  document.getElementById('vr-done-drive-url').value = '';
  document.getElementById('vr-done-drive-id').value = '';
  document.getElementById('vr-done-modal').classList.remove('hidden');
}
function closeVRDoneModal() { document.getElementById('vr-done-modal').classList.add('hidden'); }

async function submitVRDone() {
  const id = document.getElementById('vr-done-id').value;
  const drive_url = document.getElementById('vr-done-drive-url').value;
  const drive_file_id = document.getElementById('vr-done-drive-id').value || extractDriveId(drive_url);
  await api(`/api/visual-requests/${id}/done`, { method: 'PATCH', body: JSON.stringify({ drive_url, drive_file_id }) });
  closeVRDoneModal();
  loadVisualRequests();
  openVRDetail(parseInt(id));
}

// ‚ïê‚ïê‚ïê Research Requests ‚ïê‚ïê‚ïê
let rrList = [];
let rrDetailId = null;

const rrStatusLabels = { pending: '‚è≥ Pending', in_progress: 'üîÑ In Progress', changes_requested: '‚úèÔ∏è Changes', done: '‚úÖ Done' };
const rrStatusColors = { pending: '#eab308', in_progress: '#3b82f6', changes_requested: '#f97316', done: '#22c55e' };
const rrPriorityIcons = { urgent: 'üî¥', high: 'üü°', normal: '‚ö™' };

async function loadResearchRequests() {
  const status = document.getElementById('rr-status-filter')?.value || '';
  let url = '/api/research-requests';
  if (status) url += `?status=${status}`;
  rrList = await api(url);
  renderResearchRequests();
}

function renderResearchRequests() {
  const counts = { pending: 0, in_progress: 0, changes_requested: 0, done: 0 };
  rrList.forEach(v => { if (counts[v.status] !== undefined) counts[v.status]++; });
  document.getElementById('rr-summary').innerHTML = Object.entries(counts).map(([s, c]) => `
    <div class="card p-3 text-center cursor-pointer" onclick="document.getElementById('rr-status-filter').value='${s}';loadResearchRequests();" style="border-top:2px solid ${rrStatusColors[s]}">
      <div class="text-lg font-bold" style="color:${rrStatusColors[s]}">${c}</div>
      <div class="text-xs text-[#64748b]">${rrStatusLabels[s]}</div>
    </div>`).join('');

  if (!rrList.length) {
    document.getElementById('rr-list').innerHTML = '<div class="text-center text-[#64748b] py-8">No research requests found</div>';
    return;
  }
  document.getElementById('rr-list').innerHTML = rrList.map(v => {
    const deadlineStr = v.deadline ? new Date(v.deadline).toLocaleDateString('en', { month: 'short', day: 'numeric' }) : '';
    const msgCount = v.message_count || 0;
    const prioIcon = rrPriorityIcons[v.priority] || '‚ö™';
    return `<div class="rr-card" onclick="openRRDetail(${v.id})">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold">${v.title}</span>
            <span class="text-xs px-2 py-0.5 rounded rr-status-${v.status}">${rrStatusLabels[v.status]}</span>
            <span class="text-xs px-2 py-0.5 rounded rr-priority-${v.priority}">${prioIcon} ${v.priority}</span>
          </div>
          <div class="text-xs text-[#64748b]">${v.description ? v.description.substring(0, 120) + (v.description.length > 120 ? '‚Ä¶' : '') : ''}</div>
          <div class="flex gap-4 mt-2 text-xs text-[#94a3b8]">
            <span>üë§ ${v.requesting_agent || 'Unknown'}</span>
            ${deadlineStr ? `<span>üìÖ ${deadlineStr}</span>` : ''}
            ${msgCount ? `<span>üí¨ ${msgCount}</span>` : ''}
            ${v.drive_url ? `<span>üìÅ Drive</span>` : ''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

async function openRRDetail(id) {
  rrDetailId = id;
  const rr = rrList.find(v => v.id === id) || await api(`/api/research-requests/${id}`);
  if (!rr) return;
  const messages = await api(`/api/research-requests/${id}/messages`);
  const el = document.getElementById('rr-detail-content');
  const deadlineStr = rr.deadline ? new Date(rr.deadline).toLocaleDateString('en', { weekday: 'short', month: 'short', day: 'numeric' }) : 'No deadline';
  const prioIcon = rrPriorityIcons[rr.priority] || '‚ö™';

  const msgsHtml = messages.length ? messages.map(m => {
    const isDavid = m.sender === 'David';
    const isSystem = m.sender === 'System' || m.message.startsWith('‚úÖ') || m.message.startsWith('üîÑ');
    const cls = isSystem ? 'system' : isDavid ? 'david' : 'agent';
    const align = isSystem ? 'justify-center' : isDavid ? 'justify-start' : 'justify-end';
    return `<div class="flex ${align} mb-3"><div>${!isSystem ? `<div class="text-xs text-[#64748b] mb-1 ${isDavid ? '' : 'text-right'}">${m.sender} ¬∑ ${timeAgo(m.created_at)}</div>` : ''}<div class="rr-chat-bubble ${cls}">${m.message.replace(/\n/g,'<br>')}</div></div></div>`;
  }).join('') : '<div class="text-xs text-[#64748b] text-center py-3">No messages yet</div>';

  const canProgress = ['pending', 'changes_requested'].includes(rr.status);
  const canDone = ['pending', 'in_progress', 'changes_requested'].includes(rr.status);
  const canChanges = ['in_progress'].includes(rr.status);

  el.innerHTML = `
    <div class="flex justify-between items-center px-6 py-4 border-b border-[#2d3148]">
      <div class="flex items-center gap-3">
        <span class="text-xs px-2 py-0.5 rounded rr-status-${rr.status}">${rrStatusLabels[rr.status]}</span>
        <span class="text-xs px-2 py-0.5 rounded rr-priority-${rr.priority}">${prioIcon} ${rr.priority}</span>
        <h3 class="text-lg font-bold">${rr.title}</h3>
      </div>
      <button onclick="closeRRDetail()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
      <div class="p-6 border-r border-[#2d3148]">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Research Details</div>
        <div class="text-sm mb-4">${rr.description || 'No description'}</div>
        ${rr.context ? `<div class="text-sm mb-4 p-3 rounded" style="background:#1E2235;"><span class="text-[#64748b] text-xs uppercase">Context / Background</span><br><span class="text-[#cbd5e1]">${rr.context}</span></div>` : ''}
        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
          <div><span class="text-[#64748b]">Requested by:</span><br><span class="font-medium">${rr.requesting_agent || '‚Äî'}</span></div>
          <div><span class="text-[#64748b]">Deadline:</span><br><span class="font-medium">${deadlineStr}</span></div>
          <div><span class="text-[#64748b]">Department:</span><br><span class="font-medium">${rr.department || '‚Äî'}</span></div>
          <div><span class="text-[#64748b]">Created:</span><br><span class="font-medium">${timeAgo(rr.created_at)}</span></div>
        </div>
        ${rr.drive_url ? `<div class="text-sm mb-3"><a href="${rr.drive_url}" target="_blank" class="text-blue-400 hover:underline">üìÅ View Research in Google Drive</a></div>` : ''}
        <div class="flex gap-2 mt-4 flex-wrap">
          ${canProgress ? `<button onclick="rrSetStatus(${rr.id},'in_progress')" class="btn-secondary text-xs">üîÑ Start Research</button>` : ''}
          ${canChanges ? `<button onclick="rrSetStatus(${rr.id},'changes_requested')" class="btn-secondary text-xs" style="border-color:#f97316;color:#f97316;">‚úèÔ∏è Request Changes</button>` : ''}
          ${canDone ? `<button onclick="openRRDoneModal(${rr.id})" class="btn-primary text-xs">‚úÖ Mark Done</button>` : ''}
        </div>
      </div>
      <div class="p-6 flex flex-col" style="max-height:70vh;">
        <div class="text-xs text-[#94a3b8] mb-2 uppercase tracking-wider font-semibold">Conversation</div>
        <div class="flex-1 overflow-y-auto mb-3" id="rr-msgs-${rr.id}" style="max-height:350px;">${msgsHtml}</div>
        <div class="flex gap-2">
          <textarea class="action-reply-input" id="rr-reply-${rr.id}" rows="2" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendRRReply(${rr.id});}"></textarea>
          <button onclick="sendRRReply(${rr.id})" class="btn-primary text-xs px-4" style="align-self:flex-end;border-radius:10px;">Send</button>
        </div>
      </div>
    </div>`;
  document.getElementById('rr-detail-modal').classList.remove('hidden');
  setTimeout(() => { const c = document.getElementById(`rr-msgs-${rr.id}`); if (c) c.scrollTop = c.scrollHeight; }, 50);
}

function closeRRDetail() { document.getElementById('rr-detail-modal').classList.add('hidden'); rrDetailId = null; }

async function sendRRReply(id) {
  const input = document.getElementById(`rr-reply-${id}`);
  if (!input || !input.value.trim()) return;
  const message = input.value.trim();
  input.value = '';
  await api(`/api/research-requests/${id}/messages`, { method: 'POST', body: JSON.stringify({ sender: 'David', message }) });
  openRRDetail(id);
}

async function rrSetStatus(id, status) {
  await api(`/api/research-requests/${id}/status`, { method: 'PATCH', body: JSON.stringify({ status, sender: 'David' }) });
  loadResearchRequests();
  openRRDetail(id);
}

function openNewRRModal() { document.getElementById('new-rr-modal').classList.remove('hidden'); }
function closeNewRRModal() { document.getElementById('new-rr-modal').classList.add('hidden'); }

async function submitRR(event) {
  event.preventDefault();
  const data = {
    title: document.getElementById('rr-title').value,
    description: document.getElementById('rr-description').value,
    context: document.getElementById('rr-context').value || '',
    requesting_agent: document.getElementById('rr-agent').value,
    priority: document.getElementById('rr-priority').value || 'normal',
    deadline: document.getElementById('rr-deadline').value || null,
    department: document.getElementById('rr-agent').selectedOptions[0]?.text.match(/\((.+)\)/)?.[1] || '',
    status: 'pending'
  };
  await api('/api/research-requests', { method: 'POST', body: JSON.stringify(data) });
  closeNewRRModal();
  document.getElementById('rr-title').value = '';
  document.getElementById('rr-description').value = '';
  document.getElementById('rr-context').value = '';
  document.getElementById('rr-deadline').value = '';
  loadResearchRequests();
}

function openRRDoneModal(id) {
  document.getElementById('rr-done-id').value = id;
  document.getElementById('rr-done-drive-url').value = '';
  document.getElementById('rr-done-drive-id').value = '';
  document.getElementById('rr-done-modal').classList.remove('hidden');
}
function closeRRDoneModal() { document.getElementById('rr-done-modal').classList.add('hidden'); }

async function submitRRDone() {
  const id = document.getElementById('rr-done-id').value;
  const drive_url = document.getElementById('rr-done-drive-url').value;
  const drive_file_id = document.getElementById('rr-done-drive-id').value || extractDriveId(drive_url);
  await api(`/api/research-requests/${id}/done`, { method: 'PATCH', body: JSON.stringify({ drive_url, drive_file_id }) });
  closeRRDoneModal();
  loadResearchRequests();
  openRRDetail(parseInt(id));
}

// ‚ïê‚ïê‚ïê Vendors ‚ïê‚ïê‚ïê
let VENDORS = [];
let VENDOR_SORT = { column: null, direction: 'asc' };

async function loadVendors() {
  try {
    // Get summary data
    const summaryData = await api('/api/vendors/summary');
    
    // Update summary cards
    const totalMonthlySpend = summaryData.total_monthly_spend || 0;
    document.getElementById('vendor-total-monthly-spend').textContent = `$${totalMonthlySpend.toLocaleString()}`;
    
    const activeAccounts = summaryData.count_by_status?.active || 0;
    document.getElementById('vendor-active-accounts').textContent = activeAccounts;
    
    const pendingApproval = summaryData.count_by_status?.[`pending-approval`] || 0;
    document.getElementById('vendor-pending-approval').textContent = pendingApproval;
    
    // Format top 3 departments
    const departmentCounts = summaryData.count_by_department || {};
    const sortedDepartments = Object.entries(departmentCounts)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 3);
    
    const departmentDisplay = sortedDepartments.length > 0 
      ? sortedDepartments.map(([dept, count]) => `${dept}: ${count}`).join('<br>')
      : 'No data';
    
    document.getElementById('vendor-by-department').innerHTML = departmentDisplay;

    // Load departments for dropdown (only once)
    if (!window.departmentsLoaded) {
      await loadDepartments();
      window.departmentsLoaded = true;
    }

    // Build query parameters from filters
    const statusFilter = document.getElementById('vendor-status-filter')?.value || '';
    const categoryFilter = document.getElementById('vendor-category-filter')?.value || '';
    const departmentFilter = document.getElementById('vendor-department-filter')?.value || '';
    const searchFilter = document.getElementById('vendor-search-input')?.value || '';
    
    let url = '/api/vendors';
    const params = [];
    if (statusFilter) params.push(`status=${statusFilter}`);
    if (categoryFilter) params.push(`category=${categoryFilter}`);
    if (departmentFilter) params.push(`department=${departmentFilter}`);
    if (searchFilter) params.push(`search=${encodeURIComponent(searchFilter)}`);
    if (params.length) url += '?' + params.join('&');

    // Get filtered vendors
    VENDORS = await api(url);
    renderVendorsTable();
    
    // Update cost breakdown chart after vendors are loaded
    renderCostBreakdownChart(summaryData);
    
    // Update sync time
    document.getElementById('vendor-sync-time').textContent = `Updated ${new Date().toLocaleTimeString()}`;
  } catch (e) {
    console.error('Failed to load vendors:', e);
    document.getElementById('vendors-table-body').innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-red-400">Error loading vendors</td></tr>';
  }
}

async function loadDepartments() {
  try {
    const departments = await api('/api/vendors/departments');
    const departmentFilter = document.getElementById('vendor-department-filter');
    
    // Clear existing options except "All Departments"
    departmentFilter.innerHTML = '<option value="">All Departments</option>';
    
    // Add departments from API
    departments.forEach(dept => {
      const option = document.createElement('option');
      option.value = dept;
      option.textContent = dept;
      departmentFilter.appendChild(option);
    });
  } catch (e) {
    console.error('Failed to load departments:', e);
  }
}

function updateFiltersAndLoad() {
  // Update URL parameters
  const statusFilter = document.getElementById('vendor-status-filter')?.value || '';
  const categoryFilter = document.getElementById('vendor-category-filter')?.value || '';
  const departmentFilter = document.getElementById('vendor-department-filter')?.value || '';
  const searchFilter = document.getElementById('vendor-search-input')?.value || '';
  
  const params = new URLSearchParams();
  if (statusFilter) params.set('status', statusFilter);
  if (categoryFilter) params.set('category', categoryFilter);
  if (departmentFilter) params.set('department', departmentFilter);
  if (searchFilter) params.set('search', searchFilter);
  
  const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
  window.history.replaceState({}, '', newUrl);
  
  // Load vendors with new filters
  loadVendors();
}

function loadFiltersFromURL() {
  const params = new URLSearchParams(window.location.search);
  
  // Set filter values from URL parameters
  const statusFilter = document.getElementById('vendor-status-filter');
  const categoryFilter = document.getElementById('vendor-category-filter');
  const departmentFilter = document.getElementById('vendor-department-filter');
  const searchInput = document.getElementById('vendor-search-input');
  
  if (statusFilter && params.get('status')) statusFilter.value = params.get('status');
  if (categoryFilter && params.get('category')) categoryFilter.value = params.get('category');
  if (departmentFilter && params.get('department')) departmentFilter.value = params.get('department');
  if (searchInput && params.get('search')) searchInput.value = params.get('search');
}

// Global variable to store chart instance
let costBreakdownChartInstance = null;

async function renderCostBreakdownChart(summaryData) {
  try {
    const canvas = document.getElementById('cost-breakdown-chart');
    if (!canvas) return;

    // Destroy existing chart if it exists
    if (costBreakdownChartInstance) {
      costBreakdownChartInstance.destroy();
      costBreakdownChartInstance = null;
    }

    // Get ALL active vendors for cost breakdown (not filtered ones)
    const allActiveVendors = await api('/api/vendors?status=active');
    
    // Get department spend data - calculate from active vendors only
    const departmentSpend = {};
    
    // Calculate spend by department for active vendors only
    if (allActiveVendors) {
      allActiveVendors
        .forEach(vendor => {
          const dept = vendor.department || 'Unassigned';
          const monthlyCost = parseFloat(vendor.cost_monthly) || 0;
          if (monthlyCost > 0) { // Exclude $0 spend
            departmentSpend[dept] = (departmentSpend[dept] || 0) + monthlyCost;
          }
        });
    }

    // Convert to chart data
    const chartLabels = Object.keys(departmentSpend);
    const chartData = Object.values(departmentSpend);

    // If no data, show empty chart message
    if (chartLabels.length === 0) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = '14px Inter';
      ctx.fillStyle = '#64748b';
      ctx.textAlign = 'center';
      ctx.fillText('No active vendor spending data', canvas.width / 2, canvas.height / 2);
      return;
    }

    // Department colors mapping
    const departmentColors = {
      'Engineering': '#60a5fa',
      'Marketing': '#06b6d4', 
      'Sales': '#4ade80',
      'Operations': '#94a3b8',
      'Research': '#c084fc',
      'Design': '#f472b6',
      'Unassigned': '#64748b'
    };

    // Generate colors for all departments
    const backgroundColors = chartLabels.map(dept => 
      departmentColors[dept] || departmentColors['Unassigned']
    );

    const ctx = canvas.getContext('2d');
    
    costBreakdownChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color + '80'), // Add transparency for border
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#e2e8f0',
              font: {
                family: 'Inter',
                size: 11
              },
              generateLabels: function(chart) {
                const data = chart.data;
                if (data.labels.length && data.datasets.length) {
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const formatted = `$${value.toFixed(0)}`;
                    return {
                      text: `${label}: ${formatted}`,
                      fillStyle: backgroundColors[i],
                      strokeStyle: backgroundColors[i],
                      lineWidth: 0,
                      index: i
                    };
                  });
                }
                return [];
              }
            }
          },
          tooltip: {
            backgroundColor: '#1a1d2e',
            titleColor: '#e2e8f0',
            bodyColor: '#e2e8f0',
            borderColor: '#2d3148',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: $${value.toFixed(0)} (${percentage}%)`;
              }
            }
          }
        },
        layout: {
          padding: 10
        }
      }
    });

  } catch (error) {
    console.error('Error rendering cost breakdown chart:', error);
    
    // Fallback: show error message on canvas
    const canvas = document.getElementById('cost-breakdown-chart');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = '12px Inter';
      ctx.fillStyle = '#ef4444';
      ctx.textAlign = 'center';
      ctx.fillText('Error loading chart', canvas.width / 2, canvas.height / 2);
    }
  }
}

function renderVendorsTable() {
  const tbody = document.getElementById('vendors-table-body');
  
  if (!VENDORS || VENDORS.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-[#64748b]">No vendors found</td></tr>';
    return;
  }
  
  tbody.innerHTML = VENDORS.map(vendor => {
    const categoryLabels = {
      'lead-gen': 'Lead Gen',
      'design': 'Design',
      'infrastructure': 'Infrastructure',
      'analytics': 'Analytics',
      'social': 'Social',
      'communication': 'Comms',
      'other': 'Other'
    };
    
    // Get status badge class
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'active': return 'vendor-status-badge vendor-status-active';
        case 'trial': return 'vendor-status-badge vendor-status-trial';
        case 'pending-approval': return 'vendor-status-badge vendor-status-pending-approval';
        case 'suspended': return 'vendor-status-badge vendor-status-suspended';
        case 'cancelled': return 'vendor-status-badge vendor-status-cancelled';
        default: return 'vendor-status-badge vendor-status-cancelled';
      }
    }
    
    // Get department badge class
    function getDepartmentBadgeClass(department) {
      if (!department) return 'dept-badge dept-default';
      const dept = department.toLowerCase();
      if (dept.includes('engineering')) return 'dept-badge dept-engineering';
      if (dept.includes('marketing')) return 'dept-badge dept-marketing';
      if (dept.includes('sales')) return 'dept-badge dept-sales';
      if (dept.includes('operations')) return 'dept-badge dept-operations';
      if (dept.includes('research')) return 'dept-badge dept-research';
      if (dept.includes('design')) return 'dept-badge dept-design';
      return 'dept-badge dept-default';
    }
    
    // Format cost as currency ($X.XX)
    const monthlyCost = vendor.cost_monthly ? 
      `$${parseFloat(vendor.cost_monthly).toFixed(2)}` : '-';
    
    return `
      <tr class="cursor-pointer hover:bg-[#252a40]" onclick="openVendorDetail(${vendor.id})">
        <td class="px-5 py-3">
          <div class="font-medium text-[#e2e8f0]">${vendor.name}</div>
        </td>
        <td class="px-3 py-3">
          <span class="text-xs px-2 py-1 rounded" style="background: rgba(59,130,246,0.2); color: #60a5fa;">
            ${categoryLabels[vendor.category] || vendor.category}
          </span>
        </td>
        <td class="px-3 py-3 text-[#94a3b8]">${vendor.plan || '-'}</td>
        <td class="px-3 py-3 text-[#94a3b8]">${monthlyCost}</td>
        <td class="px-3 py-3 text-[#94a3b8]">${vendor.owner || '-'}</td>
        <td class="px-3 py-3">
          <span class="${getDepartmentBadgeClass(vendor.department)}">${vendor.department || 'Unassigned'}</span>
        </td>
        <td class="px-3 py-3">
          <span class="${getStatusBadgeClass(vendor.status)}">${vendor.status?.replace('-', ' ') || 'unknown'}</span>
        </td>
      </tr>`;
  }).join('');
}

function sortVendorsTable(column) {
  // Toggle direction if clicking same column, otherwise set to ascending
  if (VENDOR_SORT.column === column) {
    VENDOR_SORT.direction = VENDOR_SORT.direction === 'asc' ? 'desc' : 'asc';
  } else {
    VENDOR_SORT.column = column;
    VENDOR_SORT.direction = 'asc';
  }
  
  // Clear all sort indicators
  document.querySelectorAll('[id^="sort-"]').forEach(el => {
    el.textContent = '‚Üï';
    el.className = 'ml-1 text-[#64748b]';
  });
  
  // Set current sort indicator
  const sortEl = document.getElementById(`sort-${column}`);
  if (sortEl) {
    sortEl.textContent = VENDOR_SORT.direction === 'asc' ? '‚Üë' : '‚Üì';
    sortEl.className = 'ml-1 text-[#3b82f6]';
  }
  
  // Sort the vendors array
  VENDORS.sort((a, b) => {
    let aVal = a[column] || '';
    let bVal = b[column] || '';
    
    // Special handling for numeric columns
    if (column === 'cost_monthly') {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
    } else {
      // String comparison (case insensitive)
      aVal = aVal.toString().toLowerCase();
      bVal = bVal.toString().toLowerCase();
    }
    
    if (VENDOR_SORT.direction === 'asc') {
      return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
    } else {
      return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
    }
  });
  
  // Re-render the table
  renderVendorsTable();
}

function openVendorDetail(id) {
  const vendor = VENDORS.find(v => v.id === id);
  if (!vendor) return;
  
  openVendorPanel(vendor);
}

function openVendorPanel(vendor) {
  document.getElementById('vendor-panel-content').innerHTML = `
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span style="font-size:20px;font-weight:700">${vendor.name}</span>
      </div>
      <div style="color:var(--text-secondary);font-size:14px">${vendor.category?.replace('-', ' ') || 'No category'}</div>
    </div>
    
    <form id="vendor-edit-form" onsubmit="saveVendor(${vendor.id}, event)">
      <div class="mb-4">
        <label class="form-label">Vendor Name *</label>
        <input type="text" id="vendor-edit-name" class="form-input" value="${vendor.name || ''}" required>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Category *</label>
        <select id="vendor-edit-category" class="form-select" required>
          <option value="">Select Category</option>
          <option value="lead-gen" ${vendor.category === 'lead-gen' ? 'selected' : ''}>Lead Gen</option>
          <option value="design" ${vendor.category === 'design' ? 'selected' : ''}>Design</option>
          <option value="infrastructure" ${vendor.category === 'infrastructure' ? 'selected' : ''}>Infrastructure</option>
          <option value="analytics" ${vendor.category === 'analytics' ? 'selected' : ''}>Analytics</option>
          <option value="social" ${vendor.category === 'social' ? 'selected' : ''}>Social</option>
          <option value="communication" ${vendor.category === 'communication' ? 'selected' : ''}>Communication</option>
          <option value="other" ${vendor.category === 'other' ? 'selected' : ''}>Other</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Website URL</label>
        <input type="url" id="vendor-edit-url" class="form-input" value="${vendor.url || ''}" placeholder="https://...">
      </div>
      
      <div class="mb-4">
        <label class="form-label">Plan</label>
        <input type="text" id="vendor-edit-plan" class="form-input" value="${vendor.plan || ''}" placeholder="Pro, Enterprise, etc.">
      </div>
      
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="form-label">Monthly Cost</label>
          <input type="number" step="0.01" id="vendor-edit-cost-monthly" class="form-input" value="${vendor.cost_monthly || ''}" placeholder="0.00">
        </div>
        <div>
          <label class="form-label">Annual Cost</label>
          <input type="number" step="0.01" id="vendor-edit-cost-annual" class="form-input" value="${vendor.cost_annual || ''}" placeholder="0.00">
        </div>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Billing Cycle</label>
        <select id="vendor-edit-billing-cycle" class="form-select">
          <option value="monthly" ${vendor.billing_cycle === 'monthly' ? 'selected' : ''}>Monthly</option>
          <option value="annual" ${vendor.billing_cycle === 'annual' ? 'selected' : ''}>Annual</option>
          <option value="one-time" ${vendor.billing_cycle === 'one-time' ? 'selected' : ''}>One-time</option>
          <option value="free" ${vendor.billing_cycle === 'free' ? 'selected' : ''}>Free</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Owner</label>
        <input type="text" id="vendor-edit-owner" class="form-input" value="${vendor.owner || ''}" placeholder="Account owner/manager">
      </div>
      
      <div class="mb-4">
        <label class="form-label">Department</label>
        <input type="text" id="vendor-edit-department" class="form-input" value="${vendor.department || ''}" placeholder="Engineering, Sales, etc.">
      </div>
      
      <div class="mb-4">
        <label class="form-label">Login Email</label>
        <input type="email" id="vendor-edit-login-email" class="form-input" value="${vendor.login_email || ''}" placeholder="login@company.com">
      </div>
      
      <div class="mb-4">
        <label class="form-label">Status</label>
        <select id="vendor-edit-status" class="form-select">
          <option value="active" ${vendor.status === 'active' ? 'selected' : ''}>Active</option>
          <option value="trial" ${vendor.status === 'trial' ? 'selected' : ''}>Trial</option>
          <option value="pending-approval" ${vendor.status === 'pending-approval' ? 'selected' : ''}>Pending Approval</option>
          <option value="suspended" ${vendor.status === 'suspended' ? 'selected' : ''}>Suspended</option>
          <option value="cancelled" ${vendor.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
        </select>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Users (JSON Array)</label>
        <textarea id="vendor-edit-users" class="form-textarea" rows="3" placeholder='["user1@company.com", "user2@company.com"]'>${JSON.stringify(vendor.users) || '[]'}</textarea>
        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Enter as JSON array, e.g., ["user1@company.com", "user2@company.com"]</div>
      </div>
      
      <div class="mb-4">
        <label class="form-label">Renewal Date</label>
        <input type="date" id="vendor-edit-renewal-date" class="form-input" value="${vendor.renewal_date || ''}">
      </div>
      
      <div class="mb-6">
        <label class="form-label">Notes</label>
        <textarea id="vendor-edit-notes" class="form-textarea" rows="3" placeholder="Additional notes...">${vendor.notes || ''}</textarea>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center">
        <button type="button" onclick="deleteVendor(${vendor.id})" class="btn-delete">üóëÔ∏è Delete</button>
        <div>
          <button type="submit" class="btn-save">üíæ Save Changes</button>
        </div>
      </div>
      
      <div id="vendor-edit-error" style="margin-top:12px;padding:8px;background:#1a1111;border:1px solid #ef4444;border-radius:8px;color:#ef4444;font-size:12px;display:none;"></div>
    </form>
  `;
  
  document.getElementById('vendor-panel').classList.add('open');
}

function closeVendorPanel() {
  document.getElementById('vendor-panel').classList.remove('open');
}

async function saveVendor(id, event) {
  event.preventDefault();
  
  const errorDiv = document.getElementById('vendor-edit-error');
  errorDiv.style.display = 'none';
  
  try {
    const name = document.getElementById('vendor-edit-name').value.trim();
    const category = document.getElementById('vendor-edit-category').value;
    
    // Validate required fields
    if (!name) {
      throw new Error('Vendor name is required');
    }
    if (!category) {
      throw new Error('Category is required');
    }
    
    // Parse users JSON
    let users = [];
    const usersText = document.getElementById('vendor-edit-users').value.trim();
    if (usersText) {
      try {
        users = JSON.parse(usersText);
        if (!Array.isArray(users)) {
          throw new Error('Users must be an array');
        }
      } catch (e) {
        throw new Error('Users field must be valid JSON array');
      }
    }
    
    // Build update data
    const vendorData = {
      name,
      category,
      url: document.getElementById('vendor-edit-url').value.trim() || null,
      plan: document.getElementById('vendor-edit-plan').value.trim() || null,
      cost_monthly: document.getElementById('vendor-edit-cost-monthly').value || null,
      cost_annual: document.getElementById('vendor-edit-cost-annual').value || null,
      billing_cycle: document.getElementById('vendor-edit-billing-cycle').value,
      owner: document.getElementById('vendor-edit-owner').value.trim() || null,
      department: document.getElementById('vendor-edit-department').value.trim() || null,
      login_email: document.getElementById('vendor-edit-login-email').value.trim() || null,
      status: document.getElementById('vendor-edit-status').value,
      users,
      renewal_date: document.getElementById('vendor-edit-renewal-date').value || null,
      notes: document.getElementById('vendor-edit-notes').value.trim() || null
    };
    
    // PATCH to API endpoint
    const response = await fetch(`/api/vendors/${id}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(vendorData)
    });
    
    if (!response.ok) {
      const error = await response.text();
      throw new Error(error || 'Failed to update vendor');
    }
    
    // Success - close panel and refresh table
    closeVendorPanel();
    await loadVendors();
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';
  }
}

async function deleteVendor(id) {
  if (!confirm('Are you sure you want to delete this vendor? This will set its status to cancelled.')) {
    return;
  }
  
  const errorDiv = document.getElementById('vendor-edit-error');
  errorDiv.style.display = 'none';
  
  try {
    const response = await fetch(`/api/vendors/${id}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      const error = await response.text();
      throw new Error(error || 'Failed to delete vendor');
    }
    
    // Success - close panel and refresh table
    closeVendorPanel();
    await loadVendors();
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';
  }
}

function openVendorModal(id) {
  const modal = document.getElementById('add-vendor-modal');
  modal.classList.remove('hidden');
  
  // Clear form fields
  document.getElementById('add-vendor-name').value = '';
  document.getElementById('add-vendor-category').value = '';
  document.getElementById('add-vendor-url').value = '';
  document.getElementById('add-vendor-plan').value = '';
  document.getElementById('add-vendor-cost-monthly').value = '';
  document.getElementById('add-vendor-cost-annual').value = '';
  document.getElementById('add-vendor-billing-cycle').value = 'monthly';
  document.getElementById('add-vendor-owner').value = '';
  document.getElementById('add-vendor-department').value = '';
  document.getElementById('add-vendor-login-email').value = '';
  document.getElementById('add-vendor-status').value = 'active';
  document.getElementById('add-vendor-users').value = '';
  document.getElementById('add-vendor-renewal-date').value = '';
  document.getElementById('add-vendor-notes').value = '';
  
  // Clear error message
  document.getElementById('add-vendor-error').classList.add('hidden');
}

function closeAddVendorModal() {
  document.getElementById('add-vendor-modal').classList.add('hidden');
}

async function submitAddVendor(event) {
  event.preventDefault();
  
  const name = document.getElementById('add-vendor-name').value.trim();
  const category = document.getElementById('add-vendor-category').value;
  const url = document.getElementById('add-vendor-url').value.trim();
  const plan = document.getElementById('add-vendor-plan').value.trim();
  const costMonthly = document.getElementById('add-vendor-cost-monthly').value;
  const costAnnual = document.getElementById('add-vendor-cost-annual').value;
  const billingCycle = document.getElementById('add-vendor-billing-cycle').value;
  const owner = document.getElementById('add-vendor-owner').value.trim();
  const department = document.getElementById('add-vendor-department').value.trim();
  const loginEmail = document.getElementById('add-vendor-login-email').value.trim();
  const status = document.getElementById('add-vendor-status').value;
  const usersInput = document.getElementById('add-vendor-users').value.trim();
  const renewalDate = document.getElementById('add-vendor-renewal-date').value;
  const notes = document.getElementById('add-vendor-notes').value.trim();
  
  const errorEl = document.getElementById('add-vendor-error');
  
  // Validate required fields
  if (!name) {
    errorEl.textContent = 'Vendor name is required.';
    errorEl.classList.remove('hidden');
    return;
  }
  
  if (!category) {
    errorEl.textContent = 'Category is required.';
    errorEl.classList.remove('hidden');
    return;
  }
  
  // Validate users JSON format
  let users = [];
  if (usersInput) {
    try {
      users = JSON.parse(usersInput);
      if (!Array.isArray(users)) {
        throw new Error('Users must be an array');
      }
    } catch (e) {
      errorEl.textContent = 'Users field must be valid JSON array format: ["Name1", "Name2"]';
      errorEl.classList.remove('hidden');
      return;
    }
  }
  
  // Clear error
  errorEl.classList.add('hidden');
  
  try {
    const vendorData = {
      name,
      category,
      url,
      plan,
      cost_monthly: costMonthly ? parseFloat(costMonthly) : 0,
      cost_annual: costAnnual ? parseFloat(costAnnual) : null,
      billing_cycle: billingCycle,
      owner,
      department,
      status,
      login_email: loginEmail,
      notes,
      renewal_date: renewalDate || null,
      users,
      actor: 'user' // For activity logging
    };
    
    const response = await fetch('/api/vendors', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(vendorData)
    });
    
    if (!response.ok) {
      const error = await response.json();
      errorEl.textContent = error.error || 'Failed to create vendor';
      errorEl.classList.remove('hidden');
      return;
    }
    
    // Success - close modal and refresh table
    closeAddVendorModal();
    await loadVendors(); // Refresh the vendors table
    
  } catch (error) {
    console.error('Error creating vendor:', error);
    errorEl.textContent = 'Failed to create vendor. Please try again.';
    errorEl.classList.remove('hidden');
  }
}

async function syncVendors() {
  try {
    document.getElementById('vendor-sync-time').textContent = 'Syncing...';
    await api('/api/sync/vendors', { method: 'POST' });
    loadVendors();
  } catch (e) {
    console.error('Sync failed:', e);
    document.getElementById('vendor-sync-time').textContent = 'Sync failed';
  }
}

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
loadAll().then(() => { 
  setTimeout(checkHashNavigation, 500); 
  loadCalendar(); 
  initializeFromURL(); // Initialize from URL to show correct page on load
});
setInterval(incrementalRefresh, 30000);
</script>

<!-- Add Vendor Modal -->
<div id="add-vendor-modal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
  <div class="modal-content p-6" style="max-width:600px;">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold">Add New Vendor</h3>
      <button onclick="closeAddVendorModal()" class="text-[#94a3b8] hover:text-white text-xl">&times;</button>
    </div>
    <form onsubmit="submitAddVendor(event)">
      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <label class="form-label">Vendor Name <span class="text-red-400">*</span></label>
          <input type="text" id="add-vendor-name" class="form-input" placeholder="e.g., Figma, Slack, Google Workspace" required>
        </div>
        <div>
          <label class="form-label">Category <span class="text-red-400">*</span></label>
          <select id="add-vendor-category" class="form-input" required>
            <option value="">Select Category</option>
            <option value="lead-gen">Lead Generation</option>
            <option value="design">Design</option>
            <option value="infrastructure">Infrastructure</option>
            <option value="analytics">Analytics</option>
            <option value="social">Social</option>
            <option value="communication">Communication</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <label class="form-label">Website URL</label>
          <input type="url" id="add-vendor-url" class="form-input" placeholder="https://example.com">
        </div>
        <div>
          <label class="form-label">Plan/Tier</label>
          <input type="text" id="add-vendor-plan" class="form-input" placeholder="e.g., Professional, Free, Enterprise">
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4 mb-3">
        <div>
          <label class="form-label">Monthly Cost ($)</label>
          <input type="number" id="add-vendor-cost-monthly" class="form-input" placeholder="0" min="0" step="0.01">
        </div>
        <div>
          <label class="form-label">Annual Cost ($)</label>
          <input type="number" id="add-vendor-cost-annual" class="form-input" placeholder="Optional" min="0" step="0.01">
        </div>
        <div>
          <label class="form-label">Billing Cycle</label>
          <select id="add-vendor-billing-cycle" class="form-input">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
            <option value="one-time">One-time</option>
            <option value="free">Free</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <label class="form-label">Owner</label>
          <input type="text" id="add-vendor-owner" class="form-input" placeholder="Person responsible">
        </div>
        <div>
          <label class="form-label">Department</label>
          <input type="text" id="add-vendor-department" class="form-input" placeholder="e.g., Engineering, Marketing">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <label class="form-label">Login Email</label>
          <input type="email" id="add-vendor-login-email" class="form-input" placeholder="Account email">
        </div>
        <div>
          <label class="form-label">Status</label>
          <select id="add-vendor-status" class="form-input">
            <option value="active">Active</option>
            <option value="trial">Trial</option>
            <option value="pending-approval">Pending Approval</option>
            <option value="suspended">Suspended</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Users <span class="text-xs text-[#64748b]">(JSON array format)</span></label>
        <input type="text" id="add-vendor-users" class="form-input" placeholder='["John Doe", "Jane Smith"]'>
        <div class="text-xs text-[#64748b] mt-1">Enter as JSON array: ["Name1", "Name2"] or leave empty for []</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Renewal Date</label>
        <input type="date" id="add-vendor-renewal-date" class="form-input">
      </div>

      <div class="mb-4">
        <label class="form-label">Notes</label>
        <textarea id="add-vendor-notes" class="form-input h-20" placeholder="Additional details about this vendor..."></textarea>
      </div>

      <div id="add-vendor-error" class="text-sm text-red-400 mb-3 hidden"></div>
      
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeAddVendorModal()" class="btn-secondary">Cancel</button>
        <button type="submit" class="btn-primary">Add Vendor</button>
      </div>
    </form>
  </div>
</div>

</body>
</html>